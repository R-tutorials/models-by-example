<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Expectation-Maximization | Model Estimation by Example</title>
  <meta name="description" content="This document provides ‘by-hand’ demonstrations of various models and algorithms. The goal is to take away some of the mystery by providing clean code examples that are easy to run and compare with other tools." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Expectation-Maximization | Model Estimation by Example" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://m-clark.github.io/models-by-example/" />
  <meta property="og:image" content="https://m-clark.github.io/models-by-example/img/nineteeneightyR.png" />
  <meta property="og:description" content="This document provides ‘by-hand’ demonstrations of various models and algorithms. The goal is to take away some of the mystery by providing clean code examples that are easy to run and compare with other tools." />
  <meta name="github-repo" content="m-clark/models-by-example/" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Expectation-Maximization | Model Estimation by Example" />
  
  <meta name="twitter:description" content="This document provides ‘by-hand’ demonstrations of various models and algorithms. The goal is to take away some of the mystery by providing clean code examples that are easy to run and compare with other tools." />
  <meta name="twitter:image" content="https://m-clark.github.io/models-by-example/img/nineteeneightyR.png" />



<meta name="date" content="2020-11-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/R.ico" type="image/x-icon" />
<link rel="prev" href="stochastic-gradient-descent.html"/>
<link rel="next" href="supplemental.html"/>
<script src="libs/header-attrs-2.5/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/book.css" type="text/css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class='before'><a href="./">Model Estimation by Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>Models</b></span></li>
<li class="chapter" data-level="" data-path="linear-regression.html"><a href="linear-regression.html"><i class="fa fa-check"></i>Linear Regression</a>
<ul>
<li class="chapter" data-level="" data-path="linear-regression.html"><a href="linear-regression.html#data-setup"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="linear-regression.html"><a href="linear-regression.html#functions"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="linear-regression.html"><a href="linear-regression.html#estimation"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="linear-regression.html"><a href="linear-regression.html#comparison"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="linear-regression.html"><a href="linear-regression.html#source"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="logistic-regression.html"><a href="logistic-regression.html"><i class="fa fa-check"></i>Logistic Regression</a>
<ul>
<li class="chapter" data-level="" data-path="logistic-regression.html"><a href="logistic-regression.html#data-setup-1"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="logistic-regression.html"><a href="logistic-regression.html#functions-1"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="logistic-regression.html"><a href="logistic-regression.html#estimation-1"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="logistic-regression.html"><a href="logistic-regression.html#comparison-1"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="logistic-regression.html"><a href="logistic-regression.html#source-1"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-one-factor.html"><a href="mixed-model-one-factor.html"><i class="fa fa-check"></i>One-factor Mixed Model</a>
<ul>
<li class="chapter" data-level="" data-path="mixed-model-one-factor.html"><a href="mixed-model-one-factor.html#data-setup-2"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="mixed-model-one-factor.html"><a href="mixed-model-one-factor.html#function"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="mixed-model-one-factor.html"><a href="mixed-model-one-factor.html#estimation-2"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="mixed-model-one-factor.html"><a href="mixed-model-one-factor.html#comparison-2"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="mixed-model-one-factor.html"><a href="mixed-model-one-factor.html#source-2"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-two-factor.html"><a href="mixed-model-two-factor.html"><i class="fa fa-check"></i>Two-factor Mixed Model</a>
<ul>
<li class="chapter" data-level="" data-path="mixed-model-two-factor.html"><a href="mixed-model-two-factor.html#data-setup-3"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="mixed-model-two-factor.html"><a href="mixed-model-two-factor.html#function-1"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="mixed-model-two-factor.html"><a href="mixed-model-two-factor.html#estimation-3"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="mixed-model-two-factor.html"><a href="mixed-model-two-factor.html#comparison-3"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="mixed-model-two-factor.html"><a href="mixed-model-two-factor.html#source-3"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html"><i class="fa fa-check"></i>Mixed Model via ML</a>
<ul>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#introduction-1"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#maximum-likelihood-estimation"><i class="fa fa-check"></i>Maximum Likelihood Estimation</a>
<ul>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#data-setup-4"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#function-2"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#results"><i class="fa fa-check"></i>Results</a></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#issues-with-ml-estimation"><i class="fa fa-check"></i>Issues with ML estimation</a></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#link-with-penalized-regression"><i class="fa fa-check"></i>Link with penalized regression</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mixed-model-ML.html"><a href="mixed-model-ML.html#source-4"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html"><i class="fa fa-check"></i>Probit &amp; Bivariate Probit</a>
<ul>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html#standard-probit"><i class="fa fa-check"></i>Standard Probit</a>
<ul>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html#function-3"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html#examples"><i class="fa fa-check"></i>Examples</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html#bivariate-probit"><i class="fa fa-check"></i>Bivariate Probit</a>
<ul>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html#example"><i class="fa fa-check"></i>Example</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="probit.html"><a href="probit.html#source-5"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html"><i class="fa fa-check"></i>Heckman Selection</a>
<ul>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#data-setup-5"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#two-step-approach"><i class="fa fa-check"></i>Two step approach</a>
<ul>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#step-1-probit-model"><i class="fa fa-check"></i>Step 1: Probit Model</a></li>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#step-2-estimate-via-linear-regression"><i class="fa fa-check"></i>Step 2: Estimate via Linear Regression</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#maximum-likelihood"><i class="fa fa-check"></i>Maximum Likelihood</a>
<ul>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#comparison-4"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="heckman-selection.html"><a href="heckman-selection.html#source-6"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html"><i class="fa fa-check"></i>Marginal Structural Model</a>
<ul>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html#data-setup-6"><i class="fa fa-check"></i>Data Setup</a>
<ul>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html#create-the-weights"><i class="fa fa-check"></i>Create the Weights</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html#function-4"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html#estimation-4"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html#comparison-5"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="marginal-structural.html"><a href="marginal-structural.html#source-7"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html"><i class="fa fa-check"></i>Tobit</a>
<ul>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#demonstrate-censoring-with-an-upper-limit"><i class="fa fa-check"></i>Demonstrate Censoring with an Upper Limit</a>
<ul>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#data-setup-7"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#function-5"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#estimation-5"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#comparison-6"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#demonstrate-censoring-with-a-lower-limit"><i class="fa fa-check"></i>Demonstrate censoring with a Lower Limit</a>
<ul>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#comparison-7"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tobit.html"><a href="tobit.html#source-8"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html"><i class="fa fa-check"></i>Hurdle Model</a>
<ul>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#poisson"><i class="fa fa-check"></i>Poisson</a>
<ul>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#data-setup-8"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#function-6"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#estimation-6"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#comparison-8"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#negative-binomial"><i class="fa fa-check"></i>Negative Binomial</a>
<ul>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#function-7"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#estimation-7"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#comparison-9"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hurdle.html"><a href="hurdle.html#source-9"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html"><i class="fa fa-check"></i>Zero-Inflated Model</a>
<ul>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#poisson-1"><i class="fa fa-check"></i>Poisson</a>
<ul>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#data-setup-9"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#function-8"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#estimation-8"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#comparison-10"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#negative-binomial-1"><i class="fa fa-check"></i>Negative Binomial</a>
<ul>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#function-9"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#estimation-9"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#comparison-11"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#supplemental-example"><i class="fa fa-check"></i>Supplemental Example</a></li>
<li class="chapter" data-level="" data-path="zi.html"><a href="zi.html#source-10"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html"><i class="fa fa-check"></i>Cox Survival</a>
<ul>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#standard-proportional-hazards"><i class="fa fa-check"></i>Standard Proportional Hazards</a>
<ul>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#data-setup-10"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#function-10"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#estimation-10"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#comparison-12"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#time-varying-coefficients"><i class="fa fa-check"></i>Time-varying coefficients</a>
<ul>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#data-setup-11"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#function-11"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#estimation-11"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#comparison-13"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#stratified-cox-model"><i class="fa fa-check"></i>Stratified Cox Model</a>
<ul>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#data-setup-12"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#function-12"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#estimation-12"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#comparison-14"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cox.html"><a href="cox.html#source-11"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="naive-bayes.html"><a href="naive-bayes.html"><i class="fa fa-check"></i>Naive Bayes</a>
<ul>
<li class="chapter" data-level="" data-path="naive-bayes.html"><a href="naive-bayes.html#initialization"><i class="fa fa-check"></i>Initialization</a></li>
<li class="chapter" data-level="" data-path="naive-bayes.html"><a href="naive-bayes.html#comparison-15"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="naive-bayes.html"><a href="naive-bayes.html#source-12"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html"><i class="fa fa-check"></i>Multinomial</a>
<ul>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#standard-categorical-model"><i class="fa fa-check"></i>Standard (Categorical) Model</a>
<ul>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#data-setup-13"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#function-13"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#comparison-16"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#alternative-specific-and-constant-variables"><i class="fa fa-check"></i>Alternative specific and constant variables</a>
<ul>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#comparison-17"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="multinomial.html"><a href="multinomial.html#source-13"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ordinal.html"><a href="ordinal.html"><i class="fa fa-check"></i>Ordinal</a>
<ul>
<li class="chapter" data-level="" data-path="ordinal.html"><a href="ordinal.html#data"><i class="fa fa-check"></i>Data</a></li>
<li class="chapter" data-level="" data-path="ordinal.html"><a href="ordinal.html#function-14"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="ordinal.html"><a href="ordinal.html#estimation-13"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="ordinal.html"><a href="ordinal.html#comparison-18"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="ordinal.html"><a href="ordinal.html#source-14"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html"><i class="fa fa-check"></i>Markov Chain Model</a>
<ul>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#data-setup-14"><i class="fa fa-check"></i>Data Setup</a>
<ul>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#data-functions"><i class="fa fa-check"></i>Data Functions</a></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#two-states-demo"><i class="fa fa-check"></i>Two states Demo</a></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#three-states-demo"><i class="fa fa-check"></i>Three states demo</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#function-15"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#estimation-14"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#comparison-19"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="markov.html"><a href="markov.html#source-15"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hmm.html"><a href="hmm.html"><i class="fa fa-check"></i>Hidden Markov Model</a>
<ul>
<li class="chapter" data-level="" data-path="hmm.html"><a href="hmm.html#data-setup-15"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="hmm.html"><a href="hmm.html#function-16"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="hmm.html"><a href="hmm.html#estimation-15"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="hmm.html"><a href="hmm.html#supplemental-demo"><i class="fa fa-check"></i>Supplemental demo</a></li>
<li class="chapter" data-level="" data-path="hmm.html"><a href="hmm.html#source-16"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html"><i class="fa fa-check"></i>Quantile Regression</a>
<ul>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html#data-setup-16"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html#function-17"><i class="fa fa-check"></i>Function</a>
<ul>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html#median-estimation"><i class="fa fa-check"></i>Median estimation</a></li>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html#other-quantiles"><i class="fa fa-check"></i>Other quantiles</a></li>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html#visualize"><i class="fa fa-check"></i>Visualize</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="quantile-regression.html"><a href="quantile-regression.html#source-17"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cubic-spline.html"><a href="cubic-spline.html"><i class="fa fa-check"></i>Cubic Spline Model</a>
<ul>
<li class="chapter" data-level="" data-path="cubic-spline.html"><a href="cubic-spline.html#data-setup-17"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="cubic-spline.html"><a href="cubic-spline.html#functions-2"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="cubic-spline.html"><a href="cubic-spline.html#example-1"><i class="fa fa-check"></i>Example 1</a></li>
<li class="chapter" data-level="" data-path="cubic-spline.html"><a href="cubic-spline.html#example-2"><i class="fa fa-check"></i>Example 2</a></li>
<li class="chapter" data-level="" data-path="cubic-spline.html"><a href="cubic-spline.html#source-18"><i class="fa fa-check"></i>Source</a></li>
<li class="chapter" data-level="" data-path="gaussian-process.html"><a href="gaussian-process.html"><i class="fa fa-check"></i>Gausian Processes</a>
<ul>
<li class="chapter" data-level="" data-path="gaussian-process.html"><a href="gaussian-process.html#noise-free-demonstration"><i class="fa fa-check"></i>Noise-Free Demonstration</a></li>
<li class="chapter" data-level="" data-path="gaussian-process.html"><a href="gaussian-process.html#noisy-demonstration"><i class="fa fa-check"></i>Noisy Demonstration</a></li>
<li class="chapter" data-level="" data-path="gaussian-process.html"><a href="gaussian-process.html#source-19"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html"><i class="fa fa-check"></i>Confirmatory Factor Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#data-setup-20"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#functions-5"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#estimation-16"><i class="fa fa-check"></i>Estimation</a>
<ul>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#raw"><i class="fa fa-check"></i>Raw</a></li>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#standardized"><i class="fa fa-check"></i>Standardized</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#comparison-20"><i class="fa fa-check"></i>Comparison</a>
<ul>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#mplus"><i class="fa fa-check"></i>Mplus</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="cfa.html"><a href="cfa.html#source-20"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="part"><span><b>Algorithms</b></span></li>
<li class="chapter" data-level="" data-path="penalized-maximum-likelihood.html"><a href="penalized-maximum-likelihood.html"><i class="fa fa-check"></i>Penalized Maximum Likelihood</a>
<ul>
<li class="chapter" data-level="" data-path="penalized-maximum-likelihood.html"><a href="penalized-maximum-likelihood.html#data-setup-21"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="penalized-maximum-likelihood.html"><a href="penalized-maximum-likelihood.html#functions-6"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="penalized-maximum-likelihood.html"><a href="penalized-maximum-likelihood.html#estimation-17"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="penalized-maximum-likelihood.html"><a href="penalized-maximum-likelihood.html#comparison-21"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="penalized-maximum-likelihood.html"><a href="penalized-maximum-likelihood.html#source-21"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="lasso.html"><a href="lasso.html"><i class="fa fa-check"></i>L1 (lasso) regularization</a>
<ul>
<li class="chapter" data-level="" data-path="lasso.html"><a href="lasso.html#data-setup-22"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="lasso.html"><a href="lasso.html#functions-7"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="lasso.html"><a href="lasso.html#estimation-18"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="lasso.html"><a href="lasso.html#comparison-22"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="lasso.html"><a href="lasso.html#source-22"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ridge.html"><a href="ridge.html"><i class="fa fa-check"></i>L2 (ridge) regularization</a>
<ul>
<li class="chapter" data-level="" data-path="ridge.html"><a href="ridge.html#data-setup-23"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="ridge.html"><a href="ridge.html#functions-8"><i class="fa fa-check"></i>Functions</a></li>
<li class="chapter" data-level="" data-path="ridge.html"><a href="ridge.html#estimation-19"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="ridge.html"><a href="ridge.html#comparison-23"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="ridge.html"><a href="ridge.html#source-23"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html"><i class="fa fa-check"></i>Newton and IRLS</a>
<ul>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html#data-setup-24"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html#functions-9"><i class="fa fa-check"></i>Functions</a>
<ul>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html#newtons-method"><i class="fa fa-check"></i>Newton’s Method</a></li>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html#irls"><i class="fa fa-check"></i>IRLS</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html#comparison-24"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="newton-irls.html"><a href="newton-irls.html#source-24"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html"><i class="fa fa-check"></i>Nelder Mead</a>
<ul>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#first-version"><i class="fa fa-check"></i>First Version</a>
<ul>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#example-3"><i class="fa fa-check"></i>Example</a></li>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#a-regression-model"><i class="fa fa-check"></i>A Regression Model</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#second-version"><i class="fa fa-check"></i>Second Version</a>
<ul>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#example-function"><i class="fa fa-check"></i>Example Function</a></li>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#a-regression-model-1"><i class="fa fa-check"></i>A Regression Model</a></li>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#comparison-26"><i class="fa fa-check"></i>Comparison</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="nelder-mead.html"><a href="nelder-mead.html#source-25"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="gradient-descent.html"><a href="gradient-descent.html"><i class="fa fa-check"></i>Gradient Descent</a>
<ul>
<li class="chapter" data-level="" data-path="gradient-descent.html"><a href="gradient-descent.html#data-setup-26"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="gradient-descent.html"><a href="gradient-descent.html#function-18"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="gradient-descent.html"><a href="gradient-descent.html#estimation-20"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="gradient-descent.html"><a href="gradient-descent.html#comparison-27"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="gradient-descent.html"><a href="gradient-descent.html#source-26"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html"><i class="fa fa-check"></i>Stochastic Gradient Descent</a>
<ul>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#data-setup-27"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#function-19"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#estimation-21"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#comparison-28"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#visualize-estimates"><i class="fa fa-check"></i>Visualize Estimates</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#data-set-shift"><i class="fa fa-check"></i>Data Set Shift</a>
<ul>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#estimation-22"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#comparison-29"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#visualize-estimates-1"><i class="fa fa-check"></i>Visualize Estimates</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#source-27"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html"><i class="fa fa-check"></i>Expectation-Maximization</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#mixture-model"><i class="fa fa-check"></i>Mixture Model</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#data-setup-28"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#function-20"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#estimation-23"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#comparison-30"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#supplemental-example-1"><i class="fa fa-check"></i>Supplemental Example</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#source-28"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#multivariate-mixture-model"><i class="fa fa-check"></i>Multivariate Mixture Model</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#function-21"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#example-1-old-faithful-eruptions"><i class="fa fa-check"></i>Example 1: Old Faithful eruptions</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#example-2-iris-data-set"><i class="fa fa-check"></i>Example 2: Iris data set</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#source-29"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#probit-model"><i class="fa fa-check"></i>Probit Model</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#data-setup-31"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#probit-via-maximum-likelihood"><i class="fa fa-check"></i>Probit via Maximum Likelihood</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#em-for-latent-variable-approach-to-probit"><i class="fa fa-check"></i>EM for Latent Variable Approach to Probit</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#source-30"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#pca"><i class="fa fa-check"></i>PCA</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#data-setup-32"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#function-24"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#estimation-28"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#comparison-35"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#visualize-2"><i class="fa fa-check"></i>Visualize</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#source-31"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#probabilistic-pca"><i class="fa fa-check"></i>Probabilistic PCA</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#data-setup-33"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#function-25"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#estimation-29"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#comparison-36"><i class="fa fa-check"></i>Comparison</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#visualize-3"><i class="fa fa-check"></i>Visualize</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#missing-data-example"><i class="fa fa-check"></i>Missing Data Example</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#source-32"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#state-space-model"><i class="fa fa-check"></i>State Space Model</a>
<ul>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#data-setup-35"><i class="fa fa-check"></i>Data Setup</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#function-27"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#estimation-31"><i class="fa fa-check"></i>Estimation</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#visualization"><i class="fa fa-check"></i>Visualization</a></li>
<li class="chapter" data-level="" data-path="em.html"><a href="em.html#source-33"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>Other</b></span></li>
<li class="chapter" data-level="" data-path="supplemental.html"><a href="supplemental.html"><i class="fa fa-check"></i>Supplemental</a>
<ul>
<li class="chapter" data-level="" data-path="supplemental.html"><a href="supplemental.html#other-languages"><i class="fa fa-check"></i>Other Languages</a>
<ul>
<li class="chapter" data-level="" data-path="supplemental.html"><a href="supplemental.html#algorithms"><i class="fa fa-check"></i>Algorithms</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li class='after'">
   <a href="https://m-clark.github.io/">
      <img src="img/mc_logo.png" style="width:25%; padding:0px 0; display:block; margin: 0 auto;" alt="MC logo">
   </a>
</li>
<li class='after'">
   <div style='text-align:center'>
      <a href="https://github.com/m-clark/">
         <i class="fab fa-github fa-2x" aria-hidden="true"></i>
      </a>
   </div>
</li>
<li class='after'">
   <div style='text-align:center'>
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
         <i class="fab fa-creative-commons fa-lg"></i>
         <i class="fab fa-creative-commons-by fa-lg"></i>
         <i class="fab fa-creative-commons-sa fa-lg"></i>
      </a>
   </div>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Model Estimation by Example</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="expectation-maximization" class="section level1">
<h1>Expectation-Maximization</h1>
<div id="mixture-model" class="section level2">
<h2>Mixture Model</h2>
<p>The following code is based on algorithms noted in Murphy, 2012 Probabilistic Machine Learning, specifically, Chapter 11, section 4.</p>
<div id="data-setup-28" class="section level3">
<h3>Data Setup</h3>
<p>This example uses Old Faithful geyser eruptions. This is only a univariate mixture for either eruption time or wait time. The <a href="em.html#multivariate-mixture-model">next example</a> will be doing both variables, i.e. multivariate normal. ‘Geyser’ is supposedly more accurate, though seems to have
arbitrarily assigned some duration values. See also <a href="http://www.geyserstudy.org/geyser.aspx?pGeyserNo=OLDFAITHFUL" class="uri">http://www.geyserstudy.org/geyser.aspx?pGeyserNo=OLDFAITHFUL</a>, but that only has
intervals. Some July 1995 data is available.</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb462-1"><a href="em.html#cb462-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb462-2"><a href="em.html#cb462-2"></a></span>
<span id="cb462-3"><a href="em.html#cb462-3"></a><span class="co"># faithful data set is in base R</span></span>
<span id="cb462-4"><a href="em.html#cb462-4"></a><span class="kw">data</span>(faithful)</span>
<span id="cb462-5"><a href="em.html#cb462-5"></a></span>
<span id="cb462-6"><a href="em.html#cb462-6"></a><span class="kw">head</span>(faithful)</span></code></pre></div>
<pre><code>  eruptions waiting
1     3.600      79
2     1.800      54
3     3.333      74
4     2.283      62
5     4.533      85
6     2.883      55</code></pre>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb464-1"><a href="em.html#cb464-1"></a>eruptions  =<span class="st"> </span><span class="kw">as.matrix</span>(faithful[, <span class="dv">1</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>])</span>
<span id="cb464-2"><a href="em.html#cb464-2"></a>wait_times =<span class="st"> </span><span class="kw">as.matrix</span>(faithful[, <span class="dv">2</span>, <span class="dt">drop =</span> <span class="ot">FALSE</span>])</span></code></pre></div>
</div>
<div id="function-20" class="section level3">
<h3>Function</h3>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb465-1"><a href="em.html#cb465-1"></a>em_mixture =<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb465-2"><a href="em.html#cb465-2"></a>  params,</span>
<span id="cb465-3"><a href="em.html#cb465-3"></a>  X,</span>
<span id="cb465-4"><a href="em.html#cb465-4"></a>  <span class="dt">clusters =</span> <span class="dv">2</span>,</span>
<span id="cb465-5"><a href="em.html#cb465-5"></a>  <span class="dt">tol =</span> <span class="fl">.00001</span>,</span>
<span id="cb465-6"><a href="em.html#cb465-6"></a>  <span class="dt">maxits  =</span> <span class="dv">100</span>,</span>
<span id="cb465-7"><a href="em.html#cb465-7"></a>  <span class="dt">showits =</span> <span class="ot">TRUE</span></span>
<span id="cb465-8"><a href="em.html#cb465-8"></a>) {</span>
<span id="cb465-9"><a href="em.html#cb465-9"></a>  </span>
<span id="cb465-10"><a href="em.html#cb465-10"></a>  <span class="co"># Arguments are starting parameters (means, covariances, cluster probability),</span></span>
<span id="cb465-11"><a href="em.html#cb465-11"></a>  <span class="co"># data, number of clusters desired, tolerance, maximum iterations, and whether</span></span>
<span id="cb465-12"><a href="em.html#cb465-12"></a>  <span class="co"># to show iterations</span></span>
<span id="cb465-13"><a href="em.html#cb465-13"></a>  </span>
<span id="cb465-14"><a href="em.html#cb465-14"></a>  <span class="co"># Starting points</span></span>
<span id="cb465-15"><a href="em.html#cb465-15"></a>  N     =<span class="st"> </span><span class="kw">nrow</span>(X)</span>
<span id="cb465-16"><a href="em.html#cb465-16"></a>  nams  =<span class="st"> </span><span class="kw">names</span>(params)</span>
<span id="cb465-17"><a href="em.html#cb465-17"></a>  mu    =<span class="st"> </span>params<span class="op">$</span>mu</span>
<span id="cb465-18"><a href="em.html#cb465-18"></a>  var   =<span class="st"> </span>params<span class="op">$</span>var</span>
<span id="cb465-19"><a href="em.html#cb465-19"></a>  probs =<span class="st"> </span>params<span class="op">$</span>probs</span>
<span id="cb465-20"><a href="em.html#cb465-20"></a>  </span>
<span id="cb465-21"><a href="em.html#cb465-21"></a>  <span class="co"># Other initializations</span></span>
<span id="cb465-22"><a href="em.html#cb465-22"></a>  <span class="co"># initialize cluster &#39;responsibilities&#39;, i.e. probability of cluster</span></span>
<span id="cb465-23"><a href="em.html#cb465-23"></a>  <span class="co"># membership for each observation i</span></span>
<span id="cb465-24"><a href="em.html#cb465-24"></a>  ri =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">ncol =</span> clusters, <span class="dt">nrow =</span> N) </span>
<span id="cb465-25"><a href="em.html#cb465-25"></a>  it =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb465-26"><a href="em.html#cb465-26"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb465-27"><a href="em.html#cb465-27"></a>  </span>
<span id="cb465-28"><a href="em.html#cb465-28"></a>  <span class="cf">if</span> (showits)                                  <span class="co"># Show iterations</span></span>
<span id="cb465-29"><a href="em.html#cb465-29"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb465-30"><a href="em.html#cb465-30"></a>  </span>
<span id="cb465-31"><a href="em.html#cb465-31"></a>  <span class="cf">while</span> ((<span class="op">!</span>converged) <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">&lt;</span><span class="st"> </span>maxits)) { </span>
<span id="cb465-32"><a href="em.html#cb465-32"></a>    probsOld =<span class="st"> </span>probs</span>
<span id="cb465-33"><a href="em.html#cb465-33"></a>    muOld =<span class="st"> </span>mu</span>
<span id="cb465-34"><a href="em.html#cb465-34"></a>    varOld =<span class="st"> </span>var</span>
<span id="cb465-35"><a href="em.html#cb465-35"></a>    riOld =<span class="st"> </span>ri</span>
<span id="cb465-36"><a href="em.html#cb465-36"></a>    </span>
<span id="cb465-37"><a href="em.html#cb465-37"></a>    <span class="co"># E</span></span>
<span id="cb465-38"><a href="em.html#cb465-38"></a>    <span class="co"># Compute responsibilities</span></span>
<span id="cb465-39"><a href="em.html#cb465-39"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>clusters){</span>
<span id="cb465-40"><a href="em.html#cb465-40"></a>      ri[, k] =<span class="st"> </span>probs[k] <span class="op">*</span><span class="st"> </span><span class="kw">dnorm</span>(X, mu[k], <span class="dt">sd =</span> <span class="kw">sqrt</span>(var[k]), <span class="dt">log =</span> <span class="ot">FALSE</span>)</span>
<span id="cb465-41"><a href="em.html#cb465-41"></a>    }</span>
<span id="cb465-42"><a href="em.html#cb465-42"></a>    </span>
<span id="cb465-43"><a href="em.html#cb465-43"></a>    ri =<span class="st"> </span>ri<span class="op">/</span><span class="kw">rowSums</span>(ri)</span>
<span id="cb465-44"><a href="em.html#cb465-44"></a>    </span>
<span id="cb465-45"><a href="em.html#cb465-45"></a>    <span class="co"># M</span></span>
<span id="cb465-46"><a href="em.html#cb465-46"></a>    rk =<span class="st"> </span><span class="kw">colSums</span>(ri)           <span class="co"># rk is the weighted average cluster membership size</span></span>
<span id="cb465-47"><a href="em.html#cb465-47"></a>    probs =<span class="st"> </span>rk<span class="op">/</span>N</span>
<span id="cb465-48"><a href="em.html#cb465-48"></a>    mu =<span class="st"> </span>(<span class="kw">t</span>(X) <span class="op">%*%</span><span class="st"> </span>ri) <span class="op">/</span><span class="st"> </span>rk    </span>
<span id="cb465-49"><a href="em.html#cb465-49"></a>    var =<span class="st"> </span>(<span class="kw">t</span>(X<span class="op">^</span><span class="dv">2</span>) <span class="op">%*%</span><span class="st"> </span>ri) <span class="op">/</span><span class="st"> </span>rk <span class="op">-</span><span class="st"> </span>mu<span class="op">^</span><span class="dv">2</span></span>
<span id="cb465-50"><a href="em.html#cb465-50"></a>    </span>
<span id="cb465-51"><a href="em.html#cb465-51"></a>    <span class="co"># could do mu and var via log likelihood here, but this is more straightforward</span></span>
<span id="cb465-52"><a href="em.html#cb465-52"></a></span>
<span id="cb465-53"><a href="em.html#cb465-53"></a>    parmlistold     =<span class="st"> </span><span class="kw">rbind</span>(probsOld, muOld, varOld)</span>
<span id="cb465-54"><a href="em.html#cb465-54"></a>    parmlistcurrent =<span class="st"> </span><span class="kw">rbind</span>(probs, mu, var)</span>
<span id="cb465-55"><a href="em.html#cb465-55"></a>    </span>
<span id="cb465-56"><a href="em.html#cb465-56"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb465-57"><a href="em.html#cb465-57"></a>    </span>
<span id="cb465-58"><a href="em.html#cb465-58"></a>    <span class="co"># if showits true, &amp; it =1 or divisible by 5 print message</span></span>
<span id="cb465-59"><a href="em.html#cb465-59"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)        </span>
<span id="cb465-60"><a href="em.html#cb465-60"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb465-61"><a href="em.html#cb465-61"></a>    </span>
<span id="cb465-62"><a href="em.html#cb465-62"></a>    converged =<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(parmlistold <span class="op">-</span><span class="st"> </span>parmlistcurrent)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb465-63"><a href="em.html#cb465-63"></a>  }</span>
<span id="cb465-64"><a href="em.html#cb465-64"></a>  </span>
<span id="cb465-65"><a href="em.html#cb465-65"></a>  clust =<span class="st"> </span><span class="kw">which</span>(<span class="kw">round</span>(ri) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">arr.ind =</span> <span class="ot">TRUE</span>) <span class="co"># create cluster membership</span></span>
<span id="cb465-66"><a href="em.html#cb465-66"></a>  clust =<span class="st"> </span>clust[<span class="kw">order</span>(clust[, <span class="dv">1</span>]), <span class="dv">2</span>]           <span class="co"># order according to row rather than cluster</span></span>
<span id="cb465-67"><a href="em.html#cb465-67"></a>  </span>
<span id="cb465-68"><a href="em.html#cb465-68"></a>  out =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb465-69"><a href="em.html#cb465-69"></a>    <span class="dt">probs   =</span> probs,</span>
<span id="cb465-70"><a href="em.html#cb465-70"></a>    <span class="dt">mu      =</span> mu,</span>
<span id="cb465-71"><a href="em.html#cb465-71"></a>    <span class="dt">var     =</span> var,</span>
<span id="cb465-72"><a href="em.html#cb465-72"></a>    <span class="dt">resp    =</span> ri,</span>
<span id="cb465-73"><a href="em.html#cb465-73"></a>    <span class="dt">cluster =</span> clust</span>
<span id="cb465-74"><a href="em.html#cb465-74"></a>  )</span>
<span id="cb465-75"><a href="em.html#cb465-75"></a>  </span>
<span id="cb465-76"><a href="em.html#cb465-76"></a>  out</span>
<span id="cb465-77"><a href="em.html#cb465-77"></a>} </span></code></pre></div>
</div>
<div id="estimation-23" class="section level3">
<h3>Estimation</h3>
<p>Starting parameters, requires mean, variance and class probability. Note that starts for mean must be within the data range or it will break.</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="em.html#cb466-1"></a>params1 =<span class="st"> </span><span class="kw">list</span>(<span class="dt">mu =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>),</span>
<span id="cb466-2"><a href="em.html#cb466-2"></a>               <span class="dt">var =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb466-3"><a href="em.html#cb466-3"></a>               <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.5</span>))</span>
<span id="cb466-4"><a href="em.html#cb466-4"></a></span>
<span id="cb466-5"><a href="em.html#cb466-5"></a>params2 =<span class="st"> </span><span class="kw">list</span>(<span class="dt">mu =</span> <span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">90</span>),</span>
<span id="cb466-6"><a href="em.html#cb466-6"></a>               <span class="dt">var =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">15</span>),</span>
<span id="cb466-7"><a href="em.html#cb466-7"></a>               <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.5</span>))  </span></code></pre></div>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb467-1"><a href="em.html#cb467-1"></a>mix_erupt   =<span class="st"> </span><span class="kw">em_mixture</span>(params1, <span class="dt">X =</span> eruptions,  <span class="dt">tol =</span> <span class="fl">1e-8</span>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
5...
10...
15...
20...
25...
30...</code></pre>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb469-1"><a href="em.html#cb469-1"></a>mix_waiting =<span class="st"> </span><span class="kw">em_mixture</span>(params2, <span class="dt">X =</span> wait_times, <span class="dt">tol =</span> <span class="fl">1e-8</span>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
5...
10...
15...
20...
25...
30...
35...
40...
45...
50...
55...</code></pre>
</div>
<div id="comparison-30" class="section level3">
<h3>Comparison</h3>
<p>Compare to <span class="pack" style="">flexmix</span> package results.</p>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb471-1"><a href="em.html#cb471-1"></a><span class="kw">library</span>(flexmix)</span>
<span id="cb471-2"><a href="em.html#cb471-2"></a></span>
<span id="cb471-3"><a href="em.html#cb471-3"></a>flex_erupt =<span class="st"> </span><span class="kw">flexmix</span>(eruptions <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb471-4"><a href="em.html#cb471-4"></a>                     <span class="dt">k =</span> <span class="dv">2</span>,</span>
<span id="cb471-5"><a href="em.html#cb471-5"></a>                     <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">tolerance =</span> <span class="fl">1e-8</span>, <span class="dt">iter.max =</span> <span class="dv">100</span>))</span>
<span id="cb471-6"><a href="em.html#cb471-6"></a></span>
<span id="cb471-7"><a href="em.html#cb471-7"></a>flex_wait =<span class="st"> </span><span class="kw">flexmix</span>(wait_times <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb471-8"><a href="em.html#cb471-8"></a>                    <span class="dt">k =</span> <span class="dv">2</span>,</span>
<span id="cb471-9"><a href="em.html#cb471-9"></a>                    <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">tolerance =</span> <span class="fl">1e-8</span>, <span class="dt">iter.max =</span> <span class="dv">100</span>))</span></code></pre></div>
<p>The following provides means, variances and probability of group membership. Note that the cluster label is arbitrary so cluster 1 for one model may be cluster 2 in another.</p>
<div id="eruptions" class="section level5">
<h5>Eruptions</h5>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb472-1"><a href="em.html#cb472-1"></a>mean_var =<span class="st"> </span><span class="kw">rbind</span>(mix_erupt<span class="op">$</span>mu, <span class="kw">sqrt</span>(mix_erupt<span class="op">$</span>var))</span>
<span id="cb472-2"><a href="em.html#cb472-2"></a><span class="kw">rownames</span>(mean_var) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb472-3"><a href="em.html#cb472-3"></a><span class="kw">colnames</span>(mean_var) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;cluster 1&#39;</span>, <span class="st">&#39;cluster 2&#39;</span>)</span>
<span id="cb472-4"><a href="em.html#cb472-4"></a></span>
<span id="cb472-5"><a href="em.html#cb472-5"></a>mean_var_flex =<span class="st"> </span><span class="kw">parameters</span>(flex_erupt)</span>
<span id="cb472-6"><a href="em.html#cb472-6"></a><span class="kw">rownames</span>(mean_var_flex) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb472-7"><a href="em.html#cb472-7"></a><span class="kw">colnames</span>(mean_var_flex) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;cluster 1 flex&#39;</span>, <span class="st">&#39;cluster 2 flex&#39;</span>)</span>
<span id="cb472-8"><a href="em.html#cb472-8"></a></span>
<span id="cb472-9"><a href="em.html#cb472-9"></a></span>
<span id="cb472-10"><a href="em.html#cb472-10"></a>prob_membership     =<span class="st"> </span>mix_erupt<span class="op">$</span>probs</span>
<span id="cb472-11"><a href="em.html#cb472-11"></a>prob_membership_flex =<span class="st"> </span>flex_erupt<span class="op">@</span>size <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(flex_erupt<span class="op">@</span>size)</span>
<span id="cb472-12"><a href="em.html#cb472-12"></a></span>
<span id="cb472-13"><a href="em.html#cb472-13"></a><span class="kw">list</span>(</span>
<span id="cb472-14"><a href="em.html#cb472-14"></a>  <span class="dt">params =</span> <span class="kw">cbind</span>(mean_var, mean_var_flex),</span>
<span id="cb472-15"><a href="em.html#cb472-15"></a>  <span class="dt">clusterpobs =</span> <span class="kw">cbind</span>(prob_membership, prob_membership_flex)</span>
<span id="cb472-16"><a href="em.html#cb472-16"></a>)</span></code></pre></div>
<pre><code>$params
          cluster 1 cluster 2 cluster 1 flex cluster 2 flex
means     2.0186078 4.2733434      4.2733678      2.0186385
variances 0.2356218 0.4370631      0.4378355      0.2361098

$clusterpobs
  prob_membership prob_membership_flex
1       0.3484046            0.6507353
2       0.6515954            0.3492647</code></pre>
</div>
<div id="waiting" class="section level5">
<h5>Waiting</h5>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb474-1"><a href="em.html#cb474-1"></a>mean_var =<span class="st"> </span><span class="kw">rbind</span>(mix_waiting<span class="op">$</span>mu, <span class="kw">sqrt</span>(mix_waiting<span class="op">$</span>var))</span>
<span id="cb474-2"><a href="em.html#cb474-2"></a><span class="kw">rownames</span>(mean_var) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb474-3"><a href="em.html#cb474-3"></a><span class="kw">colnames</span>(mean_var) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;cluster 1&#39;</span>, <span class="st">&#39;cluster 2&#39;</span>)</span>
<span id="cb474-4"><a href="em.html#cb474-4"></a></span>
<span id="cb474-5"><a href="em.html#cb474-5"></a></span>
<span id="cb474-6"><a href="em.html#cb474-6"></a>mean_var_flex =<span class="st"> </span><span class="kw">parameters</span>(flex_wait)</span>
<span id="cb474-7"><a href="em.html#cb474-7"></a><span class="kw">rownames</span>(mean_var_flex) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb474-8"><a href="em.html#cb474-8"></a><span class="kw">colnames</span>(mean_var_flex) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;cluster 1 flex&#39;</span>, <span class="st">&#39;cluster 2 flex&#39;</span>)</span>
<span id="cb474-9"><a href="em.html#cb474-9"></a></span>
<span id="cb474-10"><a href="em.html#cb474-10"></a>prob_membership     =<span class="st"> </span>mix_waiting<span class="op">$</span>probs</span>
<span id="cb474-11"><a href="em.html#cb474-11"></a>prob_membership_flex =<span class="st"> </span>flex_wait<span class="op">@</span>size <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(flex_wait<span class="op">@</span>size)</span>
<span id="cb474-12"><a href="em.html#cb474-12"></a></span>
<span id="cb474-13"><a href="em.html#cb474-13"></a><span class="kw">list</span>(</span>
<span id="cb474-14"><a href="em.html#cb474-14"></a>  <span class="dt">params =</span> <span class="kw">cbind</span>(mean_var, mean_var_flex),</span>
<span id="cb474-15"><a href="em.html#cb474-15"></a>  <span class="dt">clusterpobs =</span> <span class="kw">cbind</span>(prob_membership, prob_membership_flex)</span>
<span id="cb474-16"><a href="em.html#cb474-16"></a>)</span></code></pre></div>
<pre><code>$params
          cluster 1 cluster 2 cluster 1 flex cluster 2 flex
means     54.614856 80.091069      54.616140      80.090678
variances  5.871219  5.867734       5.884422       5.879634

$clusterpobs
  prob_membership prob_membership_flex
1       0.3608861            0.3639706
2       0.6391139            0.6360294</code></pre>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="em.html#cb476-1"></a><span class="kw">qplot</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting, <span class="dt">data =</span> faithful) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/gaussEM-compare-wait-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb477-1"><a href="em.html#cb477-1"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting), <span class="dt">data =</span> faithful) <span class="op">+</span></span>
<span id="cb477-2"><a href="em.html#cb477-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">factor</span>(mix_waiting<span class="op">$</span>cluster))) <span class="op">+</span></span>
<span id="cb477-3"><a href="em.html#cb477-3"></a><span class="st">  </span><span class="kw">geom_density2d</span>() <span class="op">+</span></span>
<span id="cb477-4"><a href="em.html#cb477-4"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/gaussEM-compare-wait-2.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb478-1"><a href="em.html#cb478-1"></a>faithful <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb478-2"><a href="em.html#cb478-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_clus_1 =</span> mix_waiting<span class="op">$</span>resp[, <span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb478-3"><a href="em.html#cb478-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting)) <span class="op">+</span></span>
<span id="cb478-4"><a href="em.html#cb478-4"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> prob_clus_<span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb478-5"><a href="em.html#cb478-5"></a><span class="st">  </span><span class="kw">geom_density2d</span>() <span class="op">+</span></span>
<span id="cb478-6"><a href="em.html#cb478-6"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/gaussEM-compare-wait-3.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="supplemental-example-1" class="section level3">
<h3>Supplemental Example</h3>
<p>This uses the <span class="pack" style="">MASS</span> version (reversed columns). These don’t look even remotely the same data on initial inspection- <code>geyser</code> is even more rounded and of opposite conclusion. Turns out geyser is offset by 1, such that duration 1 should be coupled with waiting 2 and on down. Still the rounding at 2 and 4 (and whatever division was done on duration) makes this fairly poor data.</p>
<p>I’ve cleaned this up a little bit in case someone wants to play with it for additional practice, but it’s not evaluated.</p>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb479-1"><a href="em.html#cb479-1"></a><span class="kw">library</span>(MASS)</span>
<span id="cb479-2"><a href="em.html#cb479-2"></a></span>
<span id="cb479-3"><a href="em.html#cb479-3"></a>geyser =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">duration =</span> geyser<span class="op">$</span>duration[<span class="op">-</span><span class="dv">299</span>], <span class="dt">waiting =</span> geyser<span class="op">$</span>waiting[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb479-4"><a href="em.html#cb479-4"></a></span>
<span id="cb479-5"><a href="em.html#cb479-5"></a><span class="co"># compare to faithful</span></span>
<span id="cb479-6"><a href="em.html#cb479-6"></a><span class="kw">layout</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span>
<span id="cb479-7"><a href="em.html#cb479-7"></a><span class="kw">plot</span>(faithful)</span>
<span id="cb479-8"><a href="em.html#cb479-8"></a><span class="kw">plot</span>(geyser)</span>
<span id="cb479-9"><a href="em.html#cb479-9"></a></span>
<span id="cb479-10"><a href="em.html#cb479-10"></a>X3 =<span class="st"> </span><span class="kw">matrix</span>(geyser[,<span class="dv">1</span>]) </span>
<span id="cb479-11"><a href="em.html#cb479-11"></a>X4 =<span class="st"> </span><span class="kw">matrix</span>(geyser[,<span class="dv">2</span>])</span>
<span id="cb479-12"><a href="em.html#cb479-12"></a></span>
<span id="cb479-13"><a href="em.html#cb479-13"></a></span>
<span id="cb479-14"><a href="em.html#cb479-14"></a><span class="co"># MASS version</span></span>
<span id="cb479-15"><a href="em.html#cb479-15"></a>test3 =<span class="st"> </span><span class="kw">em_mixture</span>(params1, <span class="dt">X =</span> X3, <span class="dt">tol =</span> <span class="fl">1e-8</span>)</span>
<span id="cb479-16"><a href="em.html#cb479-16"></a>test4 =<span class="st"> </span><span class="kw">em_mixture</span>(params2, <span class="dt">X =</span> X4, <span class="dt">tol =</span> <span class="fl">1e-8</span>)</span>
<span id="cb479-17"><a href="em.html#cb479-17"></a></span>
<span id="cb479-18"><a href="em.html#cb479-18"></a>flexmod3 =<span class="st"> </span><span class="kw">flexmix</span>(X3 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb479-19"><a href="em.html#cb479-19"></a>                   <span class="dt">k =</span> <span class="dv">2</span>,</span>
<span id="cb479-20"><a href="em.html#cb479-20"></a>                   <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">tolerance =</span> <span class="fl">1e-8</span>, <span class="dt">iter.max =</span> <span class="dv">100</span>))</span>
<span id="cb479-21"><a href="em.html#cb479-21"></a>flexmod4 =<span class="st"> </span><span class="kw">flexmix</span>(X4 <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb479-22"><a href="em.html#cb479-22"></a>                   <span class="dt">k =</span> <span class="dv">2</span>,</span>
<span id="cb479-23"><a href="em.html#cb479-23"></a>                   <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">tolerance =</span> <span class="fl">1e-8</span>, <span class="dt">iter.max =</span> <span class="dv">100</span>))</span>
<span id="cb479-24"><a href="em.html#cb479-24"></a></span>
<span id="cb479-25"><a href="em.html#cb479-25"></a><span class="co"># note variability differences compared to faithful dataset</span></span>
<span id="cb479-26"><a href="em.html#cb479-26"></a><span class="co"># Eruptions/Duration</span></span>
<span id="cb479-27"><a href="em.html#cb479-27"></a>mean_var =<span class="st"> </span><span class="kw">rbind</span>(test3<span class="op">$</span>mu, <span class="kw">sqrt</span>(test3<span class="op">$</span>var))</span>
<span id="cb479-28"><a href="em.html#cb479-28"></a><span class="kw">rownames</span>(mean_var) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb479-29"><a href="em.html#cb479-29"></a></span>
<span id="cb479-30"><a href="em.html#cb479-30"></a>mean_var_flex =<span class="st"> </span><span class="kw">parameters</span>(flexmod3)</span>
<span id="cb479-31"><a href="em.html#cb479-31"></a><span class="kw">rownames</span>(mean_var_flex) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb479-32"><a href="em.html#cb479-32"></a></span>
<span id="cb479-33"><a href="em.html#cb479-33"></a>prob_membership =<span class="st"> </span>test3<span class="op">$</span>probs</span>
<span id="cb479-34"><a href="em.html#cb479-34"></a>prob_membership_flex =<span class="st"> </span>flexmod3<span class="op">@</span>size <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(flexmod3<span class="op">@</span>size)</span>
<span id="cb479-35"><a href="em.html#cb479-35"></a></span>
<span id="cb479-36"><a href="em.html#cb479-36"></a><span class="kw">list</span>(</span>
<span id="cb479-37"><a href="em.html#cb479-37"></a>  <span class="dt">params =</span> <span class="kw">cbind</span>(mean_var, mean_var_flex),</span>
<span id="cb479-38"><a href="em.html#cb479-38"></a>  <span class="dt">clusterpobs =</span> <span class="kw">cbind</span>(prob_membership, prob_membership_flex)</span>
<span id="cb479-39"><a href="em.html#cb479-39"></a>)</span>
<span id="cb479-40"><a href="em.html#cb479-40"></a></span>
<span id="cb479-41"><a href="em.html#cb479-41"></a><span class="co"># Waiting</span></span>
<span id="cb479-42"><a href="em.html#cb479-42"></a>mean_var =<span class="st"> </span><span class="kw">rbind</span>(test4<span class="op">$</span>mu, <span class="kw">sqrt</span>(test4<span class="op">$</span>var))</span>
<span id="cb479-43"><a href="em.html#cb479-43"></a><span class="kw">rownames</span>(mean_var) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb479-44"><a href="em.html#cb479-44"></a></span>
<span id="cb479-45"><a href="em.html#cb479-45"></a>mean_var_flex =<span class="st"> </span><span class="kw">parameters</span>(flexmod4)</span>
<span id="cb479-46"><a href="em.html#cb479-46"></a><span class="kw">rownames</span>(mean_var_flex) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;means&#39;</span>, <span class="st">&#39;variances&#39;</span>)</span>
<span id="cb479-47"><a href="em.html#cb479-47"></a></span>
<span id="cb479-48"><a href="em.html#cb479-48"></a>prob_membership =<span class="st"> </span>test4<span class="op">$</span>probs</span>
<span id="cb479-49"><a href="em.html#cb479-49"></a>prob_membership_flex =<span class="st"> </span>flexmod4<span class="op">@</span>size <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(flexmod4<span class="op">@</span>size)</span>
<span id="cb479-50"><a href="em.html#cb479-50"></a></span>
<span id="cb479-51"><a href="em.html#cb479-51"></a><span class="kw">list</span>(</span>
<span id="cb479-52"><a href="em.html#cb479-52"></a>  <span class="dt">params =</span> <span class="kw">cbind</span>(mean_var, mean_var_flex),</span>
<span id="cb479-53"><a href="em.html#cb479-53"></a>  <span class="dt">clusterpobs =</span> <span class="kw">cbind</span>(prob_membership, prob_membership_flex)</span>
<span id="cb479-54"><a href="em.html#cb479-54"></a>)</span>
<span id="cb479-55"><a href="em.html#cb479-55"></a></span>
<span id="cb479-56"><a href="em.html#cb479-56"></a><span class="co"># Some plots</span></span>
<span id="cb479-57"><a href="em.html#cb479-57"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb479-58"><a href="em.html#cb479-58"></a><span class="kw">qplot</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting, <span class="dt">data =</span> faithful) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</span>
<span id="cb479-59"><a href="em.html#cb479-59"></a></span>
<span id="cb479-60"><a href="em.html#cb479-60"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting), <span class="dt">data =</span> faithful) <span class="op">+</span></span>
<span id="cb479-61"><a href="em.html#cb479-61"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">factor</span>(mix_waiting<span class="op">$</span>cluster))) <span class="op">+</span></span>
<span id="cb479-62"><a href="em.html#cb479-62"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span>
<span id="cb479-63"><a href="em.html#cb479-63"></a></span>
<span id="cb479-64"><a href="em.html#cb479-64"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting), <span class="dt">data =</span> faithful) <span class="op">+</span></span>
<span id="cb479-65"><a href="em.html#cb479-65"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> mix_waiting<span class="op">$</span>resp[, <span class="dv">1</span>])) <span class="op">+</span></span>
<span id="cb479-66"><a href="em.html#cb479-66"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
</div>
<div id="source-28" class="section level3">
<h3>Source</h3>
<p>Original code available at
<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20Mixture.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20Mixture.R</a></p>
</div>
</div>
<div id="multivariate-mixture-model" class="section level2">
<h2>Multivariate Mixture Model</h2>
<p>The following code is based on algorithms noted in Murphy, 2012 Probabilistic Machine Learning.
Specifically, Chapter 11, section 4.</p>
<div id="function-21" class="section level3">
<h3>Function</h3>
<div class="sourceCode" id="cb480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb480-1"><a href="em.html#cb480-1"></a>em_mixture =<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb480-2"><a href="em.html#cb480-2"></a>  params,</span>
<span id="cb480-3"><a href="em.html#cb480-3"></a>  X,</span>
<span id="cb480-4"><a href="em.html#cb480-4"></a>  <span class="dt">clusters =</span> <span class="dv">2</span>,</span>
<span id="cb480-5"><a href="em.html#cb480-5"></a>  <span class="dt">tol =</span> <span class="fl">.00001</span>,</span>
<span id="cb480-6"><a href="em.html#cb480-6"></a>  <span class="dt">maxits  =</span> <span class="dv">100</span>,</span>
<span id="cb480-7"><a href="em.html#cb480-7"></a>  <span class="dt">showits =</span> <span class="ot">TRUE</span></span>
<span id="cb480-8"><a href="em.html#cb480-8"></a>  ) {</span>
<span id="cb480-9"><a href="em.html#cb480-9"></a>  </span>
<span id="cb480-10"><a href="em.html#cb480-10"></a>  <span class="co"># Arguments are </span></span>
<span id="cb480-11"><a href="em.html#cb480-11"></a>  <span class="co"># params: starting parameters (means, covariances, cluster probability)</span></span>
<span id="cb480-12"><a href="em.html#cb480-12"></a>  <span class="co"># X: data </span></span>
<span id="cb480-13"><a href="em.html#cb480-13"></a>  <span class="co"># clusters: number of clusters desired</span></span>
<span id="cb480-14"><a href="em.html#cb480-14"></a>  <span class="co"># tol: tolerance</span></span>
<span id="cb480-15"><a href="em.html#cb480-15"></a>  <span class="co"># maxits: maximum iterations</span></span>
<span id="cb480-16"><a href="em.html#cb480-16"></a>  <span class="co"># showits: whether to show iterations</span></span>
<span id="cb480-17"><a href="em.html#cb480-17"></a>  </span>
<span id="cb480-18"><a href="em.html#cb480-18"></a>  <span class="kw">require</span>(mvtnorm)</span>
<span id="cb480-19"><a href="em.html#cb480-19"></a>  <span class="co"># Starting points</span></span>
<span id="cb480-20"><a href="em.html#cb480-20"></a>  N     =<span class="st"> </span><span class="kw">nrow</span>(X)</span>
<span id="cb480-21"><a href="em.html#cb480-21"></a>  mu    =<span class="st"> </span>params<span class="op">$</span>mu</span>
<span id="cb480-22"><a href="em.html#cb480-22"></a>  var   =<span class="st"> </span>params<span class="op">$</span>var</span>
<span id="cb480-23"><a href="em.html#cb480-23"></a>  probs =<span class="st"> </span>params<span class="op">$</span>probs</span>
<span id="cb480-24"><a href="em.html#cb480-24"></a>  </span>
<span id="cb480-25"><a href="em.html#cb480-25"></a>  <span class="co"># initializations</span></span>
<span id="cb480-26"><a href="em.html#cb480-26"></a>  </span>
<span id="cb480-27"><a href="em.html#cb480-27"></a>  <span class="co"># cluster &#39;responsibilities&#39;, i.e. probability of cluster membership for each</span></span>
<span id="cb480-28"><a href="em.html#cb480-28"></a>  <span class="co"># observation i</span></span>
<span id="cb480-29"><a href="em.html#cb480-29"></a>  ri =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">ncol=</span>clusters, <span class="dt">nrow=</span>N)       </span>
<span id="cb480-30"><a href="em.html#cb480-30"></a>  ll =<span class="st"> </span><span class="dv">0</span>                                        <span class="co"># log likelihood</span></span>
<span id="cb480-31"><a href="em.html#cb480-31"></a>  it =<span class="st"> </span><span class="dv">0</span>                                        <span class="co"># iteration count</span></span>
<span id="cb480-32"><a href="em.html#cb480-32"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span>                             <span class="co"># convergence</span></span>
<span id="cb480-33"><a href="em.html#cb480-33"></a>  </span>
<span id="cb480-34"><a href="em.html#cb480-34"></a>  <span class="co"># Show iterations if showits == true</span></span>
<span id="cb480-35"><a href="em.html#cb480-35"></a>  <span class="cf">if</span> (showits)                                  </span>
<span id="cb480-36"><a href="em.html#cb480-36"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb480-37"><a href="em.html#cb480-37"></a>  </span>
<span id="cb480-38"><a href="em.html#cb480-38"></a>  <span class="cf">while</span> (<span class="op">!</span>converged <span class="op">&amp;</span><span class="st"> </span>it <span class="op">&lt;</span><span class="st"> </span>maxits) { </span>
<span id="cb480-39"><a href="em.html#cb480-39"></a>    probsOld =<span class="st"> </span>probs</span>
<span id="cb480-40"><a href="em.html#cb480-40"></a>    <span class="co"># muOld = mu                # Use direct values or loglike for convergence check</span></span>
<span id="cb480-41"><a href="em.html#cb480-41"></a>    <span class="co"># varOld = var</span></span>
<span id="cb480-42"><a href="em.html#cb480-42"></a>    llOld =<span class="st"> </span>ll</span>
<span id="cb480-43"><a href="em.html#cb480-43"></a>    riOld =<span class="st"> </span>ri</span>
<span id="cb480-44"><a href="em.html#cb480-44"></a>    </span>
<span id="cb480-45"><a href="em.html#cb480-45"></a>    <span class="co">### E</span></span>
<span id="cb480-46"><a href="em.html#cb480-46"></a>    <span class="co"># Compute responsibilities</span></span>
<span id="cb480-47"><a href="em.html#cb480-47"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>clusters){</span>
<span id="cb480-48"><a href="em.html#cb480-48"></a>      ri[,k] =<span class="st"> </span>probs[k] <span class="op">*</span><span class="st"> </span><span class="kw">dmvnorm</span>(X, mu[k, ], <span class="dt">sigma =</span> var[[k]], <span class="dt">log =</span> <span class="ot">FALSE</span>)</span>
<span id="cb480-49"><a href="em.html#cb480-49"></a>    }</span>
<span id="cb480-50"><a href="em.html#cb480-50"></a>    </span>
<span id="cb480-51"><a href="em.html#cb480-51"></a>    ri =<span class="st"> </span>ri<span class="op">/</span><span class="kw">rowSums</span>(ri)</span>
<span id="cb480-52"><a href="em.html#cb480-52"></a>    </span>
<span id="cb480-53"><a href="em.html#cb480-53"></a>    <span class="co">### M</span></span>
<span id="cb480-54"><a href="em.html#cb480-54"></a>    rk =<span class="st"> </span><span class="kw">colSums</span>(ri)            <span class="co"># rk is weighted average cluster membership size</span></span>
<span id="cb480-55"><a href="em.html#cb480-55"></a>    probs =<span class="st"> </span>rk<span class="op">/</span>N</span>
<span id="cb480-56"><a href="em.html#cb480-56"></a>    </span>
<span id="cb480-57"><a href="em.html#cb480-57"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>clusters){</span>
<span id="cb480-58"><a href="em.html#cb480-58"></a>      varmat =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">ncol =</span> <span class="kw">ncol</span>(X), <span class="dt">nrow =</span> <span class="kw">ncol</span>(X))    <span class="co"># initialize to sum matrices</span></span>
<span id="cb480-59"><a href="em.html#cb480-59"></a>      </span>
<span id="cb480-60"><a href="em.html#cb480-60"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>N){</span>
<span id="cb480-61"><a href="em.html#cb480-61"></a>        varmat =<span class="st"> </span>varmat <span class="op">+</span><span class="st"> </span>ri[i,k] <span class="op">*</span><span class="st"> </span>X[i,]<span class="op">%*%</span><span class="kw">t</span>(X[i,])</span>
<span id="cb480-62"><a href="em.html#cb480-62"></a>      }</span>
<span id="cb480-63"><a href="em.html#cb480-63"></a>      </span>
<span id="cb480-64"><a href="em.html#cb480-64"></a>      mu[k,]   =<span class="st"> </span>(<span class="kw">t</span>(X) <span class="op">%*%</span><span class="st"> </span>ri[,k]) <span class="op">/</span><span class="st"> </span>rk[k]</span>
<span id="cb480-65"><a href="em.html#cb480-65"></a>      var[[k]] =<span class="st">  </span>varmat<span class="op">/</span>rk[k] <span class="op">-</span><span class="st"> </span>mu[k,]<span class="op">%*%</span><span class="kw">t</span>(mu[k,])</span>
<span id="cb480-66"><a href="em.html#cb480-66"></a>      </span>
<span id="cb480-67"><a href="em.html#cb480-67"></a>      ll[k] =<span class="st"> </span><span class="fl">-.5</span><span class="op">*</span><span class="kw">sum</span>( ri[,k] <span class="op">*</span><span class="st"> </span><span class="kw">dmvnorm</span>(X, mu[k,], <span class="dt">sigma =</span> var[[k]], <span class="dt">log =</span> <span class="ot">TRUE</span>) )</span>
<span id="cb480-68"><a href="em.html#cb480-68"></a>    }</span>
<span id="cb480-69"><a href="em.html#cb480-69"></a>    </span>
<span id="cb480-70"><a href="em.html#cb480-70"></a>    ll =<span class="st"> </span><span class="kw">sum</span>(ll)</span>
<span id="cb480-71"><a href="em.html#cb480-71"></a>    </span>
<span id="cb480-72"><a href="em.html#cb480-72"></a>    <span class="co">### compare old to current for convergence</span></span>
<span id="cb480-73"><a href="em.html#cb480-73"></a>    parmlistold =<span class="st">  </span><span class="kw">c</span>(llOld, probsOld)           <span class="co"># c(muOld, unlist(varOld), probsOld)</span></span>
<span id="cb480-74"><a href="em.html#cb480-74"></a>    parmlistcurrent =<span class="st"> </span><span class="kw">c</span>(ll, probs)              <span class="co"># c(mu, unlist(var), probs)</span></span>
<span id="cb480-75"><a href="em.html#cb480-75"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb480-76"><a href="em.html#cb480-76"></a>    </span>
<span id="cb480-77"><a href="em.html#cb480-77"></a>    <span class="co"># if showits true, &amp; it =1 or modulo of 5 print message</span></span>
<span id="cb480-78"><a href="em.html#cb480-78"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)         </span>
<span id="cb480-79"><a href="em.html#cb480-79"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb480-80"><a href="em.html#cb480-80"></a>    </span>
<span id="cb480-81"><a href="em.html#cb480-81"></a>    converged =<span class="st"> </span><span class="kw">min</span>(<span class="kw">abs</span>(parmlistold <span class="op">-</span><span class="st"> </span>parmlistcurrent)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb480-82"><a href="em.html#cb480-82"></a>  }</span>
<span id="cb480-83"><a href="em.html#cb480-83"></a>  </span>
<span id="cb480-84"><a href="em.html#cb480-84"></a>  clust =<span class="st"> </span><span class="kw">which</span>(<span class="kw">round</span>(ri) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">arr.ind =</span> <span class="ot">TRUE</span>)        <span class="co"># create cluster membership</span></span>
<span id="cb480-85"><a href="em.html#cb480-85"></a>  clust =<span class="st"> </span>clust[<span class="kw">order</span>(clust[,<span class="dv">1</span>]), <span class="dv">2</span>]            <span class="co"># order accoring to row rather than cluster</span></span>
<span id="cb480-86"><a href="em.html#cb480-86"></a>  out =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb480-87"><a href="em.html#cb480-87"></a>    <span class="dt">probs   =</span> probs,</span>
<span id="cb480-88"><a href="em.html#cb480-88"></a>    <span class="dt">mu      =</span> mu,</span>
<span id="cb480-89"><a href="em.html#cb480-89"></a>    <span class="dt">var     =</span> var,</span>
<span id="cb480-90"><a href="em.html#cb480-90"></a>    <span class="dt">resp    =</span> ri,</span>
<span id="cb480-91"><a href="em.html#cb480-91"></a>    <span class="dt">cluster =</span> clust,</span>
<span id="cb480-92"><a href="em.html#cb480-92"></a>    <span class="dt">ll      =</span> ll</span>
<span id="cb480-93"><a href="em.html#cb480-93"></a>  )</span>
<span id="cb480-94"><a href="em.html#cb480-94"></a>  </span>
<span id="cb480-95"><a href="em.html#cb480-95"></a>  out</span>
<span id="cb480-96"><a href="em.html#cb480-96"></a>} </span></code></pre></div>
</div>
<div id="example-1-old-faithful-eruptions" class="section level3">
<h3>Example 1: Old Faithful eruptions</h3>
<p>This example uses Old Faithful geyser eruptions. This is can be compared to the univariate code from the <a href="em.html#mixture-model">other chapter</a>. See also <a href="http://www.geyserstudy.org/geyser.aspx?pGeyserNo=OLDFAITHFUL" class="uri">http://www.geyserstudy.org/geyser.aspx?pGeyserNo=OLDFAITHFUL</a></p>
<div id="data-setup-29" class="section level4">
<h4>Data Setup</h4>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="em.html#cb481-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb481-2"><a href="em.html#cb481-2"></a></span>
<span id="cb481-3"><a href="em.html#cb481-3"></a><span class="kw">data</span>(<span class="st">&quot;faithful&quot;</span>)</span></code></pre></div>
</div>
<div id="estimation-24" class="section level4">
<h4>Estimation</h4>
<p>Create starting values and estimate.</p>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="em.html#cb482-1"></a>mustart  =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">60</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">60.1</span>))    <span class="co"># must be at least slightly different</span></span>
<span id="cb482-2"><a href="em.html#cb482-2"></a>covstart =<span class="st"> </span><span class="kw">list</span>(<span class="kw">cov</span>(faithful), <span class="kw">cov</span>(faithful))</span>
<span id="cb482-3"><a href="em.html#cb482-3"></a>probs    =<span class="st"> </span><span class="kw">c</span>(.<span class="dv">01</span>, <span class="fl">.99</span>)</span>
<span id="cb482-4"><a href="em.html#cb482-4"></a></span>
<span id="cb482-5"><a href="em.html#cb482-5"></a><span class="co"># params is a list of mu, var, and probs </span></span>
<span id="cb482-6"><a href="em.html#cb482-6"></a>starts =<span class="st"> </span><span class="kw">list</span>(<span class="dt">mu =</span> mustart, <span class="dt">var =</span> covstart, <span class="dt">probs =</span> probs)  </span></code></pre></div>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb483-1"><a href="em.html#cb483-1"></a>mix_faithful =<span class="st"> </span><span class="kw">em_mixture</span>(</span>
<span id="cb483-2"><a href="em.html#cb483-2"></a>  <span class="dt">params =</span> starts,</span>
<span id="cb483-3"><a href="em.html#cb483-3"></a>  <span class="dt">X =</span> <span class="kw">as.matrix</span>(faithful),</span>
<span id="cb483-4"><a href="em.html#cb483-4"></a>  <span class="dt">clusters =</span> <span class="dv">2</span>,</span>
<span id="cb483-5"><a href="em.html#cb483-5"></a>  <span class="dt">tol      =</span> <span class="fl">1e-12</span>,</span>
<span id="cb483-6"><a href="em.html#cb483-6"></a>  <span class="dt">maxits   =</span> <span class="dv">1500</span>,</span>
<span id="cb483-7"><a href="em.html#cb483-7"></a>  <span class="dt">showits  =</span> <span class="ot">TRUE</span></span>
<span id="cb483-8"><a href="em.html#cb483-8"></a>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
5...
10...
15...
20...
25...
30...
35...
40...
45...
50...
55...
60...
65...
70...
75...
80...</code></pre>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb485-1"><a href="em.html#cb485-1"></a><span class="kw">str</span>(mix_faithful)</span></code></pre></div>
<pre><code>List of 6
 $ probs  : num [1:2] 0.356 0.644
 $ mu     : num [1:2, 1:2] 2.04 4.29 54.48 79.97
 $ var    :List of 2
  ..$ : num [1:2, 1:2] 0.0692 0.4352 0.4352 33.6973
  .. ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] &quot;eruptions&quot; &quot;waiting&quot;
  ..$ : num [1:2, 1:2] 0.17 0.941 0.941 36.046
  .. ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] &quot;eruptions&quot; &quot;waiting&quot;
 $ resp   : num [1:272, 1:2] 2.59e-09 1.00 8.42e-06 1.00 1.00e-21 ...
 $ cluster: int [1:272] 2 1 2 1 2 1 2 2 1 2 ...
 $ ll     : num 477</code></pre>
<p>Visualize.</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb487-1"><a href="em.html#cb487-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb487-2"><a href="em.html#cb487-2"></a></span>
<span id="cb487-3"><a href="em.html#cb487-3"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting), <span class="dt">data =</span> faithful) <span class="op">+</span></span>
<span id="cb487-4"><a href="em.html#cb487-4"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">factor</span>(mix_faithful<span class="op">$</span>cluster))) <span class="op">+</span></span>
<span id="cb487-5"><a href="em.html#cb487-5"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/mixmv-vis1-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb488-1"><a href="em.html#cb488-1"></a>faithful <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb488-2"><a href="em.html#cb488-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob_clus_1 =</span> mix_faithful<span class="op">$</span>resp[, <span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb488-3"><a href="em.html#cb488-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting)) <span class="op">+</span></span>
<span id="cb488-4"><a href="em.html#cb488-4"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> prob_clus_<span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb488-5"><a href="em.html#cb488-5"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/mixmv-vis1-2.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb489-1"><a href="em.html#cb489-1"></a><span class="co"># relatively speaking, these are extremely well-separated clusters</span></span>
<span id="cb489-2"><a href="em.html#cb489-2"></a>worst =<span class="st"> </span><span class="kw">apply</span>(mix_faithful<span class="op">$</span>resp, <span class="dv">1</span>, <span class="cf">function</span>(x)  <span class="kw">max</span>(x) <span class="op">&lt;</span><span class="st"> </span><span class="fl">.99</span>) </span>
<span id="cb489-3"><a href="em.html#cb489-3"></a></span>
<span id="cb489-4"><a href="em.html#cb489-4"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> eruptions, <span class="dt">y =</span> waiting), <span class="dt">data =</span> faithful) <span class="op">+</span></span>
<span id="cb489-5"><a href="em.html#cb489-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> worst)) <span class="op">+</span></span>
<span id="cb489-6"><a href="em.html#cb489-6"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/mixmv-vis1-3.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="comparison-31" class="section level4">
<h4>Comparison</h4>
<p>Compare to <span class="pack" style="">mclust</span> results.</p>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb490-1"><a href="em.html#cb490-1"></a><span class="kw">library</span>(mclust)</span>
<span id="cb490-2"><a href="em.html#cb490-2"></a></span>
<span id="cb490-3"><a href="em.html#cb490-3"></a><span class="co"># options are set to be more similar</span></span>
<span id="cb490-4"><a href="em.html#cb490-4"></a>mix_mclust =<span class="st"> </span><span class="kw">Mclust</span>(</span>
<span id="cb490-5"><a href="em.html#cb490-5"></a>  faithful[, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>],</span>
<span id="cb490-6"><a href="em.html#cb490-6"></a>  <span class="dv">2</span>,</span>
<span id="cb490-7"><a href="em.html#cb490-7"></a>  <span class="dt">modelNames =</span> <span class="st">&#39;VVV&#39;</span>,</span>
<span id="cb490-8"><a href="em.html#cb490-8"></a>  <span class="dt">control =</span> <span class="kw">emControl</span>(<span class="dt">tol =</span> <span class="fl">1e-12</span>)</span>
<span id="cb490-9"><a href="em.html#cb490-9"></a>)</span>
<span id="cb490-10"><a href="em.html#cb490-10"></a></span>
<span id="cb490-11"><a href="em.html#cb490-11"></a><span class="kw">str</span>(mix_mclust, <span class="dv">1</span>)</span></code></pre></div>
<pre><code>List of 16
 $ call          : language Mclust(data = faithful[, 1:2], G = 2, modelNames = &quot;VVV&quot;, control = emControl(tol = 1e-12))
 $ data          : num [1:272, 1:2] 3.6 1.8 3.33 2.28 4.53 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
 $ modelName     : chr &quot;VVV&quot;
 $ n             : int 272
 $ d             : int 2
 $ G             : int 2
 $ BIC           : &#39;mclustBIC&#39; num [1, 1] -2322
  ..- attr(*, &quot;dimnames&quot;)=List of 2
  ..- attr(*, &quot;G&quot;)= num 2
  ..- attr(*, &quot;modelNames&quot;)= chr &quot;VVV&quot;
  ..- attr(*, &quot;control&quot;)=List of 4
  ..- attr(*, &quot;initialization&quot;)=List of 3
  ..- attr(*, &quot;warn&quot;)= logi FALSE
  ..- attr(*, &quot;n&quot;)= int 272
  ..- attr(*, &quot;d&quot;)= int 2
  ..- attr(*, &quot;oneD&quot;)= logi FALSE
  ..- attr(*, &quot;criterion&quot;)= chr &quot;BIC&quot;
  ..- attr(*, &quot;returnCodes&quot;)= num [1, 1] 0
  .. ..- attr(*, &quot;dimnames&quot;)=List of 2
 $ loglik        : num -1130
 $ df            : num 11
 $ bic           : num -2322
 $ icl           : num -2323
 $ hypvol        : num NA
 $ parameters    :List of 4
 $ z             : num [1:272, 1:2] 1.00 1.91e-09 1.00 1.07e-05 1.00 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
 $ classification: Named num [1:272] 1 2 1 2 1 2 1 1 2 1 ...
  ..- attr(*, &quot;names&quot;)= chr [1:272] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
 $ uncertainty   : Named num [1:272] 2.59e-09 1.91e-09 8.42e-06 1.07e-05 0.00 ...
  ..- attr(*, &quot;names&quot;)= chr [1:272] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
 - attr(*, &quot;class&quot;)= chr &quot;Mclust&quot;</code></pre>
<div class="sourceCode" id="cb492"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb492-1"><a href="em.html#cb492-1"></a><span class="co"># compare means</span></span>
<span id="cb492-2"><a href="em.html#cb492-2"></a><span class="kw">t</span>(mix_faithful<span class="op">$</span>mu)</span></code></pre></div>
<pre><code>          [,1]      [,2]
[1,]  2.036388  4.289662
[2,] 54.478516 79.968115</code></pre>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb494-1"><a href="em.html#cb494-1"></a>mix_mclust<span class="op">$</span>parameters<span class="op">$</span>mean</span></code></pre></div>
<pre><code>               [,1]      [,2]
eruptions  4.289662  2.036388
waiting   79.968115 54.478517</code></pre>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb496-1"><a href="em.html#cb496-1"></a><span class="co"># compare variances</span></span>
<span id="cb496-2"><a href="em.html#cb496-2"></a>mix_faithful<span class="op">$</span>var</span></code></pre></div>
<pre><code>[[1]]
      eruptions    waiting
[1,] 0.06916767  0.4351676
[2,] 0.43516762 33.6972821

[[2]]
     eruptions    waiting
[1,] 0.1699684  0.9406093
[2,] 0.9406093 36.0462113</code></pre>
<div class="sourceCode" id="cb498"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb498-1"><a href="em.html#cb498-1"></a>mix_mclust<span class="op">$</span>parameters<span class="op">$</span>variance<span class="op">$</span>sigma</span></code></pre></div>
<pre><code>, , 1

          eruptions    waiting
eruptions 0.1699684  0.9406089
waiting   0.9406089 36.0462071

, , 2

           eruptions    waiting
eruptions 0.06916769  0.4351678
waiting   0.43516784 33.6972835</code></pre>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb500-1"><a href="em.html#cb500-1"></a><span class="co"># compare classifications, reverse in case arbitrary numbering of one of them is opposite</span></span>
<span id="cb500-2"><a href="em.html#cb500-2"></a><span class="kw">table</span>(mix_faithful<span class="op">$</span>cluster, mix_mclust<span class="op">$</span>classification)</span></code></pre></div>
<pre><code>   
      1   2
  1   0  97
  2 175   0</code></pre>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb502-1"><a href="em.html#cb502-1"></a><span class="kw">table</span>(<span class="kw">ifelse</span>(mix_faithful<span class="op">$</span>cluster <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb502-2"><a href="em.html#cb502-2"></a>      mix_mclust<span class="op">$</span>classification)</span></code></pre></div>
<pre><code>   
      1   2
  1 175   0
  2   0  97</code></pre>
<div class="sourceCode" id="cb504"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb504-1"><a href="em.html#cb504-1"></a><span class="co"># compare responsibilities; reverse one if arbitrary numbering of one of them is opposite</span></span>
<span id="cb504-2"><a href="em.html#cb504-2"></a><span class="co"># cbind(round(mix_faithful$resp[,1], 2), round(mix_mclust$z[,2], 2)) # cluster &#39;1&#39;</span></span>
<span id="cb504-3"><a href="em.html#cb504-3"></a><span class="co"># cbind(round(mix_faithful$resp[,2], 2), round(mix_mclust$z[,1], 2)) # cluster &#39;2&#39;</span></span></code></pre></div>
</div>
</div>
<div id="example-2-iris-data-set" class="section level3">
<h3>Example 2: Iris data set</h3>
<div id="data-setup-30" class="section level4">
<h4>Data Setup</h4>
<p>Set up data</p>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb505-1"><a href="em.html#cb505-1"></a>iris2 =<span class="st"> </span>iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>Species)</span></code></pre></div>
</div>
<div id="estimation-25" class="section level4">
<h4>Estimation</h4>
<p>Run and examine. We add noise to our starting value, and the function is notably sensitive to starts, but don’t want to cheat too badly.</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb506-1"><a href="em.html#cb506-1"></a>mustart =<span class="st"> </span>iris <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-2"><a href="em.html#cb506-2"></a><span class="st">  </span><span class="kw">group_by</span>(Species) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-3"><a href="em.html#cb506-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(<span class="dt">.fns =</span> <span class="cf">function</span>(x) <span class="kw">mean</span>(x) <span class="op">+</span><span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">.5</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-4"><a href="em.html#cb506-4"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>Species) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-5"><a href="em.html#cb506-5"></a><span class="st">  </span><span class="kw">as.matrix</span>()</span>
<span id="cb506-6"><a href="em.html#cb506-6"></a></span>
<span id="cb506-7"><a href="em.html#cb506-7"></a></span>
<span id="cb506-8"><a href="em.html#cb506-8"></a><span class="co"># use purrr::map due to mclust::map</span></span>
<span id="cb506-9"><a href="em.html#cb506-9"></a>covstart =<span class="st"> </span>iris <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-10"><a href="em.html#cb506-10"></a><span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>Species) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-11"><a href="em.html#cb506-11"></a><span class="st">  </span>purrr<span class="op">::</span><span class="kw">map</span>(select, <span class="op">-</span>Species) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb506-12"><a href="em.html#cb506-12"></a><span class="st">  </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="cf">function</span>(x) <span class="kw">cov</span>(x) <span class="op">+</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">runif</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="fl">.5</span>))) </span>
<span id="cb506-13"><a href="em.html#cb506-13"></a></span>
<span id="cb506-14"><a href="em.html#cb506-14"></a>probs =<span class="st"> </span><span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.2</span>, <span class="fl">.7</span>)</span>
<span id="cb506-15"><a href="em.html#cb506-15"></a></span>
<span id="cb506-16"><a href="em.html#cb506-16"></a>starts =<span class="st"> </span><span class="kw">list</span>(<span class="dt">mu =</span> mustart, <span class="dt">var =</span> covstart, <span class="dt">probs =</span> probs)</span></code></pre></div>
<div class="sourceCode" id="cb507"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb507-1"><a href="em.html#cb507-1"></a>mix_mclust_iris =<span class="st"> </span><span class="kw">em_mixture</span>(</span>
<span id="cb507-2"><a href="em.html#cb507-2"></a>  <span class="dt">params =</span> starts,</span>
<span id="cb507-3"><a href="em.html#cb507-3"></a>  <span class="dt">X =</span> <span class="kw">as.matrix</span>(iris2),</span>
<span id="cb507-4"><a href="em.html#cb507-4"></a>  <span class="dt">clusters =</span> <span class="dv">3</span>,</span>
<span id="cb507-5"><a href="em.html#cb507-5"></a>  <span class="dt">tol      =</span> <span class="fl">1e-8</span>,</span>
<span id="cb507-6"><a href="em.html#cb507-6"></a>  <span class="dt">maxits   =</span> <span class="dv">1500</span>,</span>
<span id="cb507-7"><a href="em.html#cb507-7"></a>  <span class="dt">showits  =</span> T</span>
<span id="cb507-8"><a href="em.html#cb507-8"></a>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...</code></pre>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb509-1"><a href="em.html#cb509-1"></a><span class="kw">table</span>(mix_mclust_iris<span class="op">$</span>cluster, iris<span class="op">$</span>Species)</span></code></pre></div>
<pre><code>   
    setosa versicolor virginica
  1     50          0         0
  2      0         48         0
  3      0          2        50</code></pre>
</div>
<div id="comparison-32" class="section level4">
<h4>Comparison</h4>
<p>Compare to mclust results.</p>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb511-1"><a href="em.html#cb511-1"></a>mclust_iris =<span class="st"> </span><span class="kw">Mclust</span>(iris[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>], <span class="dv">3</span>)</span>
<span id="cb511-2"><a href="em.html#cb511-2"></a><span class="kw">table</span>(mclust_iris<span class="op">$</span>classification, iris<span class="op">$</span>Species)</span></code></pre></div>
<pre><code>   
    setosa versicolor virginica
  1     50          0         0
  2      0         45         0
  3      0          5        50</code></pre>
</div>
</div>
<div id="source-29" class="section level3">
<h3>Source</h3>
<p>Original code available at
<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20Mixture%20MV.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20Mixture%20MV.R</a></p>
</div>
</div>
<div id="probit-model" class="section level2">
<h2>Probit Model</h2>
<p>The following regards models for a binary response. See Murphy, 2012 Probabilistic Machine Learning Chapter 11.4.</p>
<div id="data-setup-31" class="section level3">
<h3>Data Setup</h3>
<div class="sourceCode" id="cb513"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb513-1"><a href="em.html#cb513-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb513-2"><a href="em.html#cb513-2"></a></span>
<span id="cb513-3"><a href="em.html#cb513-3"></a>admission =<span class="st"> </span>haven<span class="op">::</span><span class="kw">read_dta</span>(<span class="st">&quot;https://stats.idre.ucla.edu/stat/stata/dae/binary.dta&quot;</span>)</span></code></pre></div>
</div>
<div id="probit-via-maximum-likelihood" class="section level3">
<h3>Probit via Maximum Likelihood</h3>
<div id="function-22" class="section level4">
<h4>Function</h4>
<p>We’ll start with the a basic maximum likelihood function for a standard probit. See the [logistic regression][Standard Logistic] example as comparison.</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb514-1"><a href="em.html#cb514-1"></a>probit_mle =<span class="st"> </span><span class="cf">function</span>(params, X, y){</span>
<span id="cb514-2"><a href="em.html#cb514-2"></a>  <span class="co"># Arguments are starting parameters (coefficients), model matrix, response </span></span>
<span id="cb514-3"><a href="em.html#cb514-3"></a>  </span>
<span id="cb514-4"><a href="em.html#cb514-4"></a>  b =<span class="st"> </span>params</span>
<span id="cb514-5"><a href="em.html#cb514-5"></a>  mu =<span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>b    <span class="co"># linear predictor</span></span>
<span id="cb514-6"><a href="em.html#cb514-6"></a>  </span>
<span id="cb514-7"><a href="em.html#cb514-7"></a>  <span class="co"># compute the log likelihood either way</span></span>
<span id="cb514-8"><a href="em.html#cb514-8"></a>  <span class="co"># ll = sum(y * pnorm(mu, log.p = TRUE) + (1 - y) * pnorm(-mu, log.p = TRUE))  </span></span>
<span id="cb514-9"><a href="em.html#cb514-9"></a>  ll =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dbinom</span>(y, <span class="dv">1</span>, <span class="dt">prob =</span> <span class="kw">pnorm</span>(mu), <span class="dt">log =</span> <span class="ot">TRUE</span>))</span>
<span id="cb514-10"><a href="em.html#cb514-10"></a>  </span>
<span id="cb514-11"><a href="em.html#cb514-11"></a>  <span class="op">-</span>ll</span>
<span id="cb514-12"><a href="em.html#cb514-12"></a>}</span></code></pre></div>
</div>
<div id="estimation-26" class="section level4">
<h4>Estimation</h4>
<p>Estimate with <span class="func" style="">optim</span>.</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="em.html#cb515-1"></a><span class="co"># input data</span></span>
<span id="cb515-2"><a href="em.html#cb515-2"></a>X =<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">cbind</span>(<span class="dv">1</span>, admission[, <span class="dv">2</span><span class="op">:</span><span class="dv">4</span>]))</span>
<span id="cb515-3"><a href="em.html#cb515-3"></a>y =<span class="st"> </span><span class="kw">as.matrix</span>(admission[, <span class="dv">1</span>])</span>
<span id="cb515-4"><a href="em.html#cb515-4"></a>init =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb515-5"><a href="em.html#cb515-5"></a></span>
<span id="cb515-6"><a href="em.html#cb515-6"></a><span class="co"># Can set tolerance really low to duplicate glm result</span></span>
<span id="cb515-7"><a href="em.html#cb515-7"></a>result_mle =<span class="st"> </span><span class="kw">optim</span>(</span>
<span id="cb515-8"><a href="em.html#cb515-8"></a>  <span class="dt">par =</span> init,</span>
<span id="cb515-9"><a href="em.html#cb515-9"></a>  <span class="dt">fn  =</span> probit_mle,</span>
<span id="cb515-10"><a href="em.html#cb515-10"></a>  <span class="dt">X   =</span> X,</span>
<span id="cb515-11"><a href="em.html#cb515-11"></a>  <span class="dt">y   =</span> y,</span>
<span id="cb515-12"><a href="em.html#cb515-12"></a>  <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">maxit =</span> <span class="dv">1000</span>, <span class="dt">reltol =</span> <span class="fl">1e-12</span>)</span>
<span id="cb515-13"><a href="em.html#cb515-13"></a>) </span>
<span id="cb515-14"><a href="em.html#cb515-14"></a></span>
<span id="cb515-15"><a href="em.html#cb515-15"></a><span class="co"># extract coefficients</span></span>
<span id="cb515-16"><a href="em.html#cb515-16"></a>coefs_mle =<span class="st"> </span>result_mle<span class="op">$</span>par</span></code></pre></div>
</div>
<div id="comparison-33" class="section level4">
<h4>Comparison</h4>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="em.html#cb516-1"></a>glm_probit =<span class="st"> </span><span class="kw">glm</span>(</span>
<span id="cb516-2"><a href="em.html#cb516-2"></a>  admit <span class="op">~</span><span class="st"> </span>gre <span class="op">+</span><span class="st"> </span>gpa <span class="op">+</span><span class="st"> </span>rank,</span>
<span id="cb516-3"><a href="em.html#cb516-3"></a>  <span class="dt">family  =</span> <span class="kw">binomial</span>(<span class="dt">link =</span> <span class="st">&quot;probit&quot;</span>),</span>
<span id="cb516-4"><a href="em.html#cb516-4"></a>  <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">maxit =</span> <span class="dv">500</span>, <span class="dt">epsilon =</span> <span class="fl">1e-8</span>),</span>
<span id="cb516-5"><a href="em.html#cb516-5"></a>  <span class="dt">data    =</span> admission</span>
<span id="cb516-6"><a href="em.html#cb516-6"></a>)</span>
<span id="cb516-7"><a href="em.html#cb516-7"></a></span>
<span id="cb516-8"><a href="em.html#cb516-8"></a></span>
<span id="cb516-9"><a href="em.html#cb516-9"></a><span class="kw">summary</span>(glm_probit)</span></code></pre></div>
<pre><code>
Call:
glm(formula = admit ~ gre + gpa + rank, family = binomial(link = &quot;probit&quot;), 
    data = admission, control = list(maxit = 500, epsilon = 1e-08))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.5626  -0.8920  -0.6403   1.1631   2.2097  

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -2.0915039  0.6718360  -3.113  0.00185 ** 
gre          0.0013982  0.0006487   2.156  0.03112 *  
gpa          0.4643599  0.1950263   2.381  0.01727 *  
rank        -0.3317117  0.0745524  -4.449 8.61e-06 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 499.98  on 399  degrees of freedom
Residual deviance: 459.48  on 396  degrees of freedom
AIC: 467.48

Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb518-1"><a href="em.html#cb518-1"></a>coefs_glm =<span class="st"> </span><span class="kw">coef</span>(glm_probit)</span></code></pre></div>
<p>Compare.</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb519-1"><a href="em.html#cb519-1"></a><span class="kw">rbind</span>(coefs_mle, coefs_glm)</span></code></pre></div>
<pre><code>          (Intercept)         gre       gpa       rank
coefs_mle   -2.091510 0.001398222 0.4643609 -0.3317105
coefs_glm   -2.091504 0.001398222 0.4643599 -0.3317117</code></pre>
</div>
</div>
<div id="em-for-latent-variable-approach-to-probit" class="section level3">
<h3>EM for Latent Variable Approach to Probit</h3>
<div id="function-23" class="section level4">
<h4>Function</h4>
<div class="sourceCode" id="cb521"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb521-1"><a href="em.html#cb521-1"></a>em_probit =<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb521-2"><a href="em.html#cb521-2"></a>  params,</span>
<span id="cb521-3"><a href="em.html#cb521-3"></a>  X,</span>
<span id="cb521-4"><a href="em.html#cb521-4"></a>  y,</span>
<span id="cb521-5"><a href="em.html#cb521-5"></a>  <span class="dt">tol =</span> <span class="fl">.00001</span>,</span>
<span id="cb521-6"><a href="em.html#cb521-6"></a>  <span class="dt">maxits  =</span> <span class="dv">100</span>,</span>
<span id="cb521-7"><a href="em.html#cb521-7"></a>  <span class="dt">showits =</span> <span class="ot">TRUE</span></span>
<span id="cb521-8"><a href="em.html#cb521-8"></a>) {</span>
<span id="cb521-9"><a href="em.html#cb521-9"></a>  </span>
<span id="cb521-10"><a href="em.html#cb521-10"></a>  <span class="co"># Arguments are starting parameters (coefficients), model matrix, response, </span></span>
<span id="cb521-11"><a href="em.html#cb521-11"></a>  <span class="co"># tolerance, maximum iterations, and whether to show iterations</span></span>
<span id="cb521-12"><a href="em.html#cb521-12"></a></span>
<span id="cb521-13"><a href="em.html#cb521-13"></a>  <span class="co">#starting points</span></span>
<span id="cb521-14"><a href="em.html#cb521-14"></a>  b  =<span class="st"> </span>params</span>
<span id="cb521-15"><a href="em.html#cb521-15"></a>  mu =<span class="st"> </span>X<span class="op">%*%</span>b</span>
<span id="cb521-16"><a href="em.html#cb521-16"></a>  it =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb521-17"><a href="em.html#cb521-17"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb521-18"><a href="em.html#cb521-18"></a>  z =<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(y))    <span class="co"># z is the latent variable ~N(0,1)</span></span>
<span id="cb521-19"><a href="em.html#cb521-19"></a>  </span>
<span id="cb521-20"><a href="em.html#cb521-20"></a>  <span class="co"># Show iterations</span></span>
<span id="cb521-21"><a href="em.html#cb521-21"></a>  <span class="cf">if</span> (showits)                                                            </span>
<span id="cb521-22"><a href="em.html#cb521-22"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb521-23"><a href="em.html#cb521-23"></a>  </span>
<span id="cb521-24"><a href="em.html#cb521-24"></a>  <span class="co"># while no convergence and we haven&#39;t reached our max iterations do this stuff</span></span>
<span id="cb521-25"><a href="em.html#cb521-25"></a>  <span class="cf">while</span> ((<span class="op">!</span>converged) <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">&lt;</span><span class="st"> </span>maxits)) {                                 </span>
<span id="cb521-26"><a href="em.html#cb521-26"></a>    z_old =<span class="st"> </span>z       <span class="co"># create &#39;old&#39; values for comparison</span></span>
<span id="cb521-27"><a href="em.html#cb521-27"></a>    </span>
<span id="cb521-28"><a href="em.html#cb521-28"></a>    <span class="co"># E step create a new z based on current values</span></span>
<span id="cb521-29"><a href="em.html#cb521-29"></a>    z =<span class="st"> </span><span class="kw">ifelse</span>(</span>
<span id="cb521-30"><a href="em.html#cb521-30"></a>      y <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, </span>
<span id="cb521-31"><a href="em.html#cb521-31"></a>      mu <span class="op">+</span><span class="st"> </span><span class="kw">dnorm</span>(mu) <span class="op">/</span><span class="st"> </span><span class="kw">pnorm</span>(mu), </span>
<span id="cb521-32"><a href="em.html#cb521-32"></a>      mu <span class="op">-</span><span class="st"> </span><span class="kw">dnorm</span>(mu) <span class="op">/</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="op">-</span>mu)</span>
<span id="cb521-33"><a href="em.html#cb521-33"></a>    )     </span>
<span id="cb521-34"><a href="em.html#cb521-34"></a>    </span>
<span id="cb521-35"><a href="em.html#cb521-35"></a>    <span class="co"># M step estimate b</span></span>
<span id="cb521-36"><a href="em.html#cb521-36"></a>    b =<span class="st"> </span><span class="kw">solve</span>(<span class="kw">t</span>(X)<span class="op">%*%</span>X) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(X)<span class="op">%*%</span>z                                     </span>
<span id="cb521-37"><a href="em.html#cb521-37"></a>    mu =<span class="st"> </span>X<span class="op">%*%</span>b</span>
<span id="cb521-38"><a href="em.html#cb521-38"></a>    </span>
<span id="cb521-39"><a href="em.html#cb521-39"></a>    ll =<span class="st"> </span><span class="kw">sum</span>(y <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(mu, <span class="dt">log.p =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>y) <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="op">-</span>mu, <span class="dt">log.p =</span> <span class="ot">TRUE</span>))</span>
<span id="cb521-40"><a href="em.html#cb521-40"></a>    </span>
<span id="cb521-41"><a href="em.html#cb521-41"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb521-42"><a href="em.html#cb521-42"></a>    </span>
<span id="cb521-43"><a href="em.html#cb521-43"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))</span>
<span id="cb521-44"><a href="em.html#cb521-44"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb521-45"><a href="em.html#cb521-45"></a>    </span>
<span id="cb521-46"><a href="em.html#cb521-46"></a>    converged =<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(z_old <span class="op">-</span><span class="st"> </span>z)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb521-47"><a href="em.html#cb521-47"></a>  }</span>
<span id="cb521-48"><a href="em.html#cb521-48"></a>  </span>
<span id="cb521-49"><a href="em.html#cb521-49"></a>  <span class="co"># Show last iteration</span></span>
<span id="cb521-50"><a href="em.html#cb521-50"></a>  <span class="cf">if</span> (showits)                                                            </span>
<span id="cb521-51"><a href="em.html#cb521-51"></a>    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb521-52"><a href="em.html#cb521-52"></a>  </span>
<span id="cb521-53"><a href="em.html#cb521-53"></a>  <span class="kw">list</span>(<span class="dt">b =</span> <span class="kw">t</span>(b), <span class="dt">ll =</span> ll)</span>
<span id="cb521-54"><a href="em.html#cb521-54"></a>}</span></code></pre></div>
</div>
<div id="estimation-27" class="section level4">
<h4>Estimation</h4>
<p>Use the same setup and starting values to estimate the parameters.</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="em.html#cb522-1"></a><span class="co"># can lower tolerance to duplicate glm result</span></span>
<span id="cb522-2"><a href="em.html#cb522-2"></a>result_em =<span class="st"> </span><span class="kw">em_probit</span>(</span>
<span id="cb522-3"><a href="em.html#cb522-3"></a>  <span class="dt">params =</span> init,</span>
<span id="cb522-4"><a href="em.html#cb522-4"></a>  <span class="dt">X      =</span> X,</span>
<span id="cb522-5"><a href="em.html#cb522-5"></a>  <span class="dt">y      =</span> y,</span>
<span id="cb522-6"><a href="em.html#cb522-6"></a>  <span class="dt">tol    =</span> <span class="fl">1e-12</span>,</span>
<span id="cb522-7"><a href="em.html#cb522-7"></a>  <span class="dt">maxit  =</span> <span class="dv">100</span></span>
<span id="cb522-8"><a href="em.html#cb522-8"></a>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
5...
10...
15...
20...
25...
30...
35...
40...
45...
50...
51...</code></pre>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb524-1"><a href="em.html#cb524-1"></a><span class="co"># result_em  </span></span>
<span id="cb524-2"><a href="em.html#cb524-2"></a></span>
<span id="cb524-3"><a href="em.html#cb524-3"></a>coefs_em =<span class="st"> </span>result_em<span class="op">$</span>b</span></code></pre></div>
</div>
<div id="comparison-34" class="section level4">
<h4>Comparison</h4>
<p>Compare all results.</p>
<div class="sourceCode" id="cb525"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb525-1"><a href="em.html#cb525-1"></a><span class="kw">rbind</span>(coefs_glm, coefs_mle, coefs_em)</span></code></pre></div>
<pre><code>          (Intercept)         gre       gpa       rank
coefs_glm   -2.091504 0.001398222 0.4643599 -0.3317117
coefs_mle   -2.091510 0.001398222 0.4643609 -0.3317105
admit       -2.091504 0.001398222 0.4643599 -0.3317117</code></pre>
<div class="sourceCode" id="cb527"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb527-1"><a href="em.html#cb527-1"></a><span class="kw">rbind</span>(<span class="kw">logLik</span>(glm_probit),  result<span class="op">$</span>value, result_em<span class="op">$</span>ll)</span></code></pre></div>
<pre><code>          [,1]
[1,] -229.7404
[2,]  844.4590
[3,] -229.7404</code></pre>
</div>
<div id="visualize-1" class="section level4">
<h4>Visualize</h4>
<p>Show estimates over niter iterations and visualize.</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb529-1"><a href="em.html#cb529-1"></a>X2 =<span class="st"> </span>X</span>
<span id="cb529-2"><a href="em.html#cb529-2"></a>X2[, <span class="dv">2</span><span class="op">:</span><span class="dv">3</span>] =<span class="st"> </span><span class="kw">scale</span>(X2[, <span class="dv">2</span><span class="op">:</span><span class="dv">3</span>])</span>
<span id="cb529-3"><a href="em.html#cb529-3"></a></span>
<span id="cb529-4"><a href="em.html#cb529-4"></a>niter =<span class="st"> </span><span class="dv">20</span></span>
<span id="cb529-5"><a href="em.html#cb529-5"></a></span>
<span id="cb529-6"><a href="em.html#cb529-6"></a>result_em =<span class="st"> </span><span class="kw">map_df</span>(<span class="dv">1</span><span class="op">:</span>niter, <span class="cf">function</span>(x)</span>
<span id="cb529-7"><a href="em.html#cb529-7"></a>  <span class="kw">as_tibble</span>(</span>
<span id="cb529-8"><a href="em.html#cb529-8"></a>    <span class="kw">em_probit</span>(</span>
<span id="cb529-9"><a href="em.html#cb529-9"></a>      <span class="dt">params  =</span> init,</span>
<span id="cb529-10"><a href="em.html#cb529-10"></a>      <span class="dt">X       =</span> X2,</span>
<span id="cb529-11"><a href="em.html#cb529-11"></a>      <span class="dt">y       =</span> y,</span>
<span id="cb529-12"><a href="em.html#cb529-12"></a>      <span class="dt">tol     =</span> <span class="fl">1e-8</span>,</span>
<span id="cb529-13"><a href="em.html#cb529-13"></a>      <span class="dt">maxit   =</span> x,</span>
<span id="cb529-14"><a href="em.html#cb529-14"></a>      <span class="dt">showits =</span> F</span>
<span id="cb529-15"><a href="em.html#cb529-15"></a>    )<span class="op">$</span>b)</span>
<span id="cb529-16"><a href="em.html#cb529-16"></a>)</span>
<span id="cb529-17"><a href="em.html#cb529-17"></a></span>
<span id="cb529-18"><a href="em.html#cb529-18"></a>gdat =<span class="st"> </span>result_em <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb529-19"><a href="em.html#cb529-19"></a><span class="st">  </span><span class="kw">rowid_to_column</span>(<span class="st">&#39;iter&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb529-20"><a href="em.html#cb529-20"></a><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>iter, <span class="dt">names_to =</span> <span class="st">&#39;coef&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb529-21"><a href="em.html#cb529-21"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb529-22"><a href="em.html#cb529-22"></a>    <span class="dt">coef =</span> <span class="kw">factor</span>(coef, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&#39;Intercept&#39;</span>, <span class="st">&#39;gre&#39;</span>, <span class="st">&#39;gpa&#39;</span>, <span class="st">&#39;rank&#39;</span>))</span>
<span id="cb529-23"><a href="em.html#cb529-23"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb529-24"><a href="em.html#cb529-24"></a><span class="st">  </span><span class="kw">arrange</span>(iter, coef)</span>
<span id="cb529-25"><a href="em.html#cb529-25"></a></span>
<span id="cb529-26"><a href="em.html#cb529-26"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> iter, <span class="dt">y =</span> value), <span class="dt">data =</span> gdat) <span class="op">+</span></span>
<span id="cb529-27"><a href="em.html#cb529-27"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> coef, <span class="dt">color =</span> coef)) <span class="op">+</span></span>
<span id="cb529-28"><a href="em.html#cb529-28"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/probit-em-vis-1.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="source-30" class="section level3">
<h3>Source</h3>
<p>Original code available at
<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20algorithm%20for%20probit%20example.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20algorithm%20for%20probit%20example.R</a></p>
</div>
</div>
<div id="pca" class="section level2">
<h2>PCA</h2>
<p>The following is an EM algorithm for principal components analysis. See Murphy,
2012 Probabilistic Machine Learning 12.2.5. Some of the constructed object is
based on output from <span class="func" style="">pca</span> function used below.</p>
<div id="data-setup-32" class="section level3">
<h3>Data Setup</h3>
<p><code>state.x77</code> is from base R, which includes various state demographics. We will first standardize the data.</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb530-1"><a href="em.html#cb530-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb530-2"><a href="em.html#cb530-2"></a></span>
<span id="cb530-3"><a href="em.html#cb530-3"></a>X =<span class="st"> </span><span class="kw">scale</span>(state.x77)</span></code></pre></div>
</div>
<div id="function-24" class="section level3">
<h3>Function</h3>
<div class="sourceCode" id="cb531"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb531-1"><a href="em.html#cb531-1"></a>em_pca =<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb531-2"><a href="em.html#cb531-2"></a>  X,</span>
<span id="cb531-3"><a href="em.html#cb531-3"></a>  <span class="dt">nComp =</span> <span class="dv">2</span>,</span>
<span id="cb531-4"><a href="em.html#cb531-4"></a>  <span class="dt">tol   =</span> <span class="fl">.00001</span>,</span>
<span id="cb531-5"><a href="em.html#cb531-5"></a>  <span class="dt">maxits  =</span> <span class="dv">100</span>,</span>
<span id="cb531-6"><a href="em.html#cb531-6"></a>  <span class="dt">showits =</span> <span class="ot">TRUE</span></span>
<span id="cb531-7"><a href="em.html#cb531-7"></a>  ) {</span>
<span id="cb531-8"><a href="em.html#cb531-8"></a>  </span>
<span id="cb531-9"><a href="em.html#cb531-9"></a>  <span class="co"># Arguments </span></span>
<span id="cb531-10"><a href="em.html#cb531-10"></a>  <span class="co"># X: numeric data</span></span>
<span id="cb531-11"><a href="em.html#cb531-11"></a>  <span class="co"># nComp: number of components</span></span>
<span id="cb531-12"><a href="em.html#cb531-12"></a>  <span class="co"># tol = tolerance level</span></span>
<span id="cb531-13"><a href="em.html#cb531-13"></a>  <span class="co"># maxits: maximum iterations</span></span>
<span id="cb531-14"><a href="em.html#cb531-14"></a>  <span class="co"># showits: show iterations</span></span>
<span id="cb531-15"><a href="em.html#cb531-15"></a>  </span>
<span id="cb531-16"><a href="em.html#cb531-16"></a>  </span>
<span id="cb531-17"><a href="em.html#cb531-17"></a>  <span class="co"># starting points and other initializations</span></span>
<span id="cb531-18"><a href="em.html#cb531-18"></a>  N  =<span class="st"> </span><span class="kw">nrow</span>(X)</span>
<span id="cb531-19"><a href="em.html#cb531-19"></a>  D  =<span class="st"> </span><span class="kw">ncol</span>(X)</span>
<span id="cb531-20"><a href="em.html#cb531-20"></a>  L  =<span class="st"> </span>nComp</span>
<span id="cb531-21"><a href="em.html#cb531-21"></a>  Xt =<span class="st"> </span><span class="kw">t</span>(X)</span>
<span id="cb531-22"><a href="em.html#cb531-22"></a>  Z  =<span class="st"> </span><span class="kw">t</span>(<span class="kw">replicate</span>(L, <span class="kw">rnorm</span>(N)))                          <span class="co"># latent variables</span></span>
<span id="cb531-23"><a href="em.html#cb531-23"></a>  W  =<span class="st"> </span><span class="kw">replicate</span>(L, <span class="kw">rnorm</span>(D))                             <span class="co"># loadings</span></span>
<span id="cb531-24"><a href="em.html#cb531-24"></a>  it =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb531-25"><a href="em.html#cb531-25"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb531-26"><a href="em.html#cb531-26"></a>    </span>
<span id="cb531-27"><a href="em.html#cb531-27"></a>  <span class="cf">if</span> (showits)                                                     </span>
<span id="cb531-28"><a href="em.html#cb531-28"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb531-29"><a href="em.html#cb531-29"></a>  </span>
<span id="cb531-30"><a href="em.html#cb531-30"></a>  <span class="co"># while no convergence and we haven&#39;t reached our max iterations do this stuff</span></span>
<span id="cb531-31"><a href="em.html#cb531-31"></a>  <span class="cf">while</span> ((<span class="op">!</span>converged) <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">&lt;</span><span class="st"> </span>maxits)) {                           </span>
<span id="cb531-32"><a href="em.html#cb531-32"></a>    Z_old =<span class="st"> </span>Z                                      <span class="co"># create &#39;old&#39; values for comparison</span></span>
<span id="cb531-33"><a href="em.html#cb531-33"></a>    Z =<span class="st"> </span><span class="kw">solve</span>(<span class="kw">t</span>(W)<span class="op">%*%</span>W) <span class="op">%*%</span><span class="st"> </span><span class="kw">crossprod</span>(W, Xt)       <span class="co"># E</span></span>
<span id="cb531-34"><a href="em.html#cb531-34"></a>    W =<span class="st"> </span>Xt<span class="op">%*%</span><span class="kw">t</span>(Z) <span class="op">%*%</span><span class="st"> </span><span class="kw">solve</span>(<span class="kw">tcrossprod</span>(Z))         <span class="co"># M</span></span>
<span id="cb531-35"><a href="em.html#cb531-35"></a></span>
<span id="cb531-36"><a href="em.html#cb531-36"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb531-37"><a href="em.html#cb531-37"></a>    </span>
<span id="cb531-38"><a href="em.html#cb531-38"></a>    <span class="co"># if showits, show first and every 5th iteration</span></span>
<span id="cb531-39"><a href="em.html#cb531-39"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))           </span>
<span id="cb531-40"><a href="em.html#cb531-40"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb531-41"><a href="em.html#cb531-41"></a>    </span>
<span id="cb531-42"><a href="em.html#cb531-42"></a>    converged =<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(Z_old<span class="op">-</span>Z)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb531-43"><a href="em.html#cb531-43"></a>  }</span>
<span id="cb531-44"><a href="em.html#cb531-44"></a>  </span>
<span id="cb531-45"><a href="em.html#cb531-45"></a>  <span class="co"># calculate reconstruction error</span></span>
<span id="cb531-46"><a href="em.html#cb531-46"></a>  Xrecon   =<span class="st"> </span>W <span class="op">%*%</span><span class="st"> </span>Z</span>
<span id="cb531-47"><a href="em.html#cb531-47"></a>  reconerr =<span class="st"> </span><span class="kw">sum</span>((Xrecon <span class="op">-</span><span class="st"> </span><span class="kw">t</span>(X))<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb531-48"><a href="em.html#cb531-48"></a>  </span>
<span id="cb531-49"><a href="em.html#cb531-49"></a>  <span class="co"># orthogonalize</span></span>
<span id="cb531-50"><a href="em.html#cb531-50"></a>  W     =<span class="st"> </span>pracma<span class="op">::</span><span class="kw">orth</span>(W)     <span class="co"># for orthonormal basis of W; pcaMethods package has also</span></span>
<span id="cb531-51"><a href="em.html#cb531-51"></a>  evs   =<span class="st"> </span><span class="kw">eigen</span>(<span class="kw">cov</span>(X <span class="op">%*%</span><span class="st"> </span>W))</span>
<span id="cb531-52"><a href="em.html#cb531-52"></a>  evals =<span class="st"> </span>evs<span class="op">$</span>values</span>
<span id="cb531-53"><a href="em.html#cb531-53"></a>  evecs =<span class="st"> </span>evs<span class="op">$</span>vectors</span>
<span id="cb531-54"><a href="em.html#cb531-54"></a>  </span>
<span id="cb531-55"><a href="em.html#cb531-55"></a>  W =<span class="st"> </span>W <span class="op">%*%</span><span class="st"> </span>evecs</span>
<span id="cb531-56"><a href="em.html#cb531-56"></a>  Z =<span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>W</span>
<span id="cb531-57"><a href="em.html#cb531-57"></a></span>
<span id="cb531-58"><a href="em.html#cb531-58"></a>  <span class="cf">if</span> (showits)                                     <span class="co"># Show last iteration</span></span>
<span id="cb531-59"><a href="em.html#cb531-59"></a>    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb531-60"><a href="em.html#cb531-60"></a>  </span>
<span id="cb531-61"><a href="em.html#cb531-61"></a>  <span class="kw">list</span>(</span>
<span id="cb531-62"><a href="em.html#cb531-62"></a>    <span class="dt">scores   =</span> Z,</span>
<span id="cb531-63"><a href="em.html#cb531-63"></a>    <span class="dt">loadings =</span> W,</span>
<span id="cb531-64"><a href="em.html#cb531-64"></a>    <span class="dt">reconerr =</span> reconerr,</span>
<span id="cb531-65"><a href="em.html#cb531-65"></a>    <span class="dt">Xrecon   =</span> <span class="kw">t</span>(Xrecon)</span>
<span id="cb531-66"><a href="em.html#cb531-66"></a>  )</span>
<span id="cb531-67"><a href="em.html#cb531-67"></a>}</span></code></pre></div>
</div>
<div id="estimation-28" class="section level3">
<h3>Estimation</h3>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb532-1"><a href="em.html#cb532-1"></a>results_pca =<span class="st"> </span><span class="kw">em_pca</span>(</span>
<span id="cb532-2"><a href="em.html#cb532-2"></a>  <span class="dt">X =</span> X,</span>
<span id="cb532-3"><a href="em.html#cb532-3"></a>  <span class="dt">nComp =</span> <span class="dv">2</span>,</span>
<span id="cb532-4"><a href="em.html#cb532-4"></a>  <span class="dt">tol =</span> <span class="fl">1e-12</span>,</span>
<span id="cb532-5"><a href="em.html#cb532-5"></a>  <span class="dt">maxit =</span> <span class="dv">1000</span></span>
<span id="cb532-6"><a href="em.html#cb532-6"></a>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
5...
10...
15...
20...
25...
30...
35...
40...
45...
50...
55...
60...
65...
70...
70...</code></pre>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb534-1"><a href="em.html#cb534-1"></a>results_pca</span></code></pre></div>
<pre><code>$scores
                      [,1]        [,2]
Alabama        -3.78988728  0.23477897
Alaska          1.05313550 -5.45617512
Arizona        -0.86742876 -0.74506148
Arkansas       -2.38177761  1.28834366
California     -0.24138147 -3.50952277
Colorado        2.06218136 -0.50566387
Connecticut     1.89943583  0.24300645
Delaware        0.42478394  0.50791950
Florida        -1.17212341 -1.13474136
Georgia        -3.29417162 -0.10995684
Hawaii          0.48704129 -0.12526216
Idaho           1.42342916  0.61114319
Illinois       -0.11896424 -1.28238783
Indiana         0.47120189  0.24520088
Iowa            2.32181208  0.53685609
Kansas          1.90151483  0.07719072
Kentucky       -2.12935981  1.06425233
Louisiana      -4.24100842  0.34630079
Maine           0.96019374  1.70241922
Maryland        0.20342599 -0.38881112
Massachusetts   1.19589376  0.21865625
Michigan       -0.18186944 -0.84711636
Minnesota       2.43361605  0.36533543
Mississippi    -4.03208863  1.05124066
Missouri       -0.31125449  0.14830589
Montana         1.37887297  0.03353877
Nebraska        2.18101665  0.54774825
Nevada          1.12708455 -1.13291366
New Hampshire   1.67128925  1.31239813
New Jersey      0.64958222 -0.28146986
New Mexico     -1.32244692  0.29357041
New York       -1.05034998 -1.89371072
North Carolina -2.69433377  0.51713890
North Dakota    2.41766786  0.78192203
Ohio            0.26795708 -0.41685336
Oklahoma       -0.07391320  0.64658337
Oregon          1.32472856 -0.22767511
Pennsylvania   -0.07738173 -0.26940938
Rhode Island    0.74084731  1.46130325
South Carolina -3.71100631  0.90984427
South Dakota    2.01253414  1.31509491
Tennessee      -2.21813394  0.65102504
Texas          -2.41364282 -2.32744119
Utah            2.26283736  0.53433138
Vermont         1.36926611  1.50938322
Virginia       -0.99354796 -0.18457034
Washington      1.34001299 -0.51154448
West Virginia  -1.50662213  1.60198375
Wisconsin       1.75754046  0.63572738
Wyoming         1.48379101 -0.04225606

$loadings
            [,1]        [,2]
[1,] -0.12642809 -0.41087417
[2,]  0.29882991 -0.51897884
[3,] -0.46766917 -0.05296872
[4,]  0.41161037  0.08165611
[5,] -0.44425672 -0.30694934
[6,]  0.42468442 -0.29876662
[7,]  0.35741244  0.15358409
[8,]  0.03338461 -0.58762446

$reconerr
[1] 135.6901

$Xrecon
                Population      Income   Illiteracy    Life Exp       Murder     HS Grad       Frost        Area
Alabama         0.38268358 -1.25437699  1.759977489 -1.54078578  1.611617628 -1.67965020 -1.31849456 -0.26448579
Alaska          2.10865553  3.14634780 -0.203512400 -0.01204852  1.206906839  2.07737324 -0.46157798  3.24134051
Arizona         0.41579388  0.12745748  0.445134639 -0.41788150  0.614057185 -0.14578398 -0.42445943  0.40885758
Arkansas       -0.22822355 -1.38036948  1.045642041 -0.87516325  0.662664464 -1.39641793 -0.65340786 -0.83657698
California      1.47248966  1.74923604  0.298781592 -0.38592908  1.184481039  0.94601731 -0.62527962  2.05422301
Colorado       -0.05295342  0.87867032 -0.937634273  0.80752470 -0.760924727  1.02685178  0.65938735  0.36598559
Connecticut    -0.33998711  0.44149303 -0.901179312  0.80167045 -0.918427793  0.73405859  0.71620393 -0.07938460
Delaware       -0.26239562 -0.13666132 -0.225562197  0.21632020 -0.344618674  0.02864973  0.22983142 -0.28428468
Florida         0.61442524  0.23864122  0.608271775 -0.57511671  0.869031809 -0.15875971 -0.59320972  0.62767090
Georgia         0.46165424 -0.92733174  1.546406772 -1.36489386  1.497209045 -1.36613193 -1.19426555 -0.04536132
Hawaii         -0.01010871  0.21055091 -0.221139217  0.19024283 -0.177922225  0.24426300  0.15483634  0.08986680
Idaho          -0.43106438  0.10819283 -0.698065403  0.63580178 -0.819957964  0.42191900  0.60261317 -0.31160205
Illinois        0.54194046  0.62998207  0.123562347 -0.15368171  0.446478763  0.33261242 -0.23947367  0.74959089
Indiana        -0.16031986  0.01355515 -0.233354573  0.21397374 -0.284598854  0.12685427  0.20607238 -0.12835514
Iowa           -0.51412256  0.41520995 -1.114276503  0.99951952 -1.196268234  0.82564274  0.91229709 -0.23795697
Kansas         -0.27212055  0.52816916 -0.893368551  0.78898632 -0.868454375  0.78448171  0.69148033  0.01812218
Kentucky       -0.16806291 -1.18864084  0.939463847 -0.78956388  0.619310844 -1.22226901 -0.59760746 -0.69646856
Louisiana       0.39389653 -1.44706295  1.965045766 -1.71736548  1.777799672 -1.90455332 -1.46260289 -0.34507925
Maine          -0.82087554 -0.59658494 -0.539227972  0.53423863 -0.949128976 -0.10084671  0.60464971 -0.96832748
Maryland        0.13403369  0.26257452 -0.074541237  0.05198345  0.028971956  0.20255563  0.01299178  0.23526623
Massachusetts  -0.24103476  0.24389086 -0.570864580  0.51009689 -0.598400225  0.44255026  0.46100943 -0.08856331
Michigan        0.37105164  0.38528744  0.129925395 -0.14403157  0.340818527  0.17585298 -0.19510600  0.49171466
Minnesota      -0.45778431  0.53763591 -1.157478542  1.03153348 -1.193289744  0.92436879  0.92591437 -0.13343470
Mississippi     0.07784161 -1.75048034  1.830000664 -1.57380929  1.468604826 -2.02644084 -1.27966480 -0.75234446
Missouri       -0.02158375 -0.16997977  0.137708556 -0.11600550  0.092754503 -0.17649378 -0.08846880 -0.09753928
Montana        -0.18810848  0.39464258 -0.646632879  0.57029706 -0.622868279  0.57556560  0.49797738  0.02632494
Nebraska       -0.50079737  0.36748326 -1.049007763  0.94245607 -1.137062259  0.76259490  0.86364791 -0.24905787
Nevada          0.32298982  0.92476479 -0.467093711  0.37141038 -0.152967781  0.81713204  0.22883653  0.70335507
New Hampshire  -0.75052840 -0.18167564 -0.851126498  0.79508531 -1.145321214  0.31766975  0.79890305 -0.71540190
New Jersey      0.03352326  0.34019150 -0.288880479  0.24439105 -0.202184277  0.35996125  0.18893948  0.18708463
New Mexico      0.04657394 -0.54754352  0.602917601 -0.52036105  0.497394682 -0.64933164 -0.42757124 -0.21665853
New York        0.91087056  0.66891979  0.591523732 -0.58696799  1.047898292  0.11971028 -0.66625200  1.07772522
North Carolina  0.12816045 -1.07353166  1.232664646 -1.06678818  1.038240427 -1.29874542 -0.88356411 -0.39383276
North Dakota   -0.62693269  0.31667048 -1.172086124  1.05898588 -1.314075638  0.79313367  0.98419537 -0.37876361
Ohio            0.13739698  0.29641166 -0.103235078  0.07625529  0.008911129  0.23833907  0.03174915  0.25389887
Oklahoma       -0.25631970 -0.35765056  0.000318234  0.02237404 -0.165631902 -0.22456731  0.07288742 -0.38241577
Oregon         -0.07393708  0.51402708 -0.607475042  0.52668095 -0.518634834  0.63061330  0.43850719  0.17801302
Pennsylvania    0.12047658  0.11669379  0.050459318 -0.05385004  0.117072383  0.04762771 -0.06903419  0.15572818
Rhode Island   -0.69407567 -0.53699812 -0.423874803  0.42426477 -0.777672460 -0.12196232  0.48922098 -0.83396464
South Carolina  0.09534391 -1.58114961  1.687329949 -1.45319435  1.369363378 -1.84783766 -1.18662222 -0.65853727
South Dakota   -0.79477937 -0.08110103 -1.010859058  0.93576546 -1.297749324  0.46178543  0.92128241 -0.70559427
Tennessee       0.01294506 -1.00071299  1.002868892 -0.85984677  0.785589193 -1.13651148 -0.69280158 -0.45660979
Texas           1.26143772  0.48662406  1.252067903 -1.18353020  1.786683571 -0.32967476 -1.22012392  1.28708285
Utah           -0.50562916  0.39889681 -1.086562111  0.97503875 -1.169293358  0.80135139  0.89083103 -0.23844224
Vermont        -0.79328027 -0.37416028 -0.720313637  0.68685449 -1.071609849  0.13055266  0.72121000 -0.84123808
Virginia        0.20144755 -0.20111375  0.474428203 -0.42402594  0.498044099 -0.36680088 -0.38345347  0.07528883
Washington      0.04076514  0.66591672 -0.599586905  0.50979252 -0.438291530  0.72191506  0.40037222  0.34533187
West Virginia  -0.46773439 -1.28161942  0.619745694 -0.48932954  0.177599146 -1.11845822 -0.29244627 -0.99166284
Wisconsin      -0.48340644  0.19527660 -0.855621146  0.77533290 -0.975935252  0.55646593  0.72580444 -0.31489415
Wyoming        -0.17023094  0.46533114 -0.691685058  0.60729331 -0.646213653  0.64276763  0.52383551  0.07436648</code></pre>
</div>
<div id="comparison-35" class="section level3">
<h3>Comparison</h3>
<p>Extract reconstructed values and loadings for comparison.</p>
<div class="sourceCode" id="cb536"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb536-1"><a href="em.html#cb536-1"></a>Xrecon      =<span class="st"> </span>results_pca<span class="op">$</span>Xrecon</span>
<span id="cb536-2"><a href="em.html#cb536-2"></a>loadings_em =<span class="st"> </span>results_pca<span class="op">$</span>loadings</span>
<span id="cb536-3"><a href="em.html#cb536-3"></a>scores_em   =<span class="st"> </span>results_pca<span class="op">$</span>scores</span></code></pre></div>
<p>Compare results to output from <span class="pack" style="">pcaMethods</span>, which also has probabilistic PCA (demonstrated next). Note that the signs for loadings/scores may be different</p>
<div class="sourceCode" id="cb537"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb537-1"><a href="em.html#cb537-1"></a><span class="kw">library</span>(pcaMethods)  <span class="co"># install via BiocManager::install(&quot;pcaMethods&quot;)</span></span>
<span id="cb537-2"><a href="em.html#cb537-2"></a></span>
<span id="cb537-3"><a href="em.html#cb537-3"></a>result_pcam =<span class="st"> </span><span class="kw">pca</span>(</span>
<span id="cb537-4"><a href="em.html#cb537-4"></a>  X,</span>
<span id="cb537-5"><a href="em.html#cb537-5"></a>  <span class="dt">nPcs =</span> <span class="dv">2</span>,</span>
<span id="cb537-6"><a href="em.html#cb537-6"></a>  <span class="dt">method =</span> <span class="st">&#39;svd&#39;</span>,</span>
<span id="cb537-7"><a href="em.html#cb537-7"></a>  <span class="dt">scale  =</span> <span class="st">&#39;none&#39;</span>,</span>
<span id="cb537-8"><a href="em.html#cb537-8"></a>  <span class="dt">center =</span> <span class="ot">FALSE</span></span>
<span id="cb537-9"><a href="em.html#cb537-9"></a>)</span>
<span id="cb537-10"><a href="em.html#cb537-10"></a></span>
<span id="cb537-11"><a href="em.html#cb537-11"></a>loadings_pcam =<span class="st"> </span><span class="kw">loadings</span>(result_pcam)</span>
<span id="cb537-12"><a href="em.html#cb537-12"></a>scores_pcam   =<span class="st"> </span><span class="kw">scores</span>(result_pcam)</span></code></pre></div>
<p>Compare loadings and scores.</p>
<div class="sourceCode" id="cb538"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb538-1"><a href="em.html#cb538-1"></a><span class="kw">sum</span>((<span class="kw">abs</span>(loadings_pcam) <span class="op">-</span><span class="st"> </span><span class="kw">abs</span>(loadings_em))<span class="op">^</span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] 1.520589e-24</code></pre>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb540-1"><a href="em.html#cb540-1"></a><span class="kw">abs</span>(<span class="kw">round</span>(<span class="kw">cbind</span>(scores_pcam, scores_em), <span class="dv">2</span>))</span></code></pre></div>
<pre><code>                PC1  PC2          
Alabama        3.79 0.23 3.79 0.23
Alaska         1.05 5.46 1.05 5.46
Arizona        0.87 0.75 0.87 0.75
Arkansas       2.38 1.29 2.38 1.29
California     0.24 3.51 0.24 3.51
Colorado       2.06 0.51 2.06 0.51
Connecticut    1.90 0.24 1.90 0.24
Delaware       0.42 0.51 0.42 0.51
Florida        1.17 1.13 1.17 1.13
Georgia        3.29 0.11 3.29 0.11
Hawaii         0.49 0.13 0.49 0.13
Idaho          1.42 0.61 1.42 0.61
Illinois       0.12 1.28 0.12 1.28
Indiana        0.47 0.25 0.47 0.25
Iowa           2.32 0.54 2.32 0.54
Kansas         1.90 0.08 1.90 0.08
Kentucky       2.13 1.06 2.13 1.06
Louisiana      4.24 0.35 4.24 0.35
Maine          0.96 1.70 0.96 1.70
Maryland       0.20 0.39 0.20 0.39
Massachusetts  1.20 0.22 1.20 0.22
Michigan       0.18 0.85 0.18 0.85
Minnesota      2.43 0.37 2.43 0.37
Mississippi    4.03 1.05 4.03 1.05
Missouri       0.31 0.15 0.31 0.15
Montana        1.38 0.03 1.38 0.03
Nebraska       2.18 0.55 2.18 0.55
Nevada         1.13 1.13 1.13 1.13
New Hampshire  1.67 1.31 1.67 1.31
New Jersey     0.65 0.28 0.65 0.28
New Mexico     1.32 0.29 1.32 0.29
New York       1.05 1.89 1.05 1.89
North Carolina 2.69 0.52 2.69 0.52
North Dakota   2.42 0.78 2.42 0.78
Ohio           0.27 0.42 0.27 0.42
Oklahoma       0.07 0.65 0.07 0.65
Oregon         1.32 0.23 1.32 0.23
Pennsylvania   0.08 0.27 0.08 0.27
Rhode Island   0.74 1.46 0.74 1.46
South Carolina 3.71 0.91 3.71 0.91
South Dakota   2.01 1.32 2.01 1.32
Tennessee      2.22 0.65 2.22 0.65
Texas          2.41 2.33 2.41 2.33
Utah           2.26 0.53 2.26 0.53
Vermont        1.37 1.51 1.37 1.51
Virginia       0.99 0.18 0.99 0.18
Washington     1.34 0.51 1.34 0.51
West Virginia  1.51 1.60 1.51 1.60
Wisconsin      1.76 0.64 1.76 0.64
Wyoming        1.48 0.04 1.48 0.04</code></pre>
<p>Calculate mean squared reconstruction error and compare.</p>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="em.html#cb542-1"></a>Xrecon_pcam =<span class="st"> </span>scores_pcam <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(loadings_pcam)</span>
<span id="cb542-2"><a href="em.html#cb542-2"></a></span>
<span id="cb542-3"><a href="em.html#cb542-3"></a><span class="kw">mean</span>((Xrecon <span class="op">-</span><span class="st"> </span>X)<span class="op">^</span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] 0.3392252</code></pre>
<div class="sourceCode" id="cb544"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb544-1"><a href="em.html#cb544-1"></a><span class="kw">mean</span>((Xrecon_pcam <span class="op">-</span><span class="st"> </span>X)<span class="op">^</span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] 0.3392252</code></pre>
<div class="sourceCode" id="cb546"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb546-1"><a href="em.html#cb546-1"></a><span class="kw">mean</span>(<span class="kw">abs</span>(Xrecon_pcam <span class="op">-</span><span class="st"> </span>Xrecon))</span></code></pre></div>
<pre><code>[1] 5.120166e-13</code></pre>
</div>
<div id="visualize-2" class="section level3">
<h3>Visualize</h3>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb548-1"><a href="em.html#cb548-1"></a><span class="kw">qplot</span>(Xrecon_pcam[,<span class="dv">1</span>], X[,<span class="dv">1</span>])</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-pca-vis-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb549"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb549-1"><a href="em.html#cb549-1"></a><span class="kw">qplot</span>(Xrecon_pcam[,<span class="dv">2</span>], X[,<span class="dv">2</span>])</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-pca-vis-2.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb550-1"><a href="em.html#cb550-1"></a><span class="kw">qplot</span>(Xrecon[,<span class="dv">1</span>], Xrecon_pcam[,<span class="dv">1</span>])</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-pca-vis-3.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="source-31" class="section level3">
<h3>Source</h3>
<p>Original code available at
<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20for%20pca.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20for%20pca.R</a></p>
</div>
</div>
<div id="probabilistic-pca" class="section level2">
<h2>Probabilistic PCA</h2>
<p>The following is an EM algorithm for probabilistic principal components
analysis. Based on Tipping and Bishop, 1999, and also Murphy 2012 Probabilistic
ML, with some code snippets inspired by the <span class="func" style="">ppca</span> function used below. See also ModelFitting/EM Examples/EM for pca.R</p>
<div id="data-setup-33" class="section level3">
<h3>Data Setup</h3>
<p><code>state.x77</code> is from base R, which includes various state demographics. We will first standardize the data.</p>
<div class="sourceCode" id="cb551"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb551-1"><a href="em.html#cb551-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb551-2"><a href="em.html#cb551-2"></a></span>
<span id="cb551-3"><a href="em.html#cb551-3"></a>X =<span class="st"> </span><span class="kw">scale</span>(state.x77)</span></code></pre></div>
</div>
<div id="function-25" class="section level3">
<h3>Function</h3>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb552-1"><a href="em.html#cb552-1"></a>em_ppca =<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb552-2"><a href="em.html#cb552-2"></a>  X,</span>
<span id="cb552-3"><a href="em.html#cb552-3"></a>  <span class="dt">nComp =</span> <span class="dv">2</span>,</span>
<span id="cb552-4"><a href="em.html#cb552-4"></a>  <span class="dt">tol   =</span> <span class="fl">.00001</span>,</span>
<span id="cb552-5"><a href="em.html#cb552-5"></a>  <span class="dt">maxits  =</span> <span class="dv">100</span>,</span>
<span id="cb552-6"><a href="em.html#cb552-6"></a>  <span class="dt">showits =</span> <span class="ot">TRUE</span></span>
<span id="cb552-7"><a href="em.html#cb552-7"></a>) {</span>
<span id="cb552-8"><a href="em.html#cb552-8"></a>  </span>
<span id="cb552-9"><a href="em.html#cb552-9"></a>  <span class="co"># Arguments </span></span>
<span id="cb552-10"><a href="em.html#cb552-10"></a>  <span class="co"># X: numeric data</span></span>
<span id="cb552-11"><a href="em.html#cb552-11"></a>  <span class="co"># nComp: number of components</span></span>
<span id="cb552-12"><a href="em.html#cb552-12"></a>  <span class="co"># tol = tolerance level</span></span>
<span id="cb552-13"><a href="em.html#cb552-13"></a>  <span class="co"># maxits: maximum iterations</span></span>
<span id="cb552-14"><a href="em.html#cb552-14"></a>  <span class="co"># showits: show iterations</span></span>
<span id="cb552-15"><a href="em.html#cb552-15"></a>  </span>
<span id="cb552-16"><a href="em.html#cb552-16"></a>  <span class="co"># require(pracma) </span></span>
<span id="cb552-17"><a href="em.html#cb552-17"></a></span>
<span id="cb552-18"><a href="em.html#cb552-18"></a>  tr =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="kw">diag</span>(x), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb552-19"><a href="em.html#cb552-19"></a>  </span>
<span id="cb552-20"><a href="em.html#cb552-20"></a>  </span>
<span id="cb552-21"><a href="em.html#cb552-21"></a>  <span class="co"># starting points and other initializations</span></span>
<span id="cb552-22"><a href="em.html#cb552-22"></a>  N =<span class="st"> </span><span class="kw">nrow</span>(X)</span>
<span id="cb552-23"><a href="em.html#cb552-23"></a>  D =<span class="st"> </span><span class="kw">ncol</span>(X)</span>
<span id="cb552-24"><a href="em.html#cb552-24"></a>  L =<span class="st"> </span>nComp</span>
<span id="cb552-25"><a href="em.html#cb552-25"></a></span>
<span id="cb552-26"><a href="em.html#cb552-26"></a>  S =<span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>N) <span class="op">*</span><span class="st"> </span><span class="kw">t</span>(X)<span class="op">%*%</span>X</span>
<span id="cb552-27"><a href="em.html#cb552-27"></a>  </span>
<span id="cb552-28"><a href="em.html#cb552-28"></a>  evals =<span class="st"> </span><span class="kw">eigen</span>(S)<span class="op">$</span>values</span>
<span id="cb552-29"><a href="em.html#cb552-29"></a>  evecs =<span class="st"> </span><span class="kw">eigen</span>(S)<span class="op">$</span>vectors</span>
<span id="cb552-30"><a href="em.html#cb552-30"></a></span>
<span id="cb552-31"><a href="em.html#cb552-31"></a>  V =<span class="st"> </span>evecs[,<span class="dv">1</span><span class="op">:</span>L]</span>
<span id="cb552-32"><a href="em.html#cb552-32"></a>  Lambda =<span class="st"> </span><span class="kw">diag</span>(evals[<span class="dv">1</span><span class="op">:</span>L])</span>
<span id="cb552-33"><a href="em.html#cb552-33"></a>  </span>
<span id="cb552-34"><a href="em.html#cb552-34"></a>  <span class="co"># latent variables</span></span>
<span id="cb552-35"><a href="em.html#cb552-35"></a>  Z =<span class="st"> </span><span class="kw">t</span>(<span class="kw">replicate</span>(L, <span class="kw">rnorm</span>(N))) </span>
<span id="cb552-36"><a href="em.html#cb552-36"></a>  </span>
<span id="cb552-37"><a href="em.html#cb552-37"></a>  <span class="co"># variance; average variance associated with discarded dimensions</span></span>
<span id="cb552-38"><a href="em.html#cb552-38"></a>  sigma2 =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(D <span class="op">-</span><span class="st"> </span>L) <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(evals[(L<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>D])</span>
<span id="cb552-39"><a href="em.html#cb552-39"></a>  </span>
<span id="cb552-40"><a href="em.html#cb552-40"></a>  <span class="co"># loadings; this and sigma2 starting points will be near final estimate</span></span>
<span id="cb552-41"><a href="em.html#cb552-41"></a>  W =<span class="st"> </span>V <span class="op">%*%</span><span class="st"> </span><span class="kw">chol</span>(Lambda <span class="op">-</span><span class="st"> </span>sigma2 <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(L)) <span class="op">%*%</span><span class="st"> </span><span class="kw">diag</span>(L)  </span>
<span id="cb552-42"><a href="em.html#cb552-42"></a></span>
<span id="cb552-43"><a href="em.html#cb552-43"></a>  it =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb552-44"><a href="em.html#cb552-44"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb552-45"><a href="em.html#cb552-45"></a>  ll =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb552-46"><a href="em.html#cb552-46"></a>  </span>
<span id="cb552-47"><a href="em.html#cb552-47"></a>  <span class="co"># Show iterations</span></span>
<span id="cb552-48"><a href="em.html#cb552-48"></a>  <span class="cf">if</span> (showits)                                                    </span>
<span id="cb552-49"><a href="em.html#cb552-49"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb552-50"><a href="em.html#cb552-50"></a>  </span>
<span id="cb552-51"><a href="em.html#cb552-51"></a>  <span class="cf">while</span> ((<span class="op">!</span>converged) <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">&lt;</span><span class="st"> </span>maxits)) {                           </span>
<span id="cb552-52"><a href="em.html#cb552-52"></a>    <span class="co"># create &#39;old&#39; values for comparison</span></span>
<span id="cb552-53"><a href="em.html#cb552-53"></a>    <span class="cf">if</span>(<span class="kw">exists</span>(<span class="st">&#39;W_new&#39;</span>)){</span>
<span id="cb552-54"><a href="em.html#cb552-54"></a>      W_old =<span class="st"> </span>W_new</span>
<span id="cb552-55"><a href="em.html#cb552-55"></a>    }</span>
<span id="cb552-56"><a href="em.html#cb552-56"></a>    <span class="cf">else</span> {</span>
<span id="cb552-57"><a href="em.html#cb552-57"></a>      W_old =<span class="st"> </span>W</span>
<span id="cb552-58"><a href="em.html#cb552-58"></a>    }</span>
<span id="cb552-59"><a href="em.html#cb552-59"></a>    </span>
<span id="cb552-60"><a href="em.html#cb552-60"></a>    ll_old =<span class="st"> </span>ll</span>
<span id="cb552-61"><a href="em.html#cb552-61"></a>    </span>
<span id="cb552-62"><a href="em.html#cb552-62"></a>    Psi =<span class="st"> </span>sigma2<span class="op">*</span><span class="kw">diag</span>(L)</span>
<span id="cb552-63"><a href="em.html#cb552-63"></a>    M   =<span class="st"> </span><span class="kw">t</span>(W_old) <span class="op">%*%</span><span class="st"> </span>W_old <span class="op">+</span><span class="st"> </span>Psi</span>
<span id="cb552-64"><a href="em.html#cb552-64"></a>    </span>
<span id="cb552-65"><a href="em.html#cb552-65"></a>    <span class="co"># E and M </span></span>
<span id="cb552-66"><a href="em.html#cb552-66"></a>    W_new  =<span class="st"> </span>S <span class="op">%*%</span><span class="st"> </span>W_old <span class="op">%*%</span><span class="st"> </span><span class="kw">solve</span>( Psi <span class="op">+</span><span class="st"> </span><span class="kw">solve</span>(M) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(W_old) <span class="op">%*%</span><span class="st"> </span>S <span class="op">%*%</span><span class="st"> </span>W_old )   </span>
<span id="cb552-67"><a href="em.html#cb552-67"></a>    sigma2 =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>D <span class="op">*</span><span class="st"> </span><span class="kw">tr</span>(S <span class="op">-</span><span class="st"> </span>S <span class="op">%*%</span><span class="st"> </span>W_old <span class="op">%*%</span><span class="st"> </span><span class="kw">solve</span>(M) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(W_new))</span>
<span id="cb552-68"><a href="em.html#cb552-68"></a></span>
<span id="cb552-69"><a href="em.html#cb552-69"></a>    Z  =<span class="st"> </span><span class="kw">solve</span>(M) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(W_new) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(X)</span>
<span id="cb552-70"><a href="em.html#cb552-70"></a>    ZZ =<span class="st"> </span>sigma2<span class="op">*</span><span class="kw">solve</span>(M) <span class="op">+</span><span class="st"> </span>Z<span class="op">%*%</span><span class="kw">t</span>(Z)</span>
<span id="cb552-71"><a href="em.html#cb552-71"></a>    </span>
<span id="cb552-72"><a href="em.html#cb552-72"></a>    <span class="co"># log likelihood as in paper</span></span>
<span id="cb552-73"><a href="em.html#cb552-73"></a>    <span class="co"># ll = .5*sigma2*D + .5*tr(ZZ) + .5*sigma2 * X%*%t(X) -</span></span>
<span id="cb552-74"><a href="em.html#cb552-74"></a>    <span class="co">#      1/sigma2 * t(Z)%*%t(W_new)%*%t(X) + .5*sigma2 * tr(t(W_new)%*%W_new%*%ZZ)</span></span>
<span id="cb552-75"><a href="em.html#cb552-75"></a>    <span class="co"># ll = -sum(ll)</span></span>
<span id="cb552-76"><a href="em.html#cb552-76"></a>    </span>
<span id="cb552-77"><a href="em.html#cb552-77"></a>    <span class="co"># more straightforward</span></span>
<span id="cb552-78"><a href="em.html#cb552-78"></a>    ll =<span class="st"> </span><span class="kw">dnorm</span>(X, <span class="dt">mean =</span> <span class="kw">t</span>(W_new <span class="op">%*%</span><span class="st"> </span>Z), <span class="dt">sd =</span> <span class="kw">sqrt</span>(sigma2), <span class="dt">log =</span> <span class="ot">TRUE</span>)</span>
<span id="cb552-79"><a href="em.html#cb552-79"></a>    ll =<span class="st"> </span><span class="op">-</span><span class="kw">sum</span>(ll)</span>
<span id="cb552-80"><a href="em.html#cb552-80"></a></span>
<span id="cb552-81"><a href="em.html#cb552-81"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb552-82"><a href="em.html#cb552-82"></a>    </span>
<span id="cb552-83"><a href="em.html#cb552-83"></a>    <span class="co"># if showits, show first and every 5th iteration</span></span>
<span id="cb552-84"><a href="em.html#cb552-84"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))                          </span>
<span id="cb552-85"><a href="em.html#cb552-85"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb552-86"><a href="em.html#cb552-86"></a>    </span>
<span id="cb552-87"><a href="em.html#cb552-87"></a>    converged =<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(ll_old<span class="op">-</span>ll)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb552-88"><a href="em.html#cb552-88"></a>  }</span>
<span id="cb552-89"><a href="em.html#cb552-89"></a>  </span>
<span id="cb552-90"><a href="em.html#cb552-90"></a>  W     =<span class="st"> </span>pracma<span class="op">::</span><span class="kw">orth</span>(W_new) <span class="co"># for orthonormal basis of W; pcaMethods package has also</span></span>
<span id="cb552-91"><a href="em.html#cb552-91"></a>  evs   =<span class="st"> </span><span class="kw">eigen</span>(<span class="kw">cov</span>(X <span class="op">%*%</span><span class="st"> </span>W))</span>
<span id="cb552-92"><a href="em.html#cb552-92"></a>  evecs =<span class="st"> </span>evs<span class="op">$</span>vectors</span>
<span id="cb552-93"><a href="em.html#cb552-93"></a>  </span>
<span id="cb552-94"><a href="em.html#cb552-94"></a>  W =<span class="st"> </span>W <span class="op">%*%</span><span class="st"> </span>evecs</span>
<span id="cb552-95"><a href="em.html#cb552-95"></a>  Z =<span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>W</span>
<span id="cb552-96"><a href="em.html#cb552-96"></a>  Xrecon   =<span class="st"> </span>Z <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(W)</span>
<span id="cb552-97"><a href="em.html#cb552-97"></a>  reconerr =<span class="st"> </span><span class="kw">sum</span>((Xrecon <span class="op">-</span><span class="st"> </span>X)<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb552-98"><a href="em.html#cb552-98"></a>  </span>
<span id="cb552-99"><a href="em.html#cb552-99"></a>  <span class="cf">if</span> (showits)                                                     <span class="co"># Show last iteration</span></span>
<span id="cb552-100"><a href="em.html#cb552-100"></a>    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb552-101"><a href="em.html#cb552-101"></a>  </span>
<span id="cb552-102"><a href="em.html#cb552-102"></a>  <span class="kw">list</span>(</span>
<span id="cb552-103"><a href="em.html#cb552-103"></a>    <span class="dt">scores   =</span> Z,</span>
<span id="cb552-104"><a href="em.html#cb552-104"></a>    <span class="dt">loadings =</span> W,</span>
<span id="cb552-105"><a href="em.html#cb552-105"></a>    <span class="dt">Xrecon   =</span> Xrecon,</span>
<span id="cb552-106"><a href="em.html#cb552-106"></a>    <span class="dt">reconerr =</span> reconerr,</span>
<span id="cb552-107"><a href="em.html#cb552-107"></a>    <span class="dt">ll       =</span> ll,</span>
<span id="cb552-108"><a href="em.html#cb552-108"></a>    <span class="dt">sigma2   =</span> sigma2</span>
<span id="cb552-109"><a href="em.html#cb552-109"></a>  )</span>
<span id="cb552-110"><a href="em.html#cb552-110"></a>}</span></code></pre></div>
</div>
<div id="estimation-29" class="section level3">
<h3>Estimation</h3>
<div class="sourceCode" id="cb553"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb553-1"><a href="em.html#cb553-1"></a>results_ppca =<span class="st"> </span><span class="kw">em_ppca</span>(</span>
<span id="cb553-2"><a href="em.html#cb553-2"></a>  <span class="dt">X =</span> X,</span>
<span id="cb553-3"><a href="em.html#cb553-3"></a>  <span class="dt">nComp =</span> <span class="dv">2</span>,</span>
<span id="cb553-4"><a href="em.html#cb553-4"></a>  <span class="dt">tol =</span> <span class="fl">1e-12</span>,</span>
<span id="cb553-5"><a href="em.html#cb553-5"></a>  <span class="dt">maxit =</span> <span class="dv">100</span></span>
<span id="cb553-6"><a href="em.html#cb553-6"></a>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
2...</code></pre>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb555-1"><a href="em.html#cb555-1"></a><span class="kw">str</span>(results_ppca)</span></code></pre></div>
<pre><code>List of 6
 $ scores  : num [1:50, 1:2] 3.79 -1.053 0.867 2.382 0.241 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. ..$ : chr [1:50] &quot;Alabama&quot; &quot;Alaska&quot; &quot;Arizona&quot; &quot;Arkansas&quot; ...
  .. ..$ : NULL
 $ loadings: num [1:8, 1:2] 0.126 -0.299 0.468 -0.412 0.444 ...
 $ Xrecon  : num [1:50, 1:8] 0.383 2.109 0.416 -0.228 1.472 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. ..$ : chr [1:50] &quot;Alabama&quot; &quot;Alaska&quot; &quot;Arizona&quot; &quot;Arkansas&quot; ...
  .. ..$ : NULL
 $ reconerr: num 136
 $ ll      : num 369
 $ sigma2  : num 0.452</code></pre>
</div>
<div id="comparison-36" class="section level3">
<h3>Comparison</h3>
<p>Extract reconstructed values and loadings for comparison.</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb557-1"><a href="em.html#cb557-1"></a>Xrecon      =<span class="st"> </span>results_ppca<span class="op">$</span>Xrecon</span>
<span id="cb557-2"><a href="em.html#cb557-2"></a>loadings_em =<span class="st"> </span>results_ppca<span class="op">$</span>loadings</span>
<span id="cb557-3"><a href="em.html#cb557-3"></a>scores_em   =<span class="st"> </span>results_ppca<span class="op">$</span>scores</span></code></pre></div>
<p>Compare to standard pca on full data set if desired.</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb558-1"><a href="em.html#cb558-1"></a>standard_pca =<span class="st">  </span><span class="kw">princomp</span>(<span class="kw">scale</span>(state.x77))</span>
<span id="cb558-2"><a href="em.html#cb558-2"></a></span>
<span id="cb558-3"><a href="em.html#cb558-3"></a>scores_standard_pca   =<span class="st"> </span>standard_pca<span class="op">$</span>scores[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</span>
<span id="cb558-4"><a href="em.html#cb558-4"></a>loadings_standard_pca =<span class="st"> </span>standard_pca<span class="op">$</span>loadings[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</span>
<span id="cb558-5"><a href="em.html#cb558-5"></a>Xrecon_standard_pca   =<span class="st"> </span>scores_standard_pca<span class="op">%*%</span><span class="kw">t</span>(loadings_standard_pca)</span></code></pre></div>
<p>Compare results to output from <span class="pack" style="">pcaMethods</span>, which also has probabilistic PCA (demonstrated next). Note that the signs for loadings/scores may be different</p>
<div class="sourceCode" id="cb559"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb559-1"><a href="em.html#cb559-1"></a><span class="kw">library</span>(pcaMethods)</span>
<span id="cb559-2"><a href="em.html#cb559-2"></a></span>
<span id="cb559-3"><a href="em.html#cb559-3"></a>results_pcam  =<span class="st"> </span><span class="kw">pca</span>(</span>
<span id="cb559-4"><a href="em.html#cb559-4"></a>  X,</span>
<span id="cb559-5"><a href="em.html#cb559-5"></a>  <span class="dt">nPcs =</span> <span class="dv">2</span>,</span>
<span id="cb559-6"><a href="em.html#cb559-6"></a>  <span class="dt">threshold =</span> <span class="fl">1e-8</span>,</span>
<span id="cb559-7"><a href="em.html#cb559-7"></a>  <span class="dt">method =</span> <span class="st">&#39;ppca&#39;</span>,</span>
<span id="cb559-8"><a href="em.html#cb559-8"></a>  <span class="dt">scale  =</span> <span class="st">&#39;none&#39;</span>,</span>
<span id="cb559-9"><a href="em.html#cb559-9"></a>  <span class="dt">center =</span> <span class="ot">FALSE</span></span>
<span id="cb559-10"><a href="em.html#cb559-10"></a>)</span>
<span id="cb559-11"><a href="em.html#cb559-11"></a></span>
<span id="cb559-12"><a href="em.html#cb559-12"></a>loadings_pcam =<span class="st"> </span><span class="kw">loadings</span>(results_pcam)</span>
<span id="cb559-13"><a href="em.html#cb559-13"></a>scores_pcam   =<span class="st"> </span><span class="kw">scores</span>(results_pcam)</span></code></pre></div>
<p>Compare loadings and scores.</p>
<div class="sourceCode" id="cb560"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb560-1"><a href="em.html#cb560-1"></a><span class="kw">round</span>(<span class="kw">cbind</span>(loadings_pcam, loadings_em, loadings_standard_pca), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>              PC1    PC2               Comp.1 Comp.2
Population  0.126  0.411  0.126  0.411  0.126  0.411
Income     -0.299  0.519 -0.299  0.519 -0.299  0.519
Illiteracy  0.468  0.053  0.468  0.053  0.468  0.053
Life Exp   -0.412 -0.082 -0.412 -0.082 -0.412 -0.082
Murder      0.444  0.307  0.444  0.307  0.444  0.307
HS Grad    -0.425  0.299 -0.425  0.299 -0.425  0.299
Frost      -0.357 -0.154 -0.357 -0.154 -0.357 -0.154
Area       -0.033  0.588 -0.033  0.588 -0.033  0.588</code></pre>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb562-1"><a href="em.html#cb562-1"></a><span class="kw">sum</span>((<span class="kw">abs</span>(loadings_pcam) <span class="op">-</span><span class="st"> </span><span class="kw">abs</span>(loadings_em)) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] 3.572549e-16</code></pre>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb564-1"><a href="em.html#cb564-1"></a><span class="kw">round</span>(<span class="kw">cbind</span>(<span class="kw">abs</span>(scores_pcam), <span class="kw">abs</span>(scores_em)), <span class="dv">2</span>)</span></code></pre></div>
<pre><code>                PC1  PC2          
Alabama        3.79 0.23 3.79 0.23
Alaska         1.05 5.46 1.05 5.46
Arizona        0.87 0.75 0.87 0.75
Arkansas       2.38 1.29 2.38 1.29
California     0.24 3.51 0.24 3.51
Colorado       2.06 0.51 2.06 0.51
Connecticut    1.90 0.24 1.90 0.24
Delaware       0.42 0.51 0.42 0.51
Florida        1.17 1.13 1.17 1.13
Georgia        3.29 0.11 3.29 0.11
Hawaii         0.49 0.13 0.49 0.13
Idaho          1.42 0.61 1.42 0.61
Illinois       0.12 1.28 0.12 1.28
Indiana        0.47 0.25 0.47 0.25
Iowa           2.32 0.54 2.32 0.54
Kansas         1.90 0.08 1.90 0.08
Kentucky       2.13 1.06 2.13 1.06
Louisiana      4.24 0.35 4.24 0.35
Maine          0.96 1.70 0.96 1.70
Maryland       0.20 0.39 0.20 0.39
Massachusetts  1.20 0.22 1.20 0.22
Michigan       0.18 0.85 0.18 0.85
Minnesota      2.43 0.37 2.43 0.37
Mississippi    4.03 1.05 4.03 1.05
Missouri       0.31 0.15 0.31 0.15
Montana        1.38 0.03 1.38 0.03
Nebraska       2.18 0.55 2.18 0.55
Nevada         1.13 1.13 1.13 1.13
New Hampshire  1.67 1.31 1.67 1.31
New Jersey     0.65 0.28 0.65 0.28
New Mexico     1.32 0.29 1.32 0.29
New York       1.05 1.89 1.05 1.89
North Carolina 2.69 0.52 2.69 0.52
North Dakota   2.42 0.78 2.42 0.78
Ohio           0.27 0.42 0.27 0.42
Oklahoma       0.07 0.65 0.07 0.65
Oregon         1.32 0.23 1.32 0.23
Pennsylvania   0.08 0.27 0.08 0.27
Rhode Island   0.74 1.46 0.74 1.46
South Carolina 3.71 0.91 3.71 0.91
South Dakota   2.01 1.32 2.01 1.32
Tennessee      2.22 0.65 2.22 0.65
Texas          2.41 2.33 2.41 2.33
Utah           2.26 0.53 2.26 0.53
Vermont        1.37 1.51 1.37 1.51
Virginia       0.99 0.18 0.99 0.18
Washington     1.34 0.51 1.34 0.51
West Virginia  1.51 1.60 1.51 1.60
Wisconsin      1.76 0.64 1.76 0.64
Wyoming        1.48 0.04 1.48 0.04</code></pre>
<p>Compare reconstructed data sets.</p>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb566-1"><a href="em.html#cb566-1"></a>Xrecon_pcam =<span class="st"> </span>scores_pcam <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(loadings_pcam)</span>
<span id="cb566-2"><a href="em.html#cb566-2"></a></span>
<span id="cb566-3"><a href="em.html#cb566-3"></a><span class="kw">mean</span>((Xrecon_pcam <span class="op">-</span><span class="st"> </span>X)<span class="op">^</span><span class="dv">2</span>)  </span></code></pre></div>
<pre><code>[1] 0.3392252</code></pre>
<div class="sourceCode" id="cb568"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb568-1"><a href="em.html#cb568-1"></a><span class="kw">mean</span>(<span class="kw">abs</span>(Xrecon_pcam <span class="op">-</span><span class="st"> </span>Xrecon))</span></code></pre></div>
<pre><code>[1] 6.414878e-09</code></pre>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb570-1"><a href="em.html#cb570-1"></a><span class="kw">mean</span>(<span class="kw">abs</span>(Xrecon_pcam <span class="op">-</span><span class="st"> </span>Xrecon))</span></code></pre></div>
<pre><code>[1] 6.414878e-09</code></pre>
</div>
<div id="visualize-3" class="section level3">
<h3>Visualize</h3>
<div class="sourceCode" id="cb572"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb572-1"><a href="em.html#cb572-1"></a>GGally<span class="op">::</span><span class="kw">ggpairs</span>(<span class="kw">data.frame</span>(</span>
<span id="cb572-2"><a href="em.html#cb572-2"></a>  <span class="dt">data    =</span> X[, <span class="dv">1</span>],</span>
<span id="cb572-3"><a href="em.html#cb572-3"></a>  <span class="dt">custom  =</span> Xrecon[, <span class="dv">1</span>],</span>
<span id="cb572-4"><a href="em.html#cb572-4"></a>  <span class="dt">pcaMeth =</span> Xrecon_pcam[, <span class="dv">1</span>]</span>
<span id="cb572-5"><a href="em.html#cb572-5"></a>))</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-vis-recon-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb573"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb573-1"><a href="em.html#cb573-1"></a>GGally<span class="op">::</span><span class="kw">ggpairs</span>(<span class="kw">data.frame</span>(</span>
<span id="cb573-2"><a href="em.html#cb573-2"></a>  <span class="dt">data    =</span> X[, <span class="dv">2</span>],</span>
<span id="cb573-3"><a href="em.html#cb573-3"></a>  <span class="dt">custom  =</span> Xrecon[, <span class="dv">2</span>],</span>
<span id="cb573-4"><a href="em.html#cb573-4"></a>  <span class="dt">pcaMeth =</span> Xrecon_pcam[, <span class="dv">2</span>]</span>
<span id="cb573-5"><a href="em.html#cb573-5"></a>))</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-vis-recon-2.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb574"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb574-1"><a href="em.html#cb574-1"></a><span class="kw">qplot</span>(Xrecon[, <span class="dv">1</span>], Xrecon_pcam[, <span class="dv">1</span>])</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-vis-scores-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb575-1"><a href="em.html#cb575-1"></a>GGally<span class="op">::</span><span class="kw">ggpairs</span>(<span class="kw">data.frame</span>(scores_em, scores_pcam) )</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-vis-scores-2.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="missing-data-example" class="section level3">
<h3>Missing Data Example</h3>
<p>A slightly revised approach can be taken in the case of missing value.</p>
<div id="data-setup-34" class="section level4">
<h4>Data Setup</h4>
<div class="sourceCode" id="cb576"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb576-1"><a href="em.html#cb576-1"></a><span class="co"># create some missing values</span></span>
<span id="cb576-2"><a href="em.html#cb576-2"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb576-3"><a href="em.html#cb576-3"></a></span>
<span id="cb576-4"><a href="em.html#cb576-4"></a>X_miss =<span class="st"> </span>X</span>
<span id="cb576-5"><a href="em.html#cb576-5"></a>NAindex =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">length</span>(X), <span class="dv">20</span>)</span>
<span id="cb576-6"><a href="em.html#cb576-6"></a>X_miss[NAindex] =<span class="st"> </span><span class="ot">NA</span></span></code></pre></div>
</div>
<div id="function-26" class="section level4">
<h4>Function</h4>
<div class="sourceCode" id="cb577"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb577-1"><a href="em.html#cb577-1"></a>em_ppca_miss =<span class="st"> </span><span class="cf">function</span>(X, <span class="dt">nComp=</span><span class="dv">2</span>, <span class="dt">tol=</span>.<span class="dv">00001</span>, <span class="dt">maxits=</span><span class="dv">100</span>, <span class="dt">showits=</span>T){</span>
<span id="cb577-2"><a href="em.html#cb577-2"></a>  <span class="co"># Arguments </span></span>
<span id="cb577-3"><a href="em.html#cb577-3"></a>  <span class="co"># X: numeric data</span></span>
<span id="cb577-4"><a href="em.html#cb577-4"></a>  <span class="co"># nComp: number of components</span></span>
<span id="cb577-5"><a href="em.html#cb577-5"></a>  <span class="co"># tol = tolerance level</span></span>
<span id="cb577-6"><a href="em.html#cb577-6"></a>  <span class="co"># maxits: maximum iterations</span></span>
<span id="cb577-7"><a href="em.html#cb577-7"></a>  <span class="co"># showits: show iterations</span></span>
<span id="cb577-8"><a href="em.html#cb577-8"></a>  <span class="co"># require(pracma) # for orthonormal basis of W; pcaMethods package has also</span></span>
<span id="cb577-9"><a href="em.html#cb577-9"></a>  </span>
<span id="cb577-10"><a href="em.html#cb577-10"></a>  tr =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="kw">diag</span>(x), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb577-11"><a href="em.html#cb577-11"></a>  </span>
<span id="cb577-12"><a href="em.html#cb577-12"></a>  <span class="co"># starting points and other initializations</span></span>
<span id="cb577-13"><a href="em.html#cb577-13"></a>  X_orig =<span class="st"> </span>X</span>
<span id="cb577-14"><a href="em.html#cb577-14"></a>  X =<span class="st"> </span>X</span>
<span id="cb577-15"><a href="em.html#cb577-15"></a>  N =<span class="st"> </span><span class="kw">nrow</span>(X_orig)</span>
<span id="cb577-16"><a href="em.html#cb577-16"></a>  D =<span class="st"> </span><span class="kw">ncol</span>(X_orig)</span>
<span id="cb577-17"><a href="em.html#cb577-17"></a>  L =<span class="st"> </span>nComp</span>
<span id="cb577-18"><a href="em.html#cb577-18"></a>  NAs =<span class="st"> </span><span class="kw">is.na</span>(X_orig)</span>
<span id="cb577-19"><a href="em.html#cb577-19"></a></span>
<span id="cb577-20"><a href="em.html#cb577-20"></a>  X[NAs] =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb577-21"><a href="em.html#cb577-21"></a>  S =<span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>N) <span class="op">*</span><span class="st"> </span><span class="kw">t</span>(X)<span class="op">%*%</span>X</span>
<span id="cb577-22"><a href="em.html#cb577-22"></a>  </span>
<span id="cb577-23"><a href="em.html#cb577-23"></a>  evals =<span class="st"> </span><span class="kw">eigen</span>(S)<span class="op">$</span>values</span>
<span id="cb577-24"><a href="em.html#cb577-24"></a>  evecs =<span class="st"> </span><span class="kw">eigen</span>(S)<span class="op">$</span>vectors</span>
<span id="cb577-25"><a href="em.html#cb577-25"></a></span>
<span id="cb577-26"><a href="em.html#cb577-26"></a>  V =<span class="st"> </span>evecs[,<span class="dv">1</span><span class="op">:</span>L]</span>
<span id="cb577-27"><a href="em.html#cb577-27"></a>  Lambda =<span class="st"> </span><span class="kw">diag</span>(evals[<span class="dv">1</span><span class="op">:</span>L])</span>
<span id="cb577-28"><a href="em.html#cb577-28"></a>  </span>
<span id="cb577-29"><a href="em.html#cb577-29"></a>  <span class="co"># latent variables</span></span>
<span id="cb577-30"><a href="em.html#cb577-30"></a>  Z =<span class="st"> </span><span class="kw">t</span>(<span class="kw">replicate</span>(L, <span class="kw">rnorm</span>(N))) </span>
<span id="cb577-31"><a href="em.html#cb577-31"></a>  </span>
<span id="cb577-32"><a href="em.html#cb577-32"></a>  <span class="co"># variance; average variance associated with discarded dimensions</span></span>
<span id="cb577-33"><a href="em.html#cb577-33"></a>  sigma2 =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(D<span class="op">-</span>L) <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(evals[(L<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>D])</span>
<span id="cb577-34"><a href="em.html#cb577-34"></a>  </span>
<span id="cb577-35"><a href="em.html#cb577-35"></a>  <span class="co"># loadings</span></span>
<span id="cb577-36"><a href="em.html#cb577-36"></a>  W =<span class="st"> </span>V <span class="op">%*%</span><span class="st"> </span><span class="kw">chol</span>(Lambda<span class="op">-</span>sigma2<span class="op">*</span><span class="kw">diag</span>(L)) <span class="op">%*%</span><span class="st"> </span><span class="kw">diag</span>(L)           </span>
<span id="cb577-37"><a href="em.html#cb577-37"></a></span>
<span id="cb577-38"><a href="em.html#cb577-38"></a>  it =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb577-39"><a href="em.html#cb577-39"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb577-40"><a href="em.html#cb577-40"></a>  ll =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb577-41"><a href="em.html#cb577-41"></a>  </span>
<span id="cb577-42"><a href="em.html#cb577-42"></a>   <span class="co"># Show iterations</span></span>
<span id="cb577-43"><a href="em.html#cb577-43"></a>  <span class="cf">if</span> (showits)</span>
<span id="cb577-44"><a href="em.html#cb577-44"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb577-45"><a href="em.html#cb577-45"></a>  </span>
<span id="cb577-46"><a href="em.html#cb577-46"></a>  <span class="cf">while</span> ((<span class="op">!</span>converged) <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">&lt;</span><span class="st"> </span>maxits)) {                  </span>
<span id="cb577-47"><a href="em.html#cb577-47"></a>    <span class="cf">if</span>(<span class="kw">exists</span>(<span class="st">&#39;W_new&#39;</span>)){</span>
<span id="cb577-48"><a href="em.html#cb577-48"></a>      W_old =<span class="st"> </span>W_new</span>
<span id="cb577-49"><a href="em.html#cb577-49"></a>    }</span>
<span id="cb577-50"><a href="em.html#cb577-50"></a>    <span class="cf">else</span> {</span>
<span id="cb577-51"><a href="em.html#cb577-51"></a>      W_old =<span class="st"> </span>W</span>
<span id="cb577-52"><a href="em.html#cb577-52"></a>    }</span>
<span id="cb577-53"><a href="em.html#cb577-53"></a>    </span>
<span id="cb577-54"><a href="em.html#cb577-54"></a>    ll_old =<span class="st"> </span>ll</span>
<span id="cb577-55"><a href="em.html#cb577-55"></a>    </span>
<span id="cb577-56"><a href="em.html#cb577-56"></a>    <span class="co"># deal with missingness via projection</span></span>
<span id="cb577-57"><a href="em.html#cb577-57"></a>    proj  =<span class="st"> </span><span class="kw">t</span>(W_old<span class="op">%*%</span>Z)</span>
<span id="cb577-58"><a href="em.html#cb577-58"></a>    X_new =<span class="st"> </span>X_orig</span>
<span id="cb577-59"><a href="em.html#cb577-59"></a>    X_new[NAs] =<span class="st"> </span>proj[NAs]</span>
<span id="cb577-60"><a href="em.html#cb577-60"></a>    X =<span class="st"> </span>X_new</span>
<span id="cb577-61"><a href="em.html#cb577-61"></a>    </span>
<span id="cb577-62"><a href="em.html#cb577-62"></a>    Psi =<span class="st"> </span>sigma2<span class="op">*</span><span class="kw">diag</span>(L)</span>
<span id="cb577-63"><a href="em.html#cb577-63"></a>    M   =<span class="st"> </span><span class="kw">t</span>(W_old) <span class="op">%*%</span><span class="st"> </span>W_old <span class="op">+</span><span class="st"> </span>Psi</span>
<span id="cb577-64"><a href="em.html#cb577-64"></a>    </span>
<span id="cb577-65"><a href="em.html#cb577-65"></a>    <span class="co"># E and M</span></span>
<span id="cb577-66"><a href="em.html#cb577-66"></a>    W_new  =<span class="st"> </span>S <span class="op">%*%</span><span class="st"> </span>W_old <span class="op">%*%</span><span class="st"> </span><span class="kw">solve</span>( Psi <span class="op">+</span><span class="st"> </span><span class="kw">solve</span>(M)<span class="op">%*%</span><span class="kw">t</span>(W_old)<span class="op">%*%</span>S<span class="op">%*%</span>W_old )</span>
<span id="cb577-67"><a href="em.html#cb577-67"></a>    sigma2 =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>D <span class="op">*</span><span class="st"> </span><span class="kw">tr</span>(S <span class="op">-</span><span class="st"> </span>S<span class="op">%*%</span>W_old<span class="op">%*%</span><span class="kw">solve</span>(M)<span class="op">%*%</span><span class="kw">t</span>(W_new))</span>
<span id="cb577-68"><a href="em.html#cb577-68"></a></span>
<span id="cb577-69"><a href="em.html#cb577-69"></a>    Z =<span class="st"> </span><span class="kw">solve</span>(M)<span class="op">%*%</span><span class="kw">t</span>(W_new)<span class="op">%*%</span><span class="kw">t</span>(X)</span>
<span id="cb577-70"><a href="em.html#cb577-70"></a>    </span>
<span id="cb577-71"><a href="em.html#cb577-71"></a>  </span>
<span id="cb577-72"><a href="em.html#cb577-72"></a>    <span class="co"># log likelihood as in paper</span></span>
<span id="cb577-73"><a href="em.html#cb577-73"></a>    <span class="co"># ZZ = sigma2*solve(M) + Z%*%t(Z)</span></span>
<span id="cb577-74"><a href="em.html#cb577-74"></a>    <span class="co"># ll = .5*sigma2*D + .5*tr(ZZ) + .5*sigma2 * X%*%t(X) -</span></span>
<span id="cb577-75"><a href="em.html#cb577-75"></a>    <span class="co">#      1/sigma2 * t(Z)%*%t(W_new)%*%t(X) + .5*sigma2 * tr(t(W_new)%*%W_new%*%ZZ)</span></span>
<span id="cb577-76"><a href="em.html#cb577-76"></a>    <span class="co"># ll = -sum(ll)</span></span>
<span id="cb577-77"><a href="em.html#cb577-77"></a>    </span>
<span id="cb577-78"><a href="em.html#cb577-78"></a>    <span class="co"># more straightforward</span></span>
<span id="cb577-79"><a href="em.html#cb577-79"></a>    ll =<span class="st"> </span><span class="kw">dnorm</span>(X, <span class="dt">mean =</span> <span class="kw">t</span>(W_new <span class="op">%*%</span><span class="st"> </span>Z), <span class="dt">sd =</span> <span class="kw">sqrt</span>(sigma2), <span class="dt">log =</span> <span class="ot">TRUE</span>)</span>
<span id="cb577-80"><a href="em.html#cb577-80"></a>    ll =<span class="st"> </span><span class="op">-</span><span class="kw">sum</span>(ll)</span>
<span id="cb577-81"><a href="em.html#cb577-81"></a></span>
<span id="cb577-82"><a href="em.html#cb577-82"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb577-83"><a href="em.html#cb577-83"></a>    </span>
<span id="cb577-84"><a href="em.html#cb577-84"></a>    <span class="co"># if showits, show first and every 5th iteration</span></span>
<span id="cb577-85"><a href="em.html#cb577-85"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))                          </span>
<span id="cb577-86"><a href="em.html#cb577-86"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb577-87"><a href="em.html#cb577-87"></a>    </span>
<span id="cb577-88"><a href="em.html#cb577-88"></a>    converged =<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(ll_old<span class="op">-</span>ll)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb577-89"><a href="em.html#cb577-89"></a>  }</span>
<span id="cb577-90"><a href="em.html#cb577-90"></a>  </span>
<span id="cb577-91"><a href="em.html#cb577-91"></a>  W     =<span class="st"> </span>pracma<span class="op">::</span><span class="kw">orth</span>(W_new)   <span class="co"># for orthonormal basis of W</span></span>
<span id="cb577-92"><a href="em.html#cb577-92"></a>  evs   =<span class="st"> </span><span class="kw">eigen</span>(<span class="kw">cov</span>(X <span class="op">%*%</span><span class="st"> </span>W))</span>
<span id="cb577-93"><a href="em.html#cb577-93"></a>  evecs =<span class="st"> </span>evs<span class="op">$</span>vectors</span>
<span id="cb577-94"><a href="em.html#cb577-94"></a>  </span>
<span id="cb577-95"><a href="em.html#cb577-95"></a>  W =<span class="st"> </span>W <span class="op">%*%</span><span class="st"> </span>evecs</span>
<span id="cb577-96"><a href="em.html#cb577-96"></a>  Z =<span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>W</span>
<span id="cb577-97"><a href="em.html#cb577-97"></a>  Xrecon   =<span class="st"> </span>Z <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(W)</span>
<span id="cb577-98"><a href="em.html#cb577-98"></a>  reconerr =<span class="st"> </span><span class="kw">sum</span>((Xrecon<span class="op">-</span>X)<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb577-99"><a href="em.html#cb577-99"></a>  </span>
<span id="cb577-100"><a href="em.html#cb577-100"></a>  <span class="cf">if</span> (showits)                                                     <span class="co"># Show last iteration</span></span>
<span id="cb577-101"><a href="em.html#cb577-101"></a>    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb577-102"><a href="em.html#cb577-102"></a>  </span>
<span id="cb577-103"><a href="em.html#cb577-103"></a>  <span class="kw">list</span>(</span>
<span id="cb577-104"><a href="em.html#cb577-104"></a>    <span class="dt">scores   =</span> Z,</span>
<span id="cb577-105"><a href="em.html#cb577-105"></a>    <span class="dt">loadings =</span> W,</span>
<span id="cb577-106"><a href="em.html#cb577-106"></a>    <span class="dt">Xrecon   =</span> Xrecon,</span>
<span id="cb577-107"><a href="em.html#cb577-107"></a>    <span class="dt">reconerr =</span> reconerr,</span>
<span id="cb577-108"><a href="em.html#cb577-108"></a>    <span class="dt">ll       =</span> ll,</span>
<span id="cb577-109"><a href="em.html#cb577-109"></a>    <span class="dt">sigma2   =</span> sigma2</span>
<span id="cb577-110"><a href="em.html#cb577-110"></a>  )</span>
<span id="cb577-111"><a href="em.html#cb577-111"></a>}</span></code></pre></div>
</div>
<div id="estimation-30" class="section level4">
<h4>Estimation</h4>
<p>Run the PCA.</p>
<div class="sourceCode" id="cb578"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb578-1"><a href="em.html#cb578-1"></a>results_ppca_miss =<span class="st"> </span><span class="kw">em_ppca_miss</span>(</span>
<span id="cb578-2"><a href="em.html#cb578-2"></a>  <span class="dt">X =</span> X_miss,</span>
<span id="cb578-3"><a href="em.html#cb578-3"></a>  <span class="dt">nComp =</span> <span class="dv">2</span>,</span>
<span id="cb578-4"><a href="em.html#cb578-4"></a>  <span class="dt">tol   =</span> <span class="fl">1e-8</span>,</span>
<span id="cb578-5"><a href="em.html#cb578-5"></a>  <span class="dt">maxit =</span> <span class="dv">100</span></span>
<span id="cb578-6"><a href="em.html#cb578-6"></a>)</span></code></pre></div>
<pre><code>Iterations of EM: 
1...
5...
10...
15...
19...</code></pre>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb580-1"><a href="em.html#cb580-1"></a><span class="kw">str</span>(results_ppca_miss)</span></code></pre></div>
<pre><code>List of 6
 $ scores  : num [1:50, 1:2] 3.79 -1.07 0.86 2.35 0.24 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. ..$ : chr [1:50] &quot;Alabama&quot; &quot;Alaska&quot; &quot;Arizona&quot; &quot;Arkansas&quot; ...
  .. ..$ : NULL
 $ loadings: num [1:8, 1:2] 0.133 -0.299 0.422 -0.431 0.464 ...
 $ Xrecon  : num [1:50, 1:8] 0.414 1.998 0.448 -0.2 1.521 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. ..$ : chr [1:50] &quot;Alabama&quot; &quot;Alaska&quot; &quot;Arizona&quot; &quot;Arkansas&quot; ...
  .. ..$ : NULL
 $ reconerr: num 130
 $ ll      : num 368
 $ sigma2  : num 0.475</code></pre>
</div>
<div id="comparison-37" class="section level4">
<h4>Comparison</h4>
<p>Extract reconstructed values and loadings for comparison.</p>
<div class="sourceCode" id="cb582"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb582-1"><a href="em.html#cb582-1"></a>Xrecon      =<span class="st"> </span>results_ppca_miss<span class="op">$</span>Xrecon</span>
<span id="cb582-2"><a href="em.html#cb582-2"></a>loadings_em =<span class="st"> </span>results_ppca_miss<span class="op">$</span>loadings</span>
<span id="cb582-3"><a href="em.html#cb582-3"></a>scores_em   =<span class="st"> </span>results_ppca_miss<span class="op">$</span>scores</span></code></pre></div>
<p>Compare to standard pca on full data set if desired.</p>
<div class="sourceCode" id="cb583"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb583-1"><a href="em.html#cb583-1"></a>standard_pca =<span class="st">  </span><span class="kw">princomp</span>(<span class="kw">scale</span>(state.x77))</span>
<span id="cb583-2"><a href="em.html#cb583-2"></a></span>
<span id="cb583-3"><a href="em.html#cb583-3"></a>scores_standard_pca   =<span class="st"> </span>standard_pca<span class="op">$</span>scores[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</span>
<span id="cb583-4"><a href="em.html#cb583-4"></a>loadings_standard_pca =<span class="st"> </span>standard_pca<span class="op">$</span>loadings[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</span>
<span id="cb583-5"><a href="em.html#cb583-5"></a>Xrecon_standard_pca   =<span class="st"> </span>scores_standard_pca<span class="op">%*%</span><span class="kw">t</span>(loadings_standard_pca)</span></code></pre></div>
<p>Compare results to output from <span class="pack" style="">pcaMethods</span>, which also has probabilistic PCA (demonstrated next). Note that the signs for loadings/scores may be different</p>
<div class="sourceCode" id="cb584"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb584-1"><a href="em.html#cb584-1"></a><span class="kw">library</span>(pcaMethods)</span>
<span id="cb584-2"><a href="em.html#cb584-2"></a></span>
<span id="cb584-3"><a href="em.html#cb584-3"></a>results_pcam  =<span class="st"> </span><span class="kw">pca</span>(</span>
<span id="cb584-4"><a href="em.html#cb584-4"></a>  X_miss,</span>
<span id="cb584-5"><a href="em.html#cb584-5"></a>  <span class="dt">nPcs =</span> <span class="dv">2</span>,</span>
<span id="cb584-6"><a href="em.html#cb584-6"></a>  <span class="dt">threshold =</span> <span class="fl">1e-8</span>,</span>
<span id="cb584-7"><a href="em.html#cb584-7"></a>  <span class="dt">method =</span> <span class="st">&#39;ppca&#39;</span>,</span>
<span id="cb584-8"><a href="em.html#cb584-8"></a>  <span class="dt">scale  =</span> <span class="st">&#39;none&#39;</span>,</span>
<span id="cb584-9"><a href="em.html#cb584-9"></a>  <span class="dt">center =</span> <span class="ot">FALSE</span></span>
<span id="cb584-10"><a href="em.html#cb584-10"></a>)</span>
<span id="cb584-11"><a href="em.html#cb584-11"></a></span>
<span id="cb584-12"><a href="em.html#cb584-12"></a>loadings_pcam =<span class="st"> </span><span class="kw">loadings</span>(results_pcam)</span>
<span id="cb584-13"><a href="em.html#cb584-13"></a>scores_pcam   =<span class="st"> </span><span class="kw">scores</span>(results_pcam)</span></code></pre></div>
<p>Compare loadings and scores.</p>
<div class="sourceCode" id="cb585"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb585-1"><a href="em.html#cb585-1"></a><span class="kw">round</span>(<span class="kw">cbind</span>(loadings_pcam, loadings_em, loadings_standard_pca), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>              PC1    PC2               Comp.1 Comp.2
Population -0.128 -0.416  0.133  0.396  0.126  0.411
Income      0.305 -0.492 -0.299  0.537 -0.299  0.519
Illiteracy -0.434 -0.046  0.422  0.076  0.468  0.053
Life Exp    0.432  0.077 -0.431 -0.080 -0.412 -0.082
Murder     -0.464 -0.284  0.464  0.290  0.444  0.307
HS Grad     0.424 -0.288 -0.433  0.318 -0.425  0.299
Frost       0.346  0.170 -0.353 -0.185 -0.357 -0.154
Area        0.041 -0.620 -0.037  0.569 -0.033  0.588</code></pre>
<div class="sourceCode" id="cb587"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb587-1"><a href="em.html#cb587-1"></a><span class="kw">sum</span>((<span class="kw">abs</span>(loadings_pcam) <span class="op">-</span><span class="st"> </span><span class="kw">abs</span>(loadings_em)) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] 0.00738241</code></pre>
<div class="sourceCode" id="cb589"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb589-1"><a href="em.html#cb589-1"></a><span class="kw">round</span>(<span class="kw">cbind</span>(<span class="kw">abs</span>(scores_pcam), <span class="kw">abs</span>(scores_em)), <span class="dv">2</span>)</span></code></pre></div>
<pre><code>                PC1  PC2          
Alabama        3.80 0.23 3.79 0.23
Alaska         1.08 5.49 1.07 5.41
Arizona        0.87 0.78 0.86 0.84
Arkansas       2.36 1.25 2.35 1.30
California     0.19 4.02 0.24 3.77
Colorado       1.47 0.40 1.47 0.41
Connecticut    1.94 0.29 1.94 0.19
Delaware       0.40 0.55 0.40 0.47
Florida        1.16 1.12 1.18 1.18
Georgia        3.31 0.10 3.31 0.10
Hawaii         0.60 0.10 0.61 0.29
Idaho          1.41 0.59 1.42 0.62
Illinois       0.16 1.23 0.18 1.24
Indiana        0.49 0.43 0.49 0.43
Iowa           2.33 0.53 2.33 0.53
Kansas         1.91 0.07 1.91 0.06
Kentucky       2.14 1.05 2.14 1.10
Louisiana      3.63 0.39 3.59 0.41
Maine          0.93 1.68 0.94 1.73
Maryland       0.18 0.32 0.16 0.41
Massachusetts  1.22 0.23 1.23 0.17
Michigan       0.22 0.81 0.24 0.80
Minnesota      2.45 0.35 2.45 0.38
Mississippi    4.05 1.30 4.03 1.24
Missouri       0.35 0.14 0.36 0.19
Montana        1.35 0.01 1.35 0.07
Nebraska       2.19 0.53 2.20 0.54
Nevada         0.47 1.32 0.46 1.39
New Hampshire  1.81 1.34 1.81 1.32
New Jersey     0.66 0.24 0.65 0.31
New Mexico     1.29 0.28 1.26 0.29
New York       1.06 1.86 1.08 1.87
North Carolina 2.71 0.51 2.71 0.55
North Dakota   2.45 0.79 2.45 0.79
Ohio           0.24 0.40 0.23 0.38
Oklahoma       0.06 0.61 0.06 0.64
Oregon         1.12 0.29 1.10 0.33
Pennsylvania   0.07 0.63 0.09 0.51
Rhode Island   0.78 1.46 0.79 1.43
South Carolina 3.71 0.90 3.69 0.88
South Dakota   2.22 0.94 2.20 1.02
Tennessee      2.22 0.64 2.22 0.67
Texas          2.35 2.41 2.37 2.30
Utah           2.41 0.60 2.42 0.62
Vermont        1.34 1.52 1.36 1.54
Virginia       1.00 0.16 1.01 0.19
Washington     1.28 0.54 1.26 0.61
West Virginia  1.59 1.54 1.58 1.59
Wisconsin      1.96 0.46 1.96 0.47
Wyoming        1.43 0.01 1.45 0.02</code></pre>
<p>Compare reconstructed data sets.</p>
<div class="sourceCode" id="cb591"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb591-1"><a href="em.html#cb591-1"></a>Xrecon_pcam =<span class="st"> </span>scores_pcam <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(loadings_pcam)</span>
<span id="cb591-2"><a href="em.html#cb591-2"></a></span>
<span id="cb591-3"><a href="em.html#cb591-3"></a><span class="kw">mean</span>((Xrecon_pcam <span class="op">-</span><span class="st"> </span>X_miss)<span class="op">^</span><span class="dv">2</span>)  </span></code></pre></div>
<pre><code>[1] NA</code></pre>
<div class="sourceCode" id="cb593"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb593-1"><a href="em.html#cb593-1"></a><span class="kw">mean</span>(<span class="kw">abs</span>(Xrecon_pcam <span class="op">-</span><span class="st"> </span>Xrecon))</span></code></pre></div>
<pre><code>[1] 0.02893291</code></pre>
<div class="sourceCode" id="cb595"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb595-1"><a href="em.html#cb595-1"></a><span class="kw">mean</span>(<span class="kw">abs</span>(Xrecon_pcam <span class="op">-</span><span class="st"> </span>Xrecon))</span></code></pre></div>
<pre><code>[1] 0.02893291</code></pre>
</div>
<div id="visualize-4" class="section level4">
<h4>Visualize</h4>
<div class="sourceCode" id="cb597"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb597-1"><a href="em.html#cb597-1"></a>GGally<span class="op">::</span><span class="kw">ggpairs</span>(<span class="kw">data.frame</span>(</span>
<span id="cb597-2"><a href="em.html#cb597-2"></a>  <span class="dt">data    =</span> X_miss[, <span class="dv">1</span>],</span>
<span id="cb597-3"><a href="em.html#cb597-3"></a>  <span class="dt">custom  =</span> Xrecon[, <span class="dv">1</span>],</span>
<span id="cb597-4"><a href="em.html#cb597-4"></a>  <span class="dt">pcaMeth =</span> Xrecon_pcam[, <span class="dv">1</span>]</span>
<span id="cb597-5"><a href="em.html#cb597-5"></a>))</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-miss-vis-recon-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb598"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb598-1"><a href="em.html#cb598-1"></a>GGally<span class="op">::</span><span class="kw">ggpairs</span>(<span class="kw">data.frame</span>(</span>
<span id="cb598-2"><a href="em.html#cb598-2"></a>  <span class="dt">data    =</span> X_miss[, <span class="dv">2</span>],</span>
<span id="cb598-3"><a href="em.html#cb598-3"></a>  <span class="dt">custom  =</span> Xrecon[, <span class="dv">2</span>],</span>
<span id="cb598-4"><a href="em.html#cb598-4"></a>  <span class="dt">pcaMeth =</span> Xrecon_pcam[, <span class="dv">2</span>]</span>
<span id="cb598-5"><a href="em.html#cb598-5"></a>))</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-miss-vis-recon-2.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb599"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb599-1"><a href="em.html#cb599-1"></a><span class="kw">qplot</span>(Xrecon[, <span class="dv">1</span>], Xrecon_pcam[, <span class="dv">1</span>])</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-miss-vis-scores-1.svg" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb600"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb600-1"><a href="em.html#cb600-1"></a>GGally<span class="op">::</span><span class="kw">ggpairs</span>(<span class="kw">data.frame</span>(scores_em, scores_pcam) )</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ppca-miss-vis-scores-2.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="source-32" class="section level3">
<h3>Source</h3>
<p>Original code available at
<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20algorithm%20for%20ppca.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20algorithm%20for%20ppca.R</a></p>
<p>Original code for the missing example found at
(<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20algorithm%20for%20ppca%20with%20missing.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20algorithm%20for%20ppca%20with%20missing.R</a></p>
</div>
</div>
<div id="state-space-model" class="section level2">
<h2>State Space Model</h2>
<p>The following regards chapter 11 in Statistical Modeling and Computation, the
first example for an unobserved components model. The data regards inflation
based on the U.S. consumer price index (infl = 400*log(cpi_t/cpi_{t-1})), from
the second quarter of 1947 to the second quarter of 2011. You can acquire the
data <a href="http://www.maths.uq.edu.au/~kroese/statbook/Statespace/USCPI.csv">here</a> or
in <a href="https://github.com/m-clark/Datasets">Datasets repo</a>. Just note that it has 2
mystery columns and one mystery row presumably supplied by Excel. You can also
get the CPI data yourself at the <a href="http://www.bls.gov/cpi/">Bureau of Labor
Statistics</a> in a frustrating fashion, or in a much
easier fashion <a href="https://fred.stlouisfed.org/series/CPIAUCSL">here</a>.</p>
<p>For the following I use <code>n</code> instead of <code>t</code> or <code>T</code> because those are transpose and <code>TRUE</code>
in R. The model is basically y = τ + ϵ, with ϵ ~ N(0, σ^2), and τ = τ_{n-1} +
υ_n with υ ~ N(0, ω^2). Thus each y is associated with a latent variable that
follows a random walk over time. ω^2 serves as a smoothing parameter, which
itself may be estimated but which is fixed in the following. See the text for
more details.</p>
<div id="data-setup-35" class="section level3">
<h3>Data Setup</h3>
<div class="sourceCode" id="cb601"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb601-1"><a href="em.html#cb601-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb601-2"><a href="em.html#cb601-2"></a></span>
<span id="cb601-3"><a href="em.html#cb601-3"></a>d =<span class="st"> </span><span class="kw">read_csv</span>(</span>
<span id="cb601-4"><a href="em.html#cb601-4"></a>  <span class="st">&#39;https://raw.githubusercontent.com/m-clark/Datasets/master/us%20cpi/USCPI.csv&#39;</span>,</span>
<span id="cb601-5"><a href="em.html#cb601-5"></a>  <span class="dt">col_names =</span> <span class="ot">FALSE</span></span>
<span id="cb601-6"><a href="em.html#cb601-6"></a>)</span>
<span id="cb601-7"><a href="em.html#cb601-7"></a></span>
<span id="cb601-8"><a href="em.html#cb601-8"></a>inflation =<span class="st"> </span><span class="kw">as.matrix</span>(d<span class="op">$</span>X1)</span>
<span id="cb601-9"><a href="em.html#cb601-9"></a></span>
<span id="cb601-10"><a href="em.html#cb601-10"></a><span class="kw">summary</span>(inflation)</span></code></pre></div>
<pre><code>       V1        
 Min.   :-9.557  
 1st Qu.: 1.843  
 Median : 3.248  
 Mean   : 3.634  
 3rd Qu.: 4.819  
 Max.   :15.931  </code></pre>
</div>
<div id="function-27" class="section level3">
<h3>Function</h3>
<p>EM function for a state space model.</p>
<div class="sourceCode" id="cb603"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb603-1"><a href="em.html#cb603-1"></a>em_state_space =<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb603-2"><a href="em.html#cb603-2"></a>  params,</span>
<span id="cb603-3"><a href="em.html#cb603-3"></a>  y,</span>
<span id="cb603-4"><a href="em.html#cb603-4"></a>  omega2_<span class="dv">0</span>,</span>
<span id="cb603-5"><a href="em.html#cb603-5"></a>  omega2,</span>
<span id="cb603-6"><a href="em.html#cb603-6"></a>  <span class="dt">tol     =</span> <span class="fl">.00001</span>,</span>
<span id="cb603-7"><a href="em.html#cb603-7"></a>  <span class="dt">maxits  =</span> <span class="dv">100</span>,</span>
<span id="cb603-8"><a href="em.html#cb603-8"></a>  <span class="dt">showits =</span> <span class="ot">FALSE</span></span>
<span id="cb603-9"><a href="em.html#cb603-9"></a>) {</span>
<span id="cb603-10"><a href="em.html#cb603-10"></a>  </span>
<span id="cb603-11"><a href="em.html#cb603-11"></a>  <span class="co"># Arguments are </span></span>
<span id="cb603-12"><a href="em.html#cb603-12"></a>  <span class="co"># params: starting parameters (variance as &#39;sigma2&#39;), </span></span>
<span id="cb603-13"><a href="em.html#cb603-13"></a>  <span class="co"># y: data, </span></span>
<span id="cb603-14"><a href="em.html#cb603-14"></a>  <span class="co"># tol: tolerance,</span></span>
<span id="cb603-15"><a href="em.html#cb603-15"></a>  <span class="co"># omega2: latent variance (2_0) is a noisier starting variance</span></span>
<span id="cb603-16"><a href="em.html#cb603-16"></a>  <span class="co"># maxits: maximum iterations</span></span>
<span id="cb603-17"><a href="em.html#cb603-17"></a>  <span class="co"># showits: whether to show iterations</span></span>
<span id="cb603-18"><a href="em.html#cb603-18"></a>  </span>
<span id="cb603-19"><a href="em.html#cb603-19"></a>  <span class="co"># Not really needed here, but would be a good idea generally to take advantage</span></span>
<span id="cb603-20"><a href="em.html#cb603-20"></a>  <span class="co"># of sparse representation for large data</span></span>
<span id="cb603-21"><a href="em.html#cb603-21"></a>  <span class="co"># require(spam)  # see usage below</span></span>
<span id="cb603-22"><a href="em.html#cb603-22"></a>  </span>
<span id="cb603-23"><a href="em.html#cb603-23"></a>  <span class="co"># Starting points</span></span>
<span id="cb603-24"><a href="em.html#cb603-24"></a>  n =<span class="st"> </span><span class="kw">length</span>(y)</span>
<span id="cb603-25"><a href="em.html#cb603-25"></a>  sigma2 =<span class="st"> </span>params<span class="op">$</span>sigma2</span>
<span id="cb603-26"><a href="em.html#cb603-26"></a>  </span>
<span id="cb603-27"><a href="em.html#cb603-27"></a>  <span class="co"># Other initializations</span></span>
<span id="cb603-28"><a href="em.html#cb603-28"></a>  H =<span class="st"> </span><span class="kw">diag</span>(n)</span>
<span id="cb603-29"><a href="em.html#cb603-29"></a>  </span>
<span id="cb603-30"><a href="em.html#cb603-30"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(<span class="kw">ncol</span>(H) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {</span>
<span id="cb603-31"><a href="em.html#cb603-31"></a>    H[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, i] =<span class="st"> </span><span class="dv">-1</span></span>
<span id="cb603-32"><a href="em.html#cb603-32"></a>  }</span>
<span id="cb603-33"><a href="em.html#cb603-33"></a>  </span>
<span id="cb603-34"><a href="em.html#cb603-34"></a>  Omega2 =<span class="st"> </span>spam<span class="op">::</span><span class="kw">as.spam</span>(<span class="kw">diag</span>(omega2, n))</span>
<span id="cb603-35"><a href="em.html#cb603-35"></a>  Omega2[<span class="dv">1</span>, <span class="dv">1</span>] =<span class="st"> </span>omega2_<span class="dv">0</span></span>
<span id="cb603-36"><a href="em.html#cb603-36"></a>  </span>
<span id="cb603-37"><a href="em.html#cb603-37"></a>  H =<span class="st"> </span>spam<span class="op">::</span><span class="kw">as.spam</span>(H)</span>
<span id="cb603-38"><a href="em.html#cb603-38"></a>  HinvOmega2H =<span class="st"> </span><span class="kw">t</span>(H) <span class="op">%*%</span><span class="st"> </span>spam<span class="op">::</span><span class="kw">chol2inv</span>(spam<span class="op">::</span><span class="kw">chol</span>(Omega2)) <span class="op">%*%</span><span class="st"> </span>H   <span class="co"># tau ~ N(0, HinvOmmega2H^-1)</span></span>
<span id="cb603-39"><a href="em.html#cb603-39"></a>  </span>
<span id="cb603-40"><a href="em.html#cb603-40"></a>  it =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb603-41"><a href="em.html#cb603-41"></a>  converged =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb603-42"><a href="em.html#cb603-42"></a>  </span>
<span id="cb603-43"><a href="em.html#cb603-43"></a>  <span class="cf">if</span> (showits)                                    <span class="co"># Show iterations</span></span>
<span id="cb603-44"><a href="em.html#cb603-44"></a>    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;Iterations of EM:&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb603-45"><a href="em.html#cb603-45"></a></span>
<span id="cb603-46"><a href="em.html#cb603-46"></a>  <span class="cf">while</span> ((<span class="op">!</span>converged) <span class="op">&amp;</span><span class="st"> </span>(it <span class="op">&lt;</span><span class="st"> </span>maxits)) { </span>
<span id="cb603-47"><a href="em.html#cb603-47"></a>    sigma2Old    =<span class="st"> </span>sigma2[<span class="dv">1</span>]</span>
<span id="cb603-48"><a href="em.html#cb603-48"></a>    Sigma2invOld =<span class="st"> </span><span class="kw">diag</span>(n)<span class="op">/</span>sigma2Old</span>
<span id="cb603-49"><a href="em.html#cb603-49"></a></span>
<span id="cb603-50"><a href="em.html#cb603-50"></a>    K   =<span class="st"> </span>HinvOmega2H <span class="op">+</span><span class="st"> </span>Sigma2invOld              <span class="co"># E</span></span>
<span id="cb603-51"><a href="em.html#cb603-51"></a>    tau =<span class="st"> </span><span class="kw">solve</span>(K, y<span class="op">/</span>sigma2Old)                   <span class="co"># tau|y, sigma2_{n-1}, omega2 ~ N(0, K^-1)</span></span>
<span id="cb603-52"><a href="em.html#cb603-52"></a>    K_inv_tr =<span class="st"> </span><span class="kw">sum</span>(<span class="dv">1</span><span class="op">/</span><span class="kw">eigen</span>(K)<span class="op">$</span>values)</span>
<span id="cb603-53"><a href="em.html#cb603-53"></a>    </span>
<span id="cb603-54"><a href="em.html#cb603-54"></a>    sigma2 =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>n <span class="op">*</span><span class="st"> </span>(K_inv_tr <span class="op">+</span><span class="st"> </span><span class="kw">crossprod</span>(y<span class="op">-</span>tau))  <span class="co"># M</span></span>
<span id="cb603-55"><a href="em.html#cb603-55"></a>    </span>
<span id="cb603-56"><a href="em.html#cb603-56"></a>    converged =<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(sigma2 <span class="op">-</span><span class="st"> </span>sigma2Old)) <span class="op">&lt;=</span><span class="st"> </span>tol</span>
<span id="cb603-57"><a href="em.html#cb603-57"></a>    </span>
<span id="cb603-58"><a href="em.html#cb603-58"></a>    it =<span class="st"> </span>it <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb603-59"><a href="em.html#cb603-59"></a>    </span>
<span id="cb603-60"><a href="em.html#cb603-60"></a>    <span class="co"># if showits true, &amp; it =1 or divisible by 5 print message</span></span>
<span id="cb603-61"><a href="em.html#cb603-61"></a>    <span class="cf">if</span> (showits <span class="op">&amp;</span><span class="st"> </span>it <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>it<span class="op">%%</span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)        </span>
<span id="cb603-62"><a href="em.html#cb603-62"></a>      <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="kw">format</span>(it), <span class="st">&quot;...&quot;</span>, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb603-63"><a href="em.html#cb603-63"></a>  }</span>
<span id="cb603-64"><a href="em.html#cb603-64"></a>  </span>
<span id="cb603-65"><a href="em.html#cb603-65"></a>  Kfinal   =<span class="st"> </span>HinvOmega2H <span class="op">+</span><span class="st"> </span><span class="kw">diag</span>(n) <span class="op">/</span><span class="st"> </span>sigma2[<span class="dv">1</span>]</span>
<span id="cb603-66"><a href="em.html#cb603-66"></a>  taufinal =<span class="st"> </span><span class="kw">solve</span>(K, (y <span class="op">/</span><span class="st"> </span>sigma2[<span class="dv">1</span>]))</span>
<span id="cb603-67"><a href="em.html#cb603-67"></a>  </span>
<span id="cb603-68"><a href="em.html#cb603-68"></a>  <span class="kw">list</span>(<span class="dt">sigma2 =</span> sigma2, <span class="dt">tau =</span> taufinal)</span>
<span id="cb603-69"><a href="em.html#cb603-69"></a>}</span></code></pre></div>
</div>
<div id="estimation-31" class="section level3">
<h3>Estimation</h3>
<div class="sourceCode" id="cb604"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb604-1"><a href="em.html#cb604-1"></a>ss_mod_<span class="dv">1</span> =<span class="st"> </span><span class="kw">em_state_space</span>(</span>
<span id="cb604-2"><a href="em.html#cb604-2"></a>  <span class="dt">params =</span> <span class="kw">data.frame</span>(<span class="dt">sigma2 =</span> <span class="kw">var</span>(inflation)),</span>
<span id="cb604-3"><a href="em.html#cb604-3"></a>  <span class="dt">y      =</span> inflation,</span>
<span id="cb604-4"><a href="em.html#cb604-4"></a>  <span class="dt">tol    =</span> <span class="fl">1e-10</span>,</span>
<span id="cb604-5"><a href="em.html#cb604-5"></a>  <span class="dt">omega2_0 =</span> <span class="dv">9</span>,</span>
<span id="cb604-6"><a href="em.html#cb604-6"></a>  <span class="dt">omega2   =</span> <span class="dv">1</span><span class="op">^</span><span class="dv">2</span></span>
<span id="cb604-7"><a href="em.html#cb604-7"></a>)</span></code></pre></div>
<pre><code>5...
10...
15...
20...
25...
30...</code></pre>
<div class="sourceCode" id="cb606"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb606-1"><a href="em.html#cb606-1"></a>ss_mod_.<span class="dv">5</span> =<span class="st"> </span><span class="kw">em_state_space</span>(</span>
<span id="cb606-2"><a href="em.html#cb606-2"></a>  <span class="dt">params =</span> <span class="kw">data.frame</span>(<span class="dt">sigma2 =</span> <span class="kw">var</span>(inflation)),</span>
<span id="cb606-3"><a href="em.html#cb606-3"></a>  <span class="dt">y      =</span> inflation,</span>
<span id="cb606-4"><a href="em.html#cb606-4"></a>  <span class="dt">tol    =</span> <span class="fl">1e-10</span>,</span>
<span id="cb606-5"><a href="em.html#cb606-5"></a>  <span class="dt">omega2_0 =</span> <span class="dv">9</span>,</span>
<span id="cb606-6"><a href="em.html#cb606-6"></a>  <span class="dt">omega2   =</span> <span class="fl">.5</span><span class="op">^</span><span class="dv">2</span></span>
<span id="cb606-7"><a href="em.html#cb606-7"></a>)</span></code></pre></div>
<pre><code>5...
10...
15...
20...</code></pre>
<div class="sourceCode" id="cb608"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb608-1"><a href="em.html#cb608-1"></a><span class="co"># more smooth</span></span>
<span id="cb608-2"><a href="em.html#cb608-2"></a>ss_mod_.<span class="dv">1</span> =<span class="st"> </span><span class="kw">em_state_space</span>(</span>
<span id="cb608-3"><a href="em.html#cb608-3"></a>  <span class="dt">params =</span> <span class="kw">data.frame</span>(<span class="dt">sigma2 =</span> <span class="kw">var</span>(inflation)),</span>
<span id="cb608-4"><a href="em.html#cb608-4"></a>  <span class="dt">y      =</span> inflation,</span>
<span id="cb608-5"><a href="em.html#cb608-5"></a>  <span class="dt">tol    =</span> <span class="fl">1e-10</span>,</span>
<span id="cb608-6"><a href="em.html#cb608-6"></a>  <span class="dt">omega2_0 =</span> <span class="dv">9</span>,</span>
<span id="cb608-7"><a href="em.html#cb608-7"></a>  <span class="dt">omega2   =</span> <span class="fl">.1</span><span class="op">^</span><span class="dv">2</span></span>
<span id="cb608-8"><a href="em.html#cb608-8"></a>)</span></code></pre></div>
<pre><code>5...
10...</code></pre>
<div class="sourceCode" id="cb610"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb610-1"><a href="em.html#cb610-1"></a>ss_mod_<span class="dv">1</span><span class="op">$</span>sigma2</span></code></pre></div>
<pre><code>         [,1]
[1,] 2.765182</code></pre>
<div class="sourceCode" id="cb612"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb612-1"><a href="em.html#cb612-1"></a>ss_mod_.<span class="dv">5</span><span class="op">$</span>sigma2</span></code></pre></div>
<pre><code>         [,1]
[1,] 4.404707</code></pre>
<div class="sourceCode" id="cb614"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb614-1"><a href="em.html#cb614-1"></a>ss_mod_.<span class="dv">1</span><span class="op">$</span>sigma2</span></code></pre></div>
<pre><code>         [,1]
[1,] 7.489429</code></pre>
</div>
<div id="visualization" class="section level3">
<h3>Visualization</h3>
<div class="sourceCode" id="cb616"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb616-1"><a href="em.html#cb616-1"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb616-2"><a href="em.html#cb616-2"></a></span>
<span id="cb616-3"><a href="em.html#cb616-3"></a>series =<span class="st"> </span><span class="kw">ymd</span>(</span>
<span id="cb616-4"><a href="em.html#cb616-4"></a>  <span class="kw">paste0</span>(</span>
<span id="cb616-5"><a href="em.html#cb616-5"></a>    <span class="kw">rep</span>(<span class="dv">1947</span><span class="op">:</span><span class="dv">2014</span>, <span class="dt">e =</span> <span class="dv">4</span>), </span>
<span id="cb616-6"><a href="em.html#cb616-6"></a>    <span class="st">&#39;-&#39;</span>, </span>
<span id="cb616-7"><a href="em.html#cb616-7"></a>    <span class="kw">c</span>(<span class="st">&#39;01&#39;</span>, <span class="st">&#39;04&#39;</span>, <span class="st">&#39;07&#39;</span>, <span class="st">&#39;10&#39;</span>), </span>
<span id="cb616-8"><a href="em.html#cb616-8"></a>    <span class="st">&#39;-&#39;</span>, </span>
<span id="cb616-9"><a href="em.html#cb616-9"></a>    <span class="st">&#39;01&#39;</span>)</span>
<span id="cb616-10"><a href="em.html#cb616-10"></a>  )</span></code></pre></div>
<p>The following corresponds to Fig. 11.1 in the text.</p>
<div class="sourceCode" id="cb617"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb617-1"><a href="em.html#cb617-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb617-2"><a href="em.html#cb617-2"></a></span>
<span id="cb617-3"><a href="em.html#cb617-3"></a><span class="kw">data.frame</span>(</span>
<span id="cb617-4"><a href="em.html#cb617-4"></a>  <span class="dt">series    =</span> series[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(inflation)],</span>
<span id="cb617-5"><a href="em.html#cb617-5"></a>  <span class="dt">inflation =</span> inflation,</span>
<span id="cb617-6"><a href="em.html#cb617-6"></a>  <span class="dt">Mod_1     =</span> ss_mod_<span class="dv">1</span><span class="op">$</span>tau,</span>
<span id="cb617-7"><a href="em.html#cb617-7"></a>  <span class="dt">Mod_.5    =</span> ss_mod_.<span class="dv">5</span><span class="op">$</span>tau,</span>
<span id="cb617-8"><a href="em.html#cb617-8"></a>  <span class="dt">Mod_.1     =</span> ss_mod_.<span class="dv">1</span><span class="op">$</span>tau</span>
<span id="cb617-9"><a href="em.html#cb617-9"></a>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb617-10"><a href="em.html#cb617-10"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> series, <span class="dt">y =</span> inflation)) <span class="op">+</span></span>
<span id="cb617-11"><a href="em.html#cb617-11"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&#39;gray50&#39;</span>) <span class="op">+</span></span>
<span id="cb617-12"><a href="em.html#cb617-12"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Mod_<span class="dv">1</span>),  <span class="dt">color =</span> <span class="st">&#39;#ff5500&#39;</span>) <span class="op">+</span></span>
<span id="cb617-13"><a href="em.html#cb617-13"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Mod_.<span class="dv">5</span>), <span class="dt">color =</span> <span class="st">&#39;skyblue3&#39;</span>) <span class="op">+</span></span>
<span id="cb617-14"><a href="em.html#cb617-14"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Mod_.<span class="dv">1</span>), <span class="dt">color =</span> <span class="st">&#39;#00aaff&#39;</span>) <span class="op">+</span></span>
<span id="cb617-15"><a href="em.html#cb617-15"></a><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(x),       <span class="co"># compare to generalized additive model (thicker line) </span></span>
<span id="cb617-16"><a href="em.html#cb617-16"></a>              <span class="dt">se =</span> <span class="ot">FALSE</span>,</span>
<span id="cb617-17"><a href="em.html#cb617-17"></a>              <span class="dt">method =</span> <span class="st">&#39;gam&#39;</span>) <span class="op">+</span></span>
<span id="cb617-18"><a href="em.html#cb617-18"></a><span class="st">  </span><span class="kw">scale_x_date</span>(<span class="dt">date_breaks =</span> <span class="st">&#39;10 years&#39;</span>) <span class="op">+</span></span>
<span id="cb617-19"><a href="em.html#cb617-19"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="model-demos_files/figure-html/em-ssm-vis-1.svg" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="source-33" class="section level3">
<h3>Source</h3>
<p>Original code found at
<a href="https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20for%20state%20space%20unobserved%20components.R" class="uri">https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/EM%20Examples/EM%20for%20state%20space%20unobserved%20components.R</a></p>

</div>
</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="stochastic-gradient-descent.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="supplemental.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["twitter", "facebook", "linkedin", "google", "weibo", "instapaper"],
"google": false,
"instapper": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/m-clark/models-by-example/blob/master/em.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"depth": 2,
"scroll_highlight": true
},
"df_print": "kable",
"highlight": "pygments",
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
